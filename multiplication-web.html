<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Multiplication Strategy Explorer</title>
    <style>
        :root {
            --primary-color: #1565c0;
            --known-bg: #e8f5e9;
            --known-border: #a5d6a7;
            --unknown-bg: #ffffff;
            --unknown-border: #e0e0e0;
            --selected-border: var(--primary-color);
            --light-gray: #f5f5f5;
            --dark-gray: #424242;
            --text-color: #212121;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--light-gray);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 1.5rem;
        }
        h2 { font-size: 1.75rem; color: var(--primary-color); margin-bottom: 0.5rem; text-align: center; }
        p.info { color: #616161; margin-bottom: 1.5rem; text-align: center; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(13, minmax(0, 1fr));
            gap: 4px;
            margin-bottom: 1.5rem;
        }
        .grid-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--dark-gray);
        }
        .grid-button {
            width: 100%;
            aspect-ratio: 1 / 1;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--unknown-border);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .grid-button.unknown {
            background-color: var(--unknown-bg);
            color: var(--primary-color);
        }
        .grid-button.unknown:hover { background-color: #f0f0f0; }
        .grid-button.known {
            background-color: var(--known-bg);
            border-color: var(--known-border);
            color: #2e7d32;
            font-weight: 600;
            cursor: not-allowed;
        }
        .grid-button.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
            background-color: #e3f2fd;
        }
        .flash {
            animation: flash-animation 1s;
        }
        @keyframes flash-animation {
            50% { background-color: #fffde7; border-color: #fdd835; }
        }
        
        #strategy-panel {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }
        #strategy-panel p { font-weight: 600; margin: 0 0 1rem; color: var(--dark-gray); }
        #strategy-panel .button-group { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        #strategy-panel button {
            background-color: var(--primary-color);
            color: white; border: none; padding: 10px 15px;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
        }
        #strategy-panel button.purple { background-color: #6a1b9a; }
        #strategy-panel button.purple:hover { background-color: #7b1fa2; }
        
        .quiz-area { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--medium-gray); }
        .quiz-area p { font-weight: normal; font-family: monospace; font-size: 1rem; }
        .quiz-area input {
            width: 80px;
            padding: 8px;
            font-size: 1.1rem;
            text-align: center;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            margin: 0 0.5rem;
        }
        
        .message-area {
            text-align: center;
            font-weight: 600;
            min-height: 1.6em;
            color: var(--primary-color);
            transition: color 0.3s;
        }
        .message-area.error { color: var(--danger-color); }

    </style>
</head>
<body>
<div class="container">
    <h2>Multiplication Strategy Explorer</h2>
    <p class="info">Click a `?` to solve a multiplication fact. Then, use one of the strategies to unlock the answer!</p>
    
    <div id="grid-container" class="grid-container"></div>
    
    <div id="strategy-panel" style="display: none;">
        <p id="strategy-title"></p>
        <div id="strategy-buttons" class="button-group"></div>
        <div id="quiz-area"></div>
    </div>

    <p id="message-area" class="message-area"></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const GRID_SIZE = 12;
    const initialUnlocked = new Set([
        ...Array.from({length: GRID_SIZE}, (_,j)=>`1x${j+1}`),
        ...Array.from({length: GRID_SIZE}, (_,j)=>`2x${j+1}`),
        ...Array.from({length: GRID_SIZE}, (_,j)=>`5x${j+1}`),
        ...Array.from({length: GRID_SIZE}, (_,j)=>`10x${j+1}`),
    ]);

    let state = {
        known: withPairs(initialUnlocked),
        selectedCell: null, // { i, j, key }
        message: 'Select a `?` to begin.',
        activeStrategyData: null, // { type, answer, ... }
    };

    const gridContainer = document.getElementById('grid-container');
    const strategyPanel = document.getElementById('strategy-panel');
    const strategyTitle = document.getElementById('strategy-title');
    const strategyButtons = document.getElementById('strategy-buttons');
    const quizArea = document.getElementById('quiz-area');
    const messageArea = document.getElementById('message-area');

    function withPairs(set) {
        const res = new Set(set);
        set.forEach(key => { const [a, b] = key.split('x'); res.add(`${b}x${a}`); });
        return res;
    }

    function handleCellClick(cellData) {
        if (state.known.has(cellData.key)) return;
        state.selectedCell = cellData;
        state.message = '';
        state.activeStrategyData = null;
        render();
    }

    function unlock(key) {
        const [i, j] = key.split('x');
        state.known = withPairs(new Set([...state.known, key]));
        state.selectedCell = null;
        state.activeStrategyData = null;
        state.message = `ðŸŽ‰ Fact ${i} Ã— ${j} unlocked!`;
        render();
        // Flash the commutative pair
        const commutativeCell = gridContainer.querySelector(`[data-key="${j}x${i}"]`);
        if (commutativeCell) {
            commutativeCell.classList.add('flash');
            setTimeout(() => commutativeCell.classList.remove('flash'), 1000);
        }
    }

    function checkAnswer() {
        if (!state.activeStrategyData) return;
        const userInput = document.getElementById('quiz-input');
        const answer = parseInt(userInput.value);
        if (answer === state.activeStrategyData.answer) {
            unlock(state.selectedCell.key);
        } else {
            state.message = 'Not quite! Try calculating again.';
            renderMessage();
        }
    }

    function presentQuiz(quiz) {
        state.activeStrategyData = quiz;
        state.message = '';
        quizArea.innerHTML = `
            <p>${quiz.prompt}</p>
            <div style="margin-top: 0.5rem;">
                ${quiz.calculation} = 
                <input type="number" id="quiz-input" autofocus />
                <button id="check-answer-btn">Check</button>
            </div>
        `;
        document.getElementById('check-answer-btn').addEventListener('click', checkAnswer);
        document.getElementById('quiz-input').addEventListener('keydown', e => {
            if (e.key === 'Enter') checkAnswer();
        });
    }

    function setupNearbyStrategy() {
        const { i, j } = state.selectedCell;
        const prevKey = `${i}x${j - 1}`;
        const fact1 = i * (j - 1);
        presentQuiz({
            type: 'nearby',
            answer: fact1 + i,
            prompt: `We know <strong>${i} Ã— ${j - 1} = ${fact1}</strong>.`,
            calculation: `<strong>${fact1} + ${i}</strong>`
        });
    }

    function setupDistributiveStrategy(parts) {
        const { i, j } = state.selectedCell;
        const [k1, k2] = parts;
        const fact1 = i * k1;
        const fact2 = i * k2;
        presentQuiz({
            type: 'distributive',
            answer: fact1 + fact2,
            prompt: `Since ${j} = ${k1} + ${k2}, we can solve this by adding <strong>(${i} Ã— ${k1}) + (${i} Ã— ${k2})</strong>.`,
            calculation: `<strong>${fact1} + ${fact2}</strong>`
        });
    }

    // --- RENDERING ---
    function render() {
        renderGrid();
        renderStrategyPanel();
        renderMessage();
    }

    function renderGrid() {
        gridContainer.innerHTML = '';
        gridContainer.appendChild(document.createElement('div'));
        for (let i = 1; i <= GRID_SIZE; i++) {
            const header = document.createElement('div');
            header.className = 'grid-header'; header.textContent = i;
            gridContainer.appendChild(header);
        }
        for (let i = 1; i <= GRID_SIZE; i++) {
            const header = document.createElement('div');
            header.className = 'grid-header'; header.textContent = i;
            gridContainer.appendChild(header);
            for (let j = 1; j <= GRID_SIZE; j++) {
                const key = `${i}x${j}`;
                const button = document.createElement('button');
                button.className = 'grid-button';
                button.dataset.key = key;
                
                const isKnown = state.known.has(key);
                button.classList.add(isKnown ? 'known' : 'unknown');
                button.disabled = isKnown;
                button.textContent = isKnown ? i * j : '?';
                
                if (state.selectedCell?.key === key) button.classList.add('selected');
                
                button.addEventListener('click', () => handleCellClick({ i, j, key }));
                gridContainer.appendChild(button);
            }
        }
    }

    function renderStrategyPanel() {
        quizArea.innerHTML = '';
        if (state.selectedCell) {
            strategyTitle.textContent = `How can we find ${state.selectedCell.i} Ã— ${state.selectedCell.j}?`;
            strategyButtons.innerHTML = '';

            // Check for Nearby Fact strategy
            const { i, j } = state.selectedCell;
            const prevKey = `${i}x${j - 1}`;
            if (j > 1 && state.known.has(prevKey)) {
                const btn = document.createElement('button');
                btn.textContent = 'Use Nearby Fact';
                btn.addEventListener('click', setupNearbyStrategy);
                strategyButtons.appendChild(btn);
            }

            // Check for Distributive Property strategy
            for (let k = 1; k < j / 2 + 1; k++) {
                if (state.known.has(`${i}x${k}`) && state.known.has(`${i}x${j - k}`)) {
                    const btn = document.createElement('button');
                    btn.textContent = `Break into (${i}x${k}) + (${i}x${j-k})`;
                    btn.className = 'purple';
                    btn.addEventListener('click', () => setupDistributiveStrategy([k, j - k]));
                    strategyButtons.appendChild(btn);
                    break; // Only show one distributive option for simplicity
                }
            }

            strategyPanel.style.display = 'block';
        } else {
            strategyPanel.style.display = 'none';
        }
    }
    
    function renderMessage() {
        messageArea.textContent = state.message;
        messageArea.className = state.message.startsWith('ðŸŽ‰') ? 'message-area' : 'message-area error';
    }
    
    // --- INITIALIZATION ---
    render();
});
</script>
</body>
</html>
