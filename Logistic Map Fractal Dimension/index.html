<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Logistic Map Fractal Dimension Explorer (Improved)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; }
    #controls { margin: 1em 0; }
    label { margin-right: 1em; }
    canvas { border: 1px solid #999; display: block; margin-bottom: 1em; }
    #loglog { background: #fff; }
  </style>
</head>
<body>
  <h2>Logistic Map Fractal Dimension Explorer (Box-Counting)</h2>
  <div id="controls">
    <label>r: <input type="range" id="rSlider" min="3.5" max="4" step="0.001" value="3.9"/> <span id="rValue">3.900</span></label>
    <label>Boxes (N): <input type="range" id="boxSlider" min="10" max="200" step="1" value="50"/> <span id="boxValue">50</span></label>
    <button id="addPoint">Add Data Point</button>
    <button id="clearData">Clear Data</button>
  </div>
  <main>
    <div>
      <canvas id="logmap"></canvas>
      <canvas id="loglog" width="400" height="300"></canvas>
    </div>
  </main>
  <p>
    <b>Instructions:</b> Adjust <code>r</code> for the logistic map. Change the box size (N), then press <b>Add Data Point</b> to collect (<code>N</code>, <code>Number of occupied boxes</code>). As you collect data for different box sizes, the lower plot shows the log-log plot and the estimated fractal dimension as the slope.
  </p>
  <script>
    // Parameters
    let r = 3.9;
    let x0 = 0.2;
    let iterations = 2000, skip = 200;
    let points = [];
    let boxCount = 50;
    let boxData = []; // stores {N, occupied, eps}

    // --- Setup Controls ---
    const rSlider = document.getElementById('rSlider');
    const rValue = document.getElementById('rValue');
    rSlider.oninput = function() {
      r = parseFloat(rSlider.value);
      rValue.textContent = r.toFixed(3);
      generateLogisticMap();
      redrawMain();
    };

    const boxSlider = document.getElementById('boxSlider');
    const boxValue = document.getElementById('boxValue');
    boxSlider.oninput = function() {
      boxCount = parseInt(boxSlider.value);
      boxValue.textContent = boxCount;
      redrawMain();
    };

    document.getElementById('addPoint').onclick = function() {
      let N = boxCount;
      let {nOccupied, eps} = countBoxes(N);
      // Prevent duplicate box size entries:
      if (!boxData.some(d => d.N === N)) {
        boxData.push({N, nOccupied, eps});
        drawLogLogPlot();
      }
    };

    document.getElementById('clearData').onclick = function() {
      boxData = [];
      drawLogLogPlot();
    };

    // --- Logistic Map Data Generation ---
    function generateLogisticMap() {
      let x = x0;
      points = [];
      for (let i = 0; i < iterations + skip; i++) {
        x = r * x * (1 - x);
        if (i >= skip) points.push(x);
      }
    }

    // --- Box Counting Logic ---
    function countBoxes(N) {
      let occupied = new Array(N).fill(false);
      points.forEach(x => {
        let box = Math.floor(x * N);
        if (box >= 0 && box < N) occupied[box] = true;
      });
      let nOccupied = occupied.filter(b => b).length;
      let eps = 1.0 / N;
      return {nOccupied, eps, occupied};
    }

    // --- Drawing Functions ---
    function redrawMain() {
      drawMap();
      drawLogLogPlot();
    }

    function drawMap() {
      const c = document.getElementById('logmap');
      c.width = 600; c.height = 250;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);

      // Margins
      let left = 60, right = 20, top = 20, bottom = 40;
      let width = c.width - left - right;
      let height = c.height - top - bottom;

      // Axes
      ctx.strokeStyle = "#bbb";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(left, top);
      ctx.lineTo(lef



