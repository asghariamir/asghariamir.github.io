<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagmeh ‚Äî The Multiplication Chase | Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #10b981;
            --primary-dark: #0a5c56;
            --bg: #f7faf9;
            --interactive: #e6fffb;
            --text: #212121;
            --muted: #4b5563;
            --amber: #f59e0b;
            --gold: #d97706;
            --red: #dc2626;
            --success: #10b981;
            --p1: #0f766e;
            --p1-bg: #e6fffb;
            --p2: #d97706;
            --p2-bg: #fef3c7;
            --card-w: 72px;
            --card-h: 72px;
        }
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            padding-top: 52px; min-height: 100vh;
        }
        [dir="rtl"] body { font-family: 'Vazirmatn', sans-serif; }

        /* NAV */
        .nav { position:fixed; top:0; left:0; right:0; background:white;
            border-bottom:2px solid var(--primary); padding:0.6rem 1rem;
            z-index:1000; display:flex; justify-content:center; align-items:center; }
        .nav a { display:flex; align-items:center; gap:0.5rem; text-decoration:none;
            color:var(--primary); font-weight:600; letter-spacing:1px; font-size:0.85rem; }

        /* LANG */
        .lang { position:fixed; top:58px; right:10px; z-index:999;
            display:flex; gap:3px; background:white; border-radius:18px; padding:2px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        [dir="rtl"] .lang { right:auto; left:10px; }
        .lang button { padding:3px 10px; border:none; border-radius:14px; font-size:0.78rem;
            cursor:pointer; font-weight:600; background:transparent; color:var(--muted); transition:0.2s; }
        .lang button.on { background:var(--primary); color:white; }

        .wrap { max-width:680px; margin:0 auto; padding:0.75rem 1rem 2rem; }

        /* SCREENS */
        .scr { display:none; animation: fadeUp 0.35s ease; }
        .scr.on { display:block; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* ‚îÄ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ‚îÄ */
        .hero { text-align:center; padding:1.5rem 0 0.75rem; }
        .hero-icon { font-size:2.5rem; }
        .hero h1 { font-size:2rem; color:var(--primary); font-weight:800; }
        [dir="rtl"] .hero h1 { font-size:2.2rem; }
        .hero .sub { font-size:1rem; color:var(--muted); margin-top:0.15rem; font-weight:500; }
        .hero .tag { font-size:0.82rem; color:var(--gold); font-style:italic; margin-top:0.3rem; }

        .ded { text-align:center; background:var(--interactive); border:1px solid var(--primary);
            border-radius:10px; padding:0.65rem 1rem; margin:0.75rem 0 1.25rem;
            font-size:0.82rem; color:var(--primary-dark); line-height:1.5; }
        .ded small { display:block; font-style:italic; color:var(--muted); margin-top:0.2rem; font-size:0.78rem; }

        .panel { background:white; border-radius:12px; padding:1.25rem;
            box-shadow:0 4px 16px rgba(0,0,0,0.08); }
        .panel-title { font-size:1.05rem; font-weight:700; color:var(--primary);
            text-align:center; margin-bottom:1rem; }

        .sg { margin-bottom:1rem; }
        .sg-label { font-size:0.82rem; font-weight:600; display:block; margin-bottom:0.35rem; }
        .sg-desc { font-size:0.72rem; color:var(--muted); margin-top:2px; }

        .pills { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; }
        .pill { width:40px; height:40px; border-radius:50%; border:2px solid var(--primary);
            background:white; color:var(--primary); font-weight:700; font-size:0.95rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .pill:hover { background:var(--interactive); transform:translateY(-2px); }
        .pill.on { background:var(--primary); color:white; box-shadow:0 2px 8px rgba(15,118,110,0.3); }

        .opts { display:flex; gap:7px; flex-wrap:wrap; }
        .opt { flex:1; min-width:110px; padding:0.55rem 0.7rem; border:2px solid var(--primary);
            border-radius:8px; background:white; color:var(--primary); font-weight:600;
            font-size:0.82rem; cursor:pointer; text-align:center; transition:0.2s; }
        .opt:hover { background:var(--interactive); }
        .opt.on { background:var(--primary); color:white; }

        .sld { display:flex; align-items:center; gap:8px; }
        .sld input[type=range] { flex:1; accent-color:var(--primary); }
        .sld-v { font-weight:700; color:var(--primary); min-width:30px; text-align:center; font-size:1rem; }

        .go { display:block; width:100%; padding:0.9rem; margin-top:1.2rem;
            background:var(--primary); color:white; border:none; border-radius:10px;
            font-size:1.1rem; font-weight:700; cursor:pointer; transition:0.2s; letter-spacing:0.5px; }
        .go:hover { background:var(--primary-dark); transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(15,118,110,0.3); }

        /* ‚îÄ‚îÄ‚îÄ GAME ‚îÄ‚îÄ‚îÄ */
        .pbar { display:flex; gap:8px; margin-bottom:0.6rem; align-items:stretch; }
        .pbox { flex:1; padding:0.45rem 0.6rem; border-radius:10px; text-align:center;
            border:2px solid transparent; transition:0.3s; }
        .pbox.p1 { background:var(--p1-bg); }
        .pbox.p2 { background:var(--p2-bg); }
        .pbox.cur.p1 { border-color:var(--p1); box-shadow:0 0 10px rgba(15,118,110,0.2); }
        .pbox.cur.p2 { border-color:var(--p2); box-shadow:0 0 10px rgba(217,119,6,0.2); }
        .pn { font-weight:700; font-size:0.82rem; }
        .pbox.p1 .pn { color:var(--p1); }
        .pbox.p2 .pn { color:var(--p2); }
        .pnotes { font-size:1.05rem; margin-top:2px; letter-spacing:2px; min-height:1.3em; }
        .tmr { display:flex; align-items:center; justify-content:center; padding:0 0.4rem;
            font-size:1rem; font-weight:700; color:var(--primary); min-width:56px; }
        .tmr.low { color:var(--red); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from{transform:scale(1)} to{transform:scale(1.06)} }

        .msg { text-align:center; padding:0.45rem 0.5rem; border-radius:8px; font-weight:600;
            font-size:0.88rem; margin-bottom:0.6rem; min-height:2.2em;
            display:flex; align-items:center; justify-content:center; transition:0.3s; }
        .msg.n { background:var(--interactive); color:var(--primary); }
        .msg.g { background:#d1fae5; color:#065f46; }
        .msg.b { background:#fee2e2; color:#991b1b; }
        .msg.i { background:#fef3c7; color:#92400e; }

        .slbl { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1.5px;
            color:var(--muted); margin-bottom:0.35rem; text-align:center; }

        /* CARDS */
        .cgrid { display:flex; flex-wrap:wrap; gap:7px; justify-content:center; margin-bottom:0.85rem;
            perspective:1000px; }
        .crd { width:var(--card-w); height:var(--card-h); perspective:600px;
            cursor:pointer; transition:opacity 0.3s, transform 0.3s; }
        .crd.gone { opacity:0; pointer-events:none; transform:scale(0.4); }
        .crd.off { pointer-events:none; opacity:0.45; }
        .ci { position:relative; width:100%; height:100%; transition:transform 0.4s ease;
            transform-style:preserve-3d; }
        .crd.flip .ci { transform:rotateY(180deg); }
        .cf { position:absolute; width:100%; height:100%; backface-visibility:hidden;
            border-radius:8px; display:flex; align-items:center; justify-content:center;
            font-weight:700; border:2px solid transparent; }
        .cb { background:linear-gradient(145deg, var(--primary) 0%, var(--primary-light) 100%);
            color:rgba(255,255,255,0.3); font-size:1.4rem; border-color:rgba(255,255,255,0.12); }
        .cb::before { content:'‚ô™'; }
        .crd.ans .cb { background:linear-gradient(145deg, var(--gold) 0%, var(--amber) 100%); }
        .cff { transform:rotateY(180deg); background:white; border-color:#d1d5db; }
        .crd.fact .cff { font-size:0.82rem; color:var(--text); padding:2px; line-height:1.2; text-align:center; }
        .crd.ans .cff { font-size:1.1rem; color:var(--text); }

        .crd.fact.elig .cff { border-color:var(--success); background:#ecfdf5; }
        .crd.fact.nelig .cff { border-color:var(--red); background:#fef2f2; }
        .crd.fact.sel .cff { border-color:var(--primary); box-shadow:0 0 10px rgba(15,118,110,0.3); background:var(--interactive); }
        .crd.ans.sel .cff { border-color:var(--amber); box-shadow:0 0 10px rgba(245,158,11,0.3); background:var(--p2-bg); }
        .crd.ans.cok .cff { border-color:var(--success); background:#d1fae5; }
        .crd.ans.cbad .cff { border-color:var(--red); background:#fee2e2; }
        .crd.fact.cok .cff { border-color:var(--success); background:#d1fae5; }

        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-5px)}
            40%{transform:translateX(5px)} 60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} }
        .crd.shk { animation:shake 0.35s ease; }
        @keyframes celeb { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(0.3);opacity:0} }
        .crd.cel { animation:celeb 0.55s ease forwards; }

        /* TRAY */
        .tray { display:flex; align-items:center; justify-content:center; gap:10px;
            background:white; border:2px dashed var(--primary); border-radius:12px;
            padding:0.65rem 0.8rem; margin-bottom:0.85rem; min-height:66px; }
        .ts { width:84px; height:50px; border:2px dashed #cbd5e1; border-radius:8px;
            display:flex; align-items:center; justify-content:center; font-weight:700;
            font-size:0.9rem; color:var(--muted); background:var(--bg); transition:0.3s; }
        .ts.f { border-style:solid; background:white; color:var(--text); }
        .ts.ff.f { border-color:var(--primary); background:var(--interactive); }
        .ts.af.f { border-color:var(--amber); background:var(--p2-bg); }
        .ta { font-size:1.2rem; color:var(--primary); font-weight:700; }
        .tw { display:flex; flex-direction:column; align-items:center; }
        .tlbl { font-size:0.62rem; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-top:2px; }

        /* BASKETS */
        .bks { display:flex; gap:8px; margin-top:0.6rem; }
        .bk { flex:1; padding:0.4rem 0.5rem; border-radius:8px; min-height:40px; }
        .bk.b1 { background:var(--p1-bg); border:1px solid rgba(15,118,110,0.15); }
        .bk.b2 { background:var(--p2-bg); border:1px solid rgba(217,119,6,0.15); }
        .bk-t { font-size:0.68rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px; }
        .bk.b1 .bk-t { color:var(--p1); }
        .bk.b2 .bk-t { color:var(--p2); }
        .bk-p { display:flex; flex-wrap:wrap; gap:3px; }
        .bk-c { font-size:0.68rem; padding:2px 5px; border-radius:4px; font-weight:600; background:white; }
        .bk.b1 .bk-c { color:var(--p1); }
        .bk.b2 .bk-c { color:var(--p2); }

        /* ‚îÄ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ‚îÄ */
        .gop { text-align:center; background:white; border-radius:16px; padding:2rem 1.5rem;
            box-shadow:0 8px 32px rgba(0,0,0,0.12); margin-top:1rem; }
        .gop h2 { font-size:1.7rem; color:var(--primary); margin-bottom:0.4rem; }
        .wt { font-size:1.2rem; font-weight:700; margin-bottom:1rem; }
        .fs { display:flex; gap:1rem; justify-content:center; margin-bottom:1.5rem; }
        .fsb { padding:0.9rem 1.3rem; border-radius:12px; min-width:110px; }
        .fsb.p1 { background:var(--p1-bg); }
        .fsb.p2 { background:var(--p2-bg); }
        .fsb .fn { font-weight:700; font-size:0.85rem; }
        .fsb.p1 .fn { color:var(--p1); }
        .fsb.p2 .fn { color:var(--p2); }
        .fsb .fm { font-size:1.4rem; letter-spacing:3px; margin-top:3px; }
        .fsb .fc { font-size:0.78rem; color:var(--muted); margin-top:2px; }
        .brow { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
        .bp { padding:0.7rem 1.4rem; border:none; border-radius:8px; background:var(--primary);
            color:white; font-weight:700; font-size:0.95rem; cursor:pointer; transition:0.2s; }
        .bp:hover { background:var(--primary-dark); transform:translateY(-2px); }
        .bs { padding:0.7rem 1.4rem; border:2px solid var(--primary); border-radius:8px;
            background:white; color:var(--primary); font-weight:700; font-size:0.95rem;
            cursor:pointer; transition:0.2s; }
        .bs:hover { background:var(--interactive); }

        .hid { display:none !important; }

        @media(max-width:500px) {
            :root { --card-w:62px; --card-h:62px; }
            .hero h1 { font-size:1.6rem; }
            .crd.fact .cff { font-size:0.72rem; }
            .ts { width:70px; height:44px; font-size:0.82rem; }
            .pill { width:36px; height:36px; font-size:0.85rem; }
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">
            <img src="/logo-mathswell-square-mirror.svg" alt="" width="26" height="26" onerror="this.style.display='none'">
            <span>MATHSWELL</span>
        </a>
    </div>
    <div class="lang">
        <button class="on" onclick="setLang('en')">EN</button>
        <button onclick="setLang('fa')">ŸÅÿß</button>
    </div>

    <div class="wrap">
        <!-- ‚ïê‚ïê‚ïê SETUP ‚ïê‚ïê‚ïê -->
        <div id="S" class="scr on">
            <div class="hero">
                <div class="hero-icon">üéµ</div>
                <h1 id="t-title">Nagmeh</h1>
                <div class="sub" id="t-sub">The Multiplication Chase</div>
                <div class="tag" id="t-tag">Catch the right multiplication before it's gone</div>
            </div>
            <div class="ded">
                <span id="t-ded">Inspired by a classroom card game shared by an Iranian mathematics teacher</span>
                <small id="t-ded2">Because the best learning feels like play</small>
            </div>
            <div class="panel">
                <div class="panel-title" id="t-set">Game Settings</div>

                <div class="sg">
                    <label class="sg-label" id="t-tgt">Target Number</label>
                    <div class="pills" id="tgt-pills"></div>
                </div>

                <div class="sg">
                    <label class="sg-label" id="t-rule">Eligibility Rule</label>
                    <div class="opts">
                        <button class="opt on" data-s="rule" data-v="pure" onclick="setS(this)">
                            <span id="t-pure">Pure Table</span></button>
                        <button class="opt" data-s="rule" data-v="multiples" onclick="setS(this)">
                            <span id="t-mult">Multiples</span></button>
                    </div>
                    <div class="sg-desc" id="rule-desc"></div>
                </div>

                <div class="sg">
                    <label class="sg-label" id="t-mode">Card Mode</label>
                    <div class="opts">
                        <button class="opt on" data-s="mode" data-v="classic" onclick="setS(this)">
                            <span id="t-classic">Classic</span></button>
                        <button class="opt" data-s="mode" data-v="reverse" onclick="setS(this)">
                            <span id="t-rev">Reverse</span></button>
                    </div>
                    <div class="sg-desc" id="mode-desc"></div>
                </div>

                <div class="sg">
                    <label class="sg-label" id="t-win">Win Condition</label>
                    <div class="opts" style="margin-bottom:7px">
                        <button class="opt on" data-s="winType" data-v="pairs" onclick="setS(this)">
                            <span id="t-fp">First to N pairs</span></button>
                        <button class="opt" data-s="winType" data-v="time" onclick="setS(this)">
                            <span id="t-tl">Time Limit</span></button>
                    </div>
                    <div id="psl" class="sld">
                        <span style="font-size:0.78rem;color:var(--muted)">3</span>
                        <input type="range" min="3" max="8" value="5" id="pR"
                            oninput="C.targetPairs=+this.value;$('pV').textContent=N(this.value)">
                        <span style="font-size:0.78rem;color:var(--muted)">8</span>
                        <span class="sld-v" id="pV">5</span>
                        <span style="font-size:0.78rem;color:var(--muted)" id="t-pr">pairs</span>
                    </div>
                    <div id="tsl" class="sld hid">
                        <span style="font-size:0.78rem;color:var(--muted)">1</span>
                        <input type="range" min="1" max="5" value="2" id="tR"
                            oninput="C.timeLimit=+this.value*60;$('tV').textContent=N(this.value)">
                        <span style="font-size:0.78rem;color:var(--muted)">5</span>
                        <span class="sld-v" id="tV">2</span>
                        <span style="font-size:0.78rem;color:var(--muted)" id="t-mn">min</span>
                    </div>
                </div>

                <div class="sg">
                    <label class="sg-label" id="t-pl">Players</label>
                    <div class="opts">
                        <button class="opt" data-s="players" data-v="1" onclick="setS(this)">
                            <span id="t-solo">Solo</span></button>
                        <button class="opt on" data-s="players" data-v="2" onclick="setS(this)">
                            <span id="t-2p">2 Players</span></button>
                    </div>
                </div>

                <div class="sg">
                    <label class="sg-label" id="t-str">Streak Mode</label>
                    <div class="opts">
                        <button class="opt" data-s="streak" data-v="on" onclick="setS(this)">
                            <span id="t-on">On</span></button>
                        <button class="opt on" data-s="streak" data-v="off" onclick="setS(this)">
                            <span id="t-off">Off</span></button>
                    </div>
                    <div class="sg-desc" id="t-strd">Extra turn on correct match</div>
                </div>

                <button class="go" onclick="startGame()" id="t-go">‚ñ∂ Start Game</button>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê -->
        <div id="G" class="scr">
            <div class="pbar">
                <div class="pbox p1" id="pb1">
                    <div class="pn" id="pn1"></div>
                    <div class="pnotes" id="pm1">‚Äî</div>
                </div>
                <div class="tmr hid" id="tmr"></div>
                <div class="pbox p2" id="pb2">
                    <div class="pn" id="pn2"></div>
                    <div class="pnotes" id="pm2">‚Äî</div>
                </div>
            </div>
            <div class="msg n" id="msg"></div>
            <div class="slbl" id="t-fc">Fact Cards</div>
            <div class="cgrid" id="fg"></div>
            <div class="tray" id="tray">
                <div class="tw">
                    <div class="ts ff" id="tf"><span style="font-size:0.65rem" id="tfl1">Fact</span></div>
                    <div class="tlbl" id="tfl2">Fact</div>
                </div>
                <div class="ta">‚Üí</div>
                <div class="tw">
                    <div class="ts af" id="ta"><span style="font-size:0.65rem" id="tal1">Answer</span></div>
                    <div class="tlbl" id="tal2">Answer</div>
                </div>
            </div>
            <div class="slbl" id="t-ac">Answer Cards</div>
            <div class="cgrid" id="ag"></div>
            <div class="bks">
                <div class="bk b1">
                    <div class="bk-t" id="bkt1"></div>
                    <div class="bk-p" id="bkp1"></div>
                </div>
                <div class="bk b2" id="bk2w">
                    <div class="bk-t" id="bkt2"></div>
                    <div class="bk-p" id="bkp2"></div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê -->
        <div id="O" class="scr">
            <div class="gop">
                <h2 id="t-go2">Game Over!</h2>
                <div class="wt" id="wt"></div>
                <div class="fs" id="fsc"></div>
                <div class="brow">
                    <button class="bp" onclick="startGame()" id="t-pa">Play Again</button>
                    <button class="bs" onclick="back()" id="t-ng">New Game</button>
                </div>
            </div>
        </div>
    </div>

<script>
const $=id=>document.getElementById(id);

/* ‚ïê‚ïê‚ïê TRANSLATIONS ‚ïê‚ïê‚ïê */
const L={
en:{
    title:'Nagmeh', sub:'The Multiplication Chase',
    tag:'Catch the right multiplication before it\'s gone',
    ded:'Inspired by a classroom card game shared by an Iranian mathematics teacher',
    ded2:'Because the best learning feels like play',
    set:'Game Settings', tgt:'Target Number', rule:'Eligibility Rule',
    pure:'Pure Table', mult:'Multiples',
    pureD:'Only __T__ √ó n facts count', multD:'Any fact whose product is a multiple of __T__',
    mode:'Card Mode', classic:'Classic', rev:'Reverse',
    classicD:'Hidden facts, visible answers', revD:'Visible facts, hidden answers',
    win:'Win Condition', fp:'First to N pairs', tl:'Time Limit',
    pr:'pairs', mn:'min',
    pl:'Players', solo:'Solo', '2p':'2 Players',
    str:'Streak Mode', strd:'Extra turn on correct match',
    on:'On', off:'Off', go:'‚ñ∂ Start Game',
    player:'Player', fc:'Fact Cards', ac:'Answer Cards',
    fl:'Fact', al:'Answer',
    pick:'Pick a fact card!', pickV:'Choose a fact to play!',
    nelig:'Not a __T__√ó fact! Turn lost.',
    neligM:'Product is not a multiple of __T__! Turn lost.',
    elig:'‚úì It\'s a __T__√ó fact! Now pick the answer.',
    eligM:'‚úì Product is a multiple of __T__! Now pick the answer.',
    ok:'‚ô™ Correct!', wrong:'__A__ √ó __B__ = __P__',
    bonus:'‚ô™ Bonus turn!',
    over:'Game Over!', wins:'__N__ wins!', draw:'It\'s a draw!',
    soloW:'You did it!', soloL:'Time\'s up!',
    pa:'Play Again', ng:'New Game',
    noEl:'No more eligible facts on the board!',
    bask:'pairs', turn:'__N__\'s turn'
},
fa:{
    title:'ŸÜÿ∫ŸÖŸá', sub:'ŸÖÿ≥ÿßÿ®ŸÇŸá ÿ∂ÿ±ÿ®',
    tag:'ÿ∂ÿ±ÿ® ÿØÿ±ÿ≥ÿ™ ÿ±Ÿà ŸÇÿ®ŸÑ ÿßÿ≤ ÿß€åŸÜ⁄©Ÿá ÿ®ÿ±Ÿá Ÿæ€åÿØÿß ⁄©ŸÜ',
    ded:'ÿßŸÑŸáÿßŸÖ‚Äå⁄Øÿ±ŸÅÿ™Ÿá ÿßÿ≤ €å⁄© ÿ®ÿßÿ≤€å ⁄©ŸÑÿßÿ≥€å Ÿæ€åÿ¥ŸÜŸáÿßÿØÿ¥ÿØŸá ÿ™Ÿàÿ≥ÿ∑ €å⁄© ŸÖÿπŸÑŸÖ ÿ±€åÿßÿ∂€å ÿß€åÿ±ÿßŸÜ€å',
    ded2:'⁄ÜŸàŸÜ ÿ®Ÿáÿ™ÿ±€åŸÜ €åÿßÿØ⁄Ø€åÿ±€åÿå ÿ¥ÿ®€åŸá ÿ®ÿßÿ≤€å ÿßÿ≥ÿ™',
    set:'ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ÿ®ÿßÿ≤€å', tgt:'ÿπÿØÿØ ŸáÿØŸÅ', rule:'ŸÇÿßŸÜŸàŸÜ ÿ®ÿßÿ≤€å',
    pure:'ÿ¨ÿØŸàŸÑ ÿÆÿßŸÑÿµ', mult:'ŸÖÿ∂ÿßÿ±ÿ®',
    pureD:'ŸÅŸÇÿ∑ ÿ∂ÿ±ÿ®‚ÄåŸáÿß€å __T__ √ó n ŸÇÿ®ŸàŸÑ Ÿáÿ≥ÿ™ŸÜÿØ', multD:'Ÿáÿ± ÿ∂ÿ±ÿ®€å ⁄©Ÿá ÿ≠ÿßÿµŸÑÿ¥ ŸÖÿ∂ÿ±ÿ® __T__ ÿ®ÿßÿ¥ÿØ',
    mode:'ÿ≠ÿßŸÑÿ™ ⁄©ÿßÿ±ÿ™‚ÄåŸáÿß', classic:'⁄©ŸÑÿßÿ≥€å⁄©', rev:'ŸÖÿπ⁄©Ÿàÿ≥',
    classicD:'⁄©ÿßÿ±ÿ™ ÿ∂ÿ±ÿ® ŸæŸÜŸáÿßŸÜÿå ⁄©ÿßÿ±ÿ™ ÿ¨Ÿàÿßÿ® ÿ¢ÿ¥⁄©ÿßÿ±', revD:'⁄©ÿßÿ±ÿ™ ÿ∂ÿ±ÿ® ÿ¢ÿ¥⁄©ÿßÿ±ÿå ⁄©ÿßÿ±ÿ™ ÿ¨Ÿàÿßÿ® ŸæŸÜŸáÿßŸÜ',
    win:'ÿ¥ÿ±ÿ∑ ÿ®ÿ±ÿØ', fp:'ÿßŸàŸÑ€åŸÜ ŸÜŸÅÿ± ÿ®ÿß N ÿ¨ŸÅÿ™', tl:'ŸÖÿ≠ÿØŸàÿØ€åÿ™ ÿ≤ŸÖÿßŸÜ€å',
    pr:'ÿ¨ŸÅÿ™', mn:'ÿØŸÇ€åŸÇŸá',
    pl:'ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ', solo:'ÿ™⁄©€å', '2p':'€≤ ŸÜŸÅÿ±Ÿá',
    str:'ÿ≠ÿßŸÑÿ™ ŸÖÿ™ŸàÿßŸÑ€å', strd:'ŸÜŸàÿ®ÿ™ ÿßÿ∂ÿßŸÅŸá ÿ®ÿß ÿ¨Ÿàÿßÿ® ÿØÿ±ÿ≥ÿ™',
    on:'ÿ±Ÿàÿ¥ŸÜ', off:'ÿÆÿßŸÖŸàÿ¥', go:'‚ñ∂ ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å',
    player:'ÿ®ÿßÿ≤€å⁄©ŸÜ', fc:'⁄©ÿßÿ±ÿ™‚ÄåŸáÿß€å ÿ∂ÿ±ÿ®', ac:'⁄©ÿßÿ±ÿ™‚ÄåŸáÿß€å ÿ¨Ÿàÿßÿ®',
    fl:'ÿ∂ÿ±ÿ®', al:'ÿ¨Ÿàÿßÿ®',
    pick:'€å⁄© ⁄©ÿßÿ±ÿ™ ÿ∂ÿ±ÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ!', pickV:'€å⁄© ÿ∂ÿ±ÿ® ÿ®ÿ±ÿß€å ÿ®ÿßÿ≤€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ!',
    nelig:'ÿß€åŸÜ ÿ∂ÿ±ÿ® __T__ ŸÜ€åÿ≥ÿ™! ŸÜŸàÿ®ÿ™ ÿßÿ≤ ÿØÿ≥ÿ™ ÿ±ŸÅÿ™.',
    neligM:'ÿ≠ÿßÿµŸÑ‚Äåÿ∂ÿ±ÿ®ÿå ŸÖÿ∂ÿ±ÿ® __T__ ŸÜ€åÿ≥ÿ™! ŸÜŸàÿ®ÿ™ ÿßÿ≤ ÿØÿ≥ÿ™ ÿ±ŸÅÿ™.',
    elig:'‚úì ÿ∂ÿ±ÿ® __T__ Ÿáÿ≥ÿ™! ÿ≠ÿßŸÑÿß ÿ¨Ÿàÿßÿ® ÿ±Ÿà ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ.',
    eligM:'‚úì ÿ≠ÿßÿµŸÑ‚Äåÿ∂ÿ±ÿ®ÿå ŸÖÿ∂ÿ±ÿ® __T__ Ÿáÿ≥ÿ™! ÿ≠ÿßŸÑÿß ÿ¨Ÿàÿßÿ® ÿ±Ÿà ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ.',
    ok:'‚ô™ ÿ¢ŸÅÿ±€åŸÜ!', wrong:'__P__ = __B__ √ó __A__',
    bonus:'‚ô™ ŸÜŸàÿ®ÿ™ ÿßÿ∂ÿßŸÅŸá!',
    over:'ÿ®ÿßÿ≤€å ÿ™ŸÖÿßŸÖ ÿ¥ÿØ!', wins:'__N__ ÿ®ÿ±ŸÜÿØŸá ÿ¥ÿØ!', draw:'ŸÖÿ≥ÿßŸà€å!',
    soloW:'ŸÖŸàŸÅŸÇ ÿ¥ÿØ€å!', soloL:'ŸàŸÇÿ™ ÿ™ŸÖÿßŸÖ ÿ¥ÿØ!',
    pa:'ÿ®ÿßÿ≤€å ÿØŸàÿ®ÿßÿ±Ÿá', ng:'ÿ®ÿßÿ≤€å ÿ¨ÿØ€åÿØ',
    noEl:'⁄©ÿßÿ±ÿ™ ŸÖÿ¨ÿßÿ≤ ÿØ€å⁄Øÿ±€å ÿ±Ÿà€å ŸÖ€åÿ≤ ŸÜ€åÿ≥ÿ™!',
    bask:'ÿ¨ŸÅÿ™‚ÄåŸáÿß', turn:'ŸÜŸàÿ®ÿ™Ÿê __N__'
}};

let lang='en';
const PN=n=>String(n).replace(/\d/g,d=>'€∞€±€≤€≥€¥€µ€∂€∑€∏€π'[d]);
const N=n=>lang==='fa'?PN(n):String(n);
const t=k=>(L[lang]&&L[lang][k])||L.en[k]||k;

function setLang(l){
    lang=l;
    document.documentElement.lang=l;
    document.documentElement.dir=l==='fa'?'rtl':'ltr';
    document.querySelectorAll('.lang button').forEach(b=>{
        b.classList.toggle('on',(l==='fa'&&b.textContent.includes('ŸÅÿß'))||(l==='en'&&b.textContent==='EN'));
    });
    applyT();
}

function applyT(){
    const T=C.target;
    const r=(s,k)=>{const e=$(s);if(e)e.textContent=t(k).replace(/__T__/g,N(T));};
    r('t-title','title'); r('t-sub','sub'); r('t-tag','tag');
    r('t-ded','ded'); r('t-ded2','ded2'); r('t-set','set');
    r('t-tgt','tgt'); r('t-rule','rule'); r('t-pure','pure');
    r('t-mult','mult'); r('t-mode','mode'); r('t-classic','classic');
    r('t-rev','rev'); r('t-win','win'); r('t-fp','fp');
    r('t-tl','tl'); r('t-pr','pr'); r('t-mn','mn');
    r('t-pl','pl'); r('t-solo','solo'); r('t-2p','2p');
    r('t-str','str'); r('t-strd','strd'); r('t-on','on');
    r('t-off','off'); r('t-go','go');
    r('t-fc','fc'); r('t-ac','ac');
    r('tfl1','fl'); r('tfl2','fl'); r('tal1','al'); r('tal2','al');
    r('t-go2','over'); r('t-pa','pa'); r('t-ng','ng');
    updDesc();
    $('pV').textContent=N(C.targetPairs);
    $('tV').textContent=N(Math.round(C.timeLimit/60));
    // Update target pills display
    document.querySelectorAll('#tgt-pills .pill').forEach(b=>{
        b.textContent=N(+b.dataset.n);
    });
}

function updDesc(){
    const rd=$('rule-desc');
    if(rd) rd.textContent=t(C.rule==='pure'?'pureD':'multD').replace(/__T__/g,N(C.target));
    const md=$('mode-desc');
    if(md) md.textContent=t(C.mode==='classic'?'classicD':'revD');
}

/* ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê */
const C={target:7,rule:'pure',mode:'classic',winType:'pairs',targetPairs:5,timeLimit:120,players:2,streak:false};

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
const ST={phase:'setup',cp:1,sc:[0,0],pairs:[[],[]],fc:[],ac:[],selF:null,selA:null,ti:null,tr:0};

/* ‚ïê‚ïê‚ïê SETUP UI ‚ïê‚ïê‚ïê */
(function(){
    const w=$('tgt-pills');
    for(let n=2;n<=12;n++){
        const b=document.createElement('button');
        b.className='pill'+(n===7?' on':'');
        b.textContent=n;
        b.dataset.n=n;
        b.onclick=()=>{
            w.querySelectorAll('.pill').forEach(x=>x.classList.remove('on'));
            b.classList.add('on');
            C.target=n;
            updDesc();
        };
        w.appendChild(b);
    }
})();

function setS(btn){
    const s=btn.dataset.s, v=btn.dataset.v;
    btn.parentElement.querySelectorAll('.opt').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    switch(s){
        case'rule': C.rule=v; updDesc(); break;
        case'mode': C.mode=v; updDesc(); break;
        case'winType': C.winType=v;
            $('psl').classList.toggle('hid',v!=='pairs');
            $('tsl').classList.toggle('hid',v!=='time'); break;
        case'players': C.players=+v; break;
        case'streak': C.streak=v==='on'; break;
    }
}

/* ‚ïê‚ïê‚ïê CARD GENERATION ‚ïê‚ïê‚ïê */
function shuf(a){for(let i=a.length-1;i>0;i--){const j=Math.random()*i+1|0;[a[i],a[j]]=[a[j],a[i]];}return a;}

function genCards(){
    const tgt=C.target, rule=C.rule;
    const all=[];
    for(let a=2;a<=12;a++) for(let b=2;b<=12;b++) all.push({a,b,p:a*b});

    all.forEach(f=>{
        f.eligible = rule==='pure' ? f.a===tgt : f.p%tgt===0;
    });

    // Select eligible with unique products
    const byP={};
    all.filter(f=>f.eligible).forEach(f=>{
        if(!byP[f.p])byP[f.p]=[];
        byP[f.p].push(f);
    });
    const ups=shuf(Object.keys(byP).map(Number));
    const NE=Math.min(8,ups.length);
    const sel=[];
    for(let i=0;i<NE;i++){
        const fs=byP[ups[i]];
        sel.push({...fs[Math.random()*fs.length|0]});
    }

    // Distractor facts
    const ep=new Set(sel.map(f=>f.p));
    const inel=shuf(all.filter(f=>!f.eligible));
    const dist=[];
    for(const f of inel){
        if(dist.length>=16-NE) break;
        dist.push({...f});
    }

    const fc=shuf([...sel,...dist]).map((f,i)=>({
        id:i, a:f.a, b:f.b, p:f.p, eligible:f.eligible,
        flipped:C.mode==='reverse', collected:false
    }));

    // Answer cards
    const corr=[...ep];
    const cands=[];
    for(let a=2;a<=12;a++) for(let b=2;b<=12;b++){
        const p=a*b; if(!ep.has(p))cands.push(p);
    }
    const uniqC=[...new Set(shuf(cands))].slice(0,4);
    const ac=shuf([...corr,...uniqC]).map((v,i)=>({
        id:i, value:v, isCorr:corr.includes(v),
        flipped:C.mode==='classic', collected:false
    }));
    return{fc,ac};
}

/* ‚ïê‚ïê‚ïê GAME LOGIC ‚ïê‚ïê‚ïê */
function startGame(){
    const{fc,ac}=genCards();
    Object.assign(ST,{phase:'draw',cp:1,sc:[0,0],pairs:[[],[]],fc,ac,selF:null,selA:null,tr:0});
    if(C.winType==='time') ST.tr=C.timeLimit;
    show('G');
    render();
    updGame();
    if(C.winType==='time') startTmr();
}

function render(){
    // Fact grid
    const fg=$('fg'); fg.innerHTML='';
    ST.fc.forEach((c,i)=>fg.appendChild(mkCard(c,'fact',i)));
    // Answer grid
    const ag=$('ag'); ag.innerHTML='';
    ST.ac.forEach((c,i)=>ag.appendChild(mkCard(c,'ans',i)));

    // Player names
    $('pn1').textContent=C.players===1?t('player'):(t('player')+' '+N(1));
    $('pn2').textContent=t('player')+' '+N(2);
    $('pb2').classList.toggle('hid',C.players===1);
    $('bk2w').classList.toggle('hid',C.players===1);
    $('tmr').classList.toggle('hid',C.winType!=='time');

    $('bkt1').textContent=(C.players===1?t('player'):(t('player')+' '+N(1)))+(lang==='fa'?' '+t('bask'):'\'s '+t('bask'));
    $('bkt2').textContent=t('player')+' '+N(2)+(lang==='fa'?' '+t('bask'):'\'s '+t('bask'));
    clrTray();
}

function mkCard(c,type,idx){
    const el=document.createElement('div');
    el.className=`crd ${type}`;
    if(c.flipped) el.classList.add('flip');
    if(c.collected) el.classList.add('gone');

    const inner=document.createElement('div');
    inner.className='ci';
    const back=document.createElement('div');
    back.className='cf cb';
    const front=document.createElement('div');
    front.className='cf cff';

    if(type==='fact'){
        front.textContent=`${N(c.a)} √ó ${N(c.b)}`;
        el.onclick=()=>onFact(idx);
    } else {
        front.textContent=N(c.value);
        el.onclick=()=>onAns(idx);
    }
    inner.append(back,front);
    el.appendChild(inner);
    return el;
}

function gEl(type,idx){
    return $(type==='fact'?'fg':'ag').children[idx];
}

function onFact(idx){
    if(ST.phase!=='draw') return;
    const c=ST.fc[idx]; if(c.collected) return;
    ST.phase='busy'; ST.selF=idx;

    if(!c.flipped){ c.flipped=true; gEl('fact',idx).classList.add('flip'); }
    $('tf').textContent=`${N(c.a)} √ó ${N(c.b)}`;
    $('tf').classList.add('f');
    gEl('fact',idx).classList.add('sel');

    setTimeout(()=>{
        if(c.eligible){
            gEl('fact',idx).classList.add('elig');
            const k=C.rule==='pure'?'elig':'eligM';
            showMsg(t(k).replace(/__T__/g,N(C.target)),'g');
            ST.phase='match';
        } else {
            gEl('fact',idx).classList.add('nelig');
            const k=C.rule==='pure'?'nelig':'neligM';
            showMsg(t(k).replace(/__T__/g,N(C.target)),'b');
            setTimeout(()=>{
                c.flipped=C.mode==='reverse';
                const el=gEl('fact',idx);
                el.classList.remove('sel','elig','nelig');
                if(C.mode==='classic') el.classList.remove('flip');
                clrTray(); ST.selF=null;
                endTurn();
            },1200);
        }
    },450);
}

function onAns(idx){
    if(ST.phase!=='match') return;
    const ac=ST.ac[idx]; if(ac.collected) return;
    ST.phase='busy'; ST.selA=idx;

    if(!ac.flipped){ ac.flipped=true; gEl('ans',idx).classList.add('flip'); }
    $('ta').textContent=N(ac.value);
    $('ta').classList.add('f');
    gEl('ans',idx).classList.add('sel');

    setTimeout(()=>{
        const fc=ST.fc[ST.selF];
        const ok=ac.value===fc.p;

        if(ok){
            showMsg(t('ok'),'g');
            gEl('ans',idx).classList.add('cok');
            gEl('fact',ST.selF).classList.add('cok');
            setTimeout(()=>{
                fc.collected=true; ac.collected=true;
                gEl('fact',ST.selF).classList.add('cel');
                gEl('ans',idx).classList.add('cel');
                const pi=ST.cp-1;
                ST.sc[pi]++; ST.pairs[pi].push({a:fc.a,b:fc.b,p:fc.p});
                setTimeout(()=>{
                    gEl('fact',ST.selF).classList.add('gone');
                    gEl('ans',idx).classList.add('gone');
                    updScores(); updBaskets(); clrTray(); clean();
                    if(chkWin()) return;
                    if(chkNoEl()) return;
                    if(C.streak){
                        showMsg(t('bonus'),'i');
                        setTimeout(()=>{ST.phase='draw'; showDraw();},800);
                    } else endTurn();
                },400);
            },450);
        } else {
            let m=t('wrong').replace(/__A__/g,N(fc.a)).replace(/__B__/g,N(fc.b)).replace(/__P__/g,N(fc.p));
            showMsg(m,'b');
            gEl('ans',idx).classList.add('cbad','shk');
            gEl('fact',ST.selF).classList.add('shk');
            setTimeout(()=>{
                gEl('fact',ST.selF).classList.remove('sel','elig','cok','shk');
                gEl('ans',idx).classList.remove('sel','cok','cbad','shk');
                const fc2=ST.fc[ST.selF];
                fc2.flipped=C.mode==='reverse';
                if(C.mode==='classic') gEl('fact',ST.selF).classList.remove('flip');
                ac.flipped=C.mode==='classic';
                if(C.mode==='reverse') gEl('ans',idx).classList.remove('flip');
                clrTray(); clean();
                endTurn();
            },1400);
        }
    },550);
}

function clean(){ ST.selF=null; ST.selA=null; }

function endTurn(){
    if(C.players===2) ST.cp=ST.cp===1?2:1;
    updGame();
    setTimeout(()=>{ST.phase='draw'; showDraw();},500);
}

function showDraw(){
    showMsg(t(C.mode==='reverse'?'pickV':'pick'),'n');
}

function chkWin(){
    if(C.winType==='pairs'){
        for(let i=0;i<C.players;i++){
            if(ST.sc[i]>=C.targetPairs){ endGm(); return true; }
        }
    }
    return false;
}

function chkNoEl(){
    const rem=ST.fc.filter(c=>c.eligible&&!c.collected);
    const remA=ST.ac.filter(c=>!c.collected);
    let ok=false;
    for(const f of rem){ if(remA.some(a=>a.value===f.p)){ok=true;break;} }
    if(!ok){ showMsg(t('noEl'),'i'); setTimeout(()=>endGm(),1500); return true; }
    return false;
}

/* Timer */
function startTmr(){
    updTmrD();
    ST.ti=setInterval(()=>{
        ST.tr--;
        updTmrD();
        if(ST.tr<=0){ clearInterval(ST.ti); ST.ti=null; endGm(); }
    },1000);
}
function updTmrD(){
    const e=$('tmr');
    const m=Math.floor(ST.tr/60), s=ST.tr%60;
    e.textContent=`‚è± ${N(m)}:${s<10?'0':''}${N(s)}`;
    e.classList.toggle('low',ST.tr<=15);
}

/* End game */
function endGm(){
    ST.phase='over';
    if(ST.ti){clearInterval(ST.ti);ST.ti=null;}
    show('O');
    const s1=ST.sc[0],s2=ST.sc[1];
    const wt=$('wt');
    if(C.players===1){
        const w=C.winType==='pairs'?s1>=C.targetPairs:true;
        wt.textContent=t(w?'soloW':'soloL');
        wt.style.color=w?'var(--success)':'var(--red)';
    } else {
        if(s1>s2){
            wt.textContent=t('wins').replace(/__N__/g,t('player')+' '+N(1));
            wt.style.color='var(--p1)';
        } else if(s2>s1){
            wt.textContent=t('wins').replace(/__N__/g,t('player')+' '+N(2));
            wt.style.color='var(--p2)';
        } else {
            wt.textContent=t('draw'); wt.style.color='var(--text)';
        }
    }
    let h=`<div class="fsb p1"><div class="fn">${C.players===1?t('player'):(t('player')+' '+N(1))}</div>
        <div class="fm">${'‚ô™'.repeat(s1)||'‚Äî'}</div><div class="fc">${N(s1)} ${t('pr')}</div></div>`;
    if(C.players===2) h+=`<div class="fsb p2"><div class="fn">${t('player')+' '+N(2)}</div>
        <div class="fm">${'‚ô™'.repeat(s2)||'‚Äî'}</div><div class="fc">${N(s2)} ${t('pr')}</div></div>`;
    $('fsc').innerHTML=h;
}

function back(){
    ST.phase='setup';
    if(ST.ti){clearInterval(ST.ti);ST.ti=null;}
    show('S');
}

/* ‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê */
function show(id){
    document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
    $(id).classList.add('on');
}

function showMsg(txt,cls){ const e=$('msg'); e.textContent=txt; e.className='msg '+cls; }

function clrTray(){
    $('tf').innerHTML=`<span style="font-size:0.65rem">${t('fl')}</span>`;
    $('tf').classList.remove('f');
    $('ta').innerHTML=`<span style="font-size:0.65rem">${t('al')}</span>`;
    $('ta').classList.remove('f');
}

function updGame(){
    $('pb1').classList.toggle('cur',ST.cp===1);
    $('pb2').classList.toggle('cur',ST.cp===2);
    updScores();
    if(C.players===2){
        const nm=t('player')+' '+N(ST.cp);
        showMsg(t('turn').replace(/__N__/g,nm),'n');
    } else showDraw();
}

function updScores(){
    $('pm1').textContent='‚ô™'.repeat(ST.sc[0])||'‚Äî';
    $('pm2').textContent='‚ô™'.repeat(ST.sc[1])||'‚Äî';
}

function updBaskets(){
    for(let p=0;p<2;p++){
        $(`bkp${p+1}`).innerHTML=ST.pairs[p].map(pr=>
            `<span class="bk-c">${N(pr.a)}√ó${N(pr.b)}=${N(pr.p)}</span>`
        ).join('');
    }
}

applyT();
</script>
</body>
</html>
