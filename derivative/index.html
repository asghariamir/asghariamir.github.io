<!DOCTYPE html>
<head>
<link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
<link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivative Explorer: The Fundamental Connection</title>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --brand: #0f766e;
            --brand-light: #10b981;
            --accent: #f59e0b;
            --bg: #f7faf9;
            --card: #ffffff;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --present-moment: rgba(59, 130, 246, 0.15);
            --increasing: rgba(16, 185, 129, 0.15);
            --decreasing: rgba(239, 68, 68, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #f7faf9 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Header Section */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(165deg, #e6fffb 0%, #fdfcf7 25%, rgba(245, 158, 11, 0.05) 100%);
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(15, 118, 110, 0.05) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-20px, -20px) rotate(1deg); }
            66% { transform: translate(20px, -10px) rotate(-1deg); }
        }

        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            position: relative;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: #f9fafb;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            color: white;
            box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            opacity: 0;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Card */
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .main-card h2 {
            color: var(--brand);
            margin-bottom: 1rem;
            font-size: 1.6rem;
        }

        .main-card > p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            line-height: 1.7;
        }

        /* Animation Controls */
        .animation-controls {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fbbf24;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .animation-controls label {
            font-weight: 600;
            color: #d97706;
        }

        .animation-btn {
            padding: 0.5rem 1rem;
            background: white;
            color: #d97706;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .animation-btn:hover {
            background: #fbbf24;
            color: white;
            transform: translateY(-1px);
        }

        .animation-btn.active {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        .animation-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Canvas Container */
        .canvas-wrapper {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 16px;
            overflow: hidden;
            margin: 2rem 0;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .canvas-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .present-moment {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 48%;
            width: 4%;
            background: var(--present-moment);
            border-left: 2px solid rgba(59, 130, 246, 0.3);
            border-right: 2px solid rgba(59, 130, 246, 0.3);
            pointer-events: none;
            z-index: 10;
            backdrop-filter: blur(2px);
        }

        .present-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 15;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .canvas-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--brand);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 20;
            backdrop-filter: blur(10px);
        }

        /* Time Display for Tab 3 */
        .time-display-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(249, 250, 251, 0.98));
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 25;
            min-width: 150px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.3);
        }

        .time-display {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            text-align: center;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            text-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .time-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Paper Control Slider */
        .paper-control {
            position: relative;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .paper-control-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .paper-control-header h4 {
            color: var(--brand);
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .paper-control-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .speed-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #d97706;
        }

        .paper-slider-container {
            position: relative;
            height: 60px;
            display: flex;
            align-items: center;
        }

        .paper-slider {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #e5e7eb 0%, var(--brand) 50%, #e5e7eb 100%);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: grab;
        }

        .paper-slider:active {
            cursor: grabbing;
        }

        .paper-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--brand);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .paper-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--brand);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .paper-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .paper-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .paper-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Info Display */
        .info-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(15, 118, 110, 0.02));
            border-radius: 12px;
            border: 1px solid #d1fae5;
        }

        .info-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--brand);
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
        }

        .info-value.velocity {
            color: var(--accent);
        }

        .info-value.acceleration {
            color: #8b5cf6;
        }

        .info-description {
            font-size: 0.9rem;
            color: var(--text);
            margin-top: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem 0.5rem; }
            .header { padding: 1.5rem 1rem; }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 1rem; }
            .tabs { 
                flex-direction: column; 
                gap: 0.5rem;
            }
            .tab-btn { min-width: auto; }
            .main-card { padding: 1.5rem; }
            .info-display { 
                grid-template-columns: 1fr 1fr; 
                padding: 1rem;
            }
            .canvas-container { height: 300px; }
            .animation-controls {
                flex-direction: column;
                align-items: stretch;
            }
            /* Stack dual view on mobile */
            #two-views .main-card > div:first-of-type {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .info-display { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
    <!-- Mathswell app navbar styles -->
<style>
  .mathswell-nav {
    display: flex;
    justify-content: center;
    margin: .4rem 0 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .mathswell-nav .mw-link {
    display: inline-flex;
    align-items: center;
    gap: .45rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
    color: #0f766e;
    padding: .3rem .7rem;
    border-radius: 999px;
    background: rgba(255,255,255,.9);
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
  }
  .mathswell-nav .mw-link img {
    display: block;
  }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>The Derivative: Two Views, One Truth</h1>
             <!-- Mathswell brand badge -->
<div style="display:flex;justify-content:center;margin:.75rem 0 1rem;
            position:relative;z-index:1001;">
  <a href="/" style="display:inline-flex;align-items:center;gap:.5rem;
      text-decoration:none;font-weight:800;font-size:1.05rem;color:#0f766e;
      padding:.4rem .8rem;border-radius:999px;background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,.08);">
    <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28" style="display:block">
    <span>MATHSWELL</span>
  </a>
</div>
            <p>Discover the fundamental connection: <strong>instantaneous velocity equals the slope of the tangent line</strong>.</p>
            <p style="margin-top: 1rem; font-size: 0.9rem; font-style: italic;">
                Inspired by W.W. Sawyer's 
                <a href="https://archive.org/details/W.W.SawyerWhatIsCalculusAbout" target="_blank" style="color: var(--brand); text-decoration: underline;">
                    "What Is Calculus About?"
                </a> 
                and his moving paper visualization
            </p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="motion-creates">Motion Creates Graph</button>
            <button class="tab-btn" data-tab="graph-controls">Graph Controls Motion</button>
            <button class="tab-btn" data-tab="two-views">Interactive Explorer</button>
        </div>

        <div id="motion-creates" class="tab-content active">
            <div class="main-card">
                <h2>Motion Creates History on Moving Paper</h2>
                <p>Like a seismograph recording earthquake motion, the pen stays fixed at the <strong>present moment</strong> while paper scrolls rightward. The trace accumulates in the past (leftward) as the paper carries each mark away.</p>
                <p style="margin-top: 0.5rem; font-size: 0.95rem; color: var(--text-muted); font-style: italic;">
                    "If the object has a steady speed, its trail will be a straight line." - W.W. Sawyer
                </p>
                
                <div class="animation-controls">
                    <label>Animation:</label>
                    <button class="animation-btn" id="mc-start-btn">Start</button>
                    <button class="animation-btn" id="mc-pause-btn">Pause</button>
                    <button class="animation-btn" id="mc-reset-btn">Reset</button>
                    <span style="margin-left: auto; font-size: 0.9rem; color: #92400e;">Paper scrolls continuously through time</span>
                </div>
                
                <div class="canvas-wrapper">
                    <div class="canvas-label">Paper moves ‚Üí Trace forms ‚Üê</div>
                    <div class="canvas-container">
                        <div class="present-moment">
                            <div class="present-label">NOW</div>
                        </div>
                        <canvas id="motion-canvas"></canvas>
                    </div>
                </div>
                
                <div class="paper-control">
                    <div class="paper-control-header">
                        <h4>Manual Time Control</h4>
                        <p>Drag to move paper through time manually</p>
                    </div>
                    <div class="speed-warning">
                        Note: Velocity calculation assumes steady paper movement speed
                    </div>
                    <div class="paper-slider-container">
                        <input type="range" class="paper-slider" id="mc-paper-slider" min="-20" max="20" step="0.01" value="0">
                    </div>
                    <div class="paper-info">
                        <span>‚Üê Past</span>
                        <span><strong>Drag to scroll through time continuously</strong></span>
                        <span>Future ‚Üí</span>
                    </div>
                </div>
                
                <div class="info-display">
                    <div class="info-item">
                        <div class="info-label">Position s(t)</div>
                        <div class="info-value" id="mc-position">0.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Velocity = Slope</div>
                        <div class="info-value velocity" id="mc-velocity">0.00</div>
                        <div class="info-description" id="mc-vel-desc">Changing</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Acceleration</div>
                        <div class="info-value acceleration" id="mc-acceleration">0.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time t</div>
                        <div class="info-value" id="mc-time">0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="graph-controls" class="tab-content">
            <div class="main-card">
                <h2>Pre-existing Graph on Moving Paper</h2>
                <p>A previously drawn graph moves with the paper. The point follows the graph at the present moment, and its <strong>velocity equals the tangent slope</strong>.</p>
                <p style="margin-top: 0.5rem; font-size: 0.95rem; color: var(--text-muted); font-style: italic;">
                    "We can see the curves; details appear in the curves that might not be apparent in the actual movement." - W.W. Sawyer
                </p>
                
                <div class="animation-controls">
                    <label>Animation:</label>
                    <button class="animation-btn" id="gc-start-btn">Start</button>
                    <button class="animation-btn" id="gc-pause-btn">Pause</button>
                    <button class="animation-btn" id="gc-reset-btn">Reset</button>
                    <span style="margin-left: auto; font-size: 0.9rem; color: #92400e;">Graph extends infinitely in both directions</span>
                </div>
                
                <div class="canvas-wrapper">
                    <div class="canvas-label">Graph moves with paper</div>
                    <div class="canvas-container">
                        <div class="present-moment">
                            <div class="present-label">NOW</div>
                        </div>
                        <canvas id="graph-canvas"></canvas>
                    </div>
                </div>
                
                <div class="paper-control">
                    <div class="paper-control-header">
                        <h4>Manual Time Control</h4>
                        <p>Drag to see how the point follows the graph</p>
                    </div>
                    <div class="speed-warning">
                        Note: Velocity reading depends on steady drag speed
                    </div>
                    <div class="paper-slider-container">
                        <input type="range" class="paper-slider" id="gc-paper-slider" min="-20" max="20" step="0.01" value="0">
                    </div>
                    <div class="paper-info">
                        <span>‚Üê Move paper left</span>
                        <span><strong>Paper scrolls infinitely through time</strong></span>
                        <span>Move paper right ‚Üí</span>
                    </div>
                </div>
                
                <div class="info-display">
                    <div class="info-item">
                        <div class="info-label">Position s(t)</div>
                        <div class="info-value" id="gc-position">0.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Velocity = Slope</div>
                        <div class="info-value velocity" id="gc-velocity">0.00</div>
                        <div class="info-description" id="gc-vel-desc">Changing</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Curvature (Accel)</div>
                        <div class="info-value acceleration" id="gc-acceleration">0.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time t</div>
                        <div class="info-value" id="gc-time">0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="two-views" class="tab-content">
            <div class="main-card">
                <h2>Explore the Connection</h2>
                <p>Move through time to discover how slope and velocity are one and the same, viewed from different perspectives. The static graph shows the traditional view, while the moving paper shows Sawyer's dynamic visualization.</p>
                
                <!-- Dual View Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <!-- Static Graph -->
                    <div class="canvas-wrapper">
                        <div class="canvas-label" style="background: rgba(239, 68, 68, 0.9); color: white;">Textbook View</div>
                        <div class="canvas-container">
                            <canvas id="static-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Moving Paper Graph -->
                    <div class="canvas-wrapper">
                        <div class="time-display-panel">
                            <div class="time-label">Current Time</div>
                            <div class="time-display" id="current-time">0.00</div>
                        </div>
                        <div class="canvas-label" style="background: rgba(15, 118, 110, 0.9); color: white;">Sawyer's View</div>
                        <div class="canvas-container">
                            <div class="present-moment">
                                <div class="present-label">NOW</div>
                            </div>
                            <canvas id="explorer-canvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Unified Control -->
                <div class="paper-control" style="margin-top: 1.5rem;">
                    <div class="paper-control-header">
                        <h4>Explore Through Time</h4>
                        <p>Move the slider to see how the same moment appears in both views</p>
                    </div>
                    <div class="paper-slider-container">
                        <input type="range" class="paper-slider" id="explorer-slider" min="-10" max="10" step="0.01" value="0">
                    </div>
                    <div class="paper-info">
                        <span>‚Üê Past</span>
                        <span><strong>t = <span id="slider-time">0.00</span></strong></span>
                        <span>Future ‚Üí</span>
                    </div>
                </div>

                <div class="info-display">
                    <div class="info-item">
                        <div class="info-label">Position s(t)</div>
                        <div class="info-value" id="explorer-position">0.00</div>
                        <div class="info-description" id="position-desc">Height on graph</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Velocity = Slope</div>
                        <div class="info-value velocity" id="explorer-velocity">0.00</div>
                        <div class="info-description" id="velocity-desc">Rate of change</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Acceleration</div>
                        <div class="info-value acceleration" id="explorer-acceleration">0.00</div>
                        <div class="info-description" id="acceleration-desc">How velocity changes</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Motion Type</div>
                        <div class="info-value" id="explorer-behavior" style="font-size: 1rem;">---</div>
                        <div class="info-description" id="behavior-desc">What's happening</div>
                    </div>
                </div>
                
                <div id="exploration-content" style="margin-top: 2rem;">
                    <!-- Dynamic exploration content -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button id="new-function-btn" style="padding: 0.75rem 2rem; background: white; color: var(--brand); border: 2px solid var(--brand); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;">
                        Try a Different Function
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// Single comprehensive motion function
const MOTION = {
    f: t => Math.sin(t * 0.8) + 0.05 * t * t - 0.3 * t,
    df: t => 0.8 * Math.cos(t * 0.8) + 0.1 * t - 0.3,
    d2f: t => -0.64 * Math.sin(t * 0.8) + 0.1,
    desc: t => {
        const v = 0.8 * Math.cos(t * 0.8) + 0.1 * t - 0.3;
        const a = -0.64 * Math.sin(t * 0.8) + 0.1;
        if (Math.abs(v) < 0.05) return 'Near rest';
        if (v > 0 && a > 0) return 'Rising & accelerating';
        if (v > 0 && a < 0) return 'Rising & decelerating';
        if (v < 0 && a < 0) return 'Falling & accelerating';
        return 'Falling & decelerating';
    }
};

// Generate random functions for challenges
function generateRandomFunction() {
    const a = 0.5 + Math.random() * 1;
    const b = 0.05 + Math.random() * 0.1;
    const c = -0.5 + Math.random();
    const freq = 0.5 + Math.random() * 0.5;
    
    return {
        f: t => a * Math.sin(t * freq) + b * t * t + c * t,
        df: t => a * freq * Math.cos(t * freq) + 2 * b * t + c,
        d2f: t => -a * freq * freq * Math.sin(t * freq) + 2 * b
    };
}

// Base Canvas Manager
class CanvasManager {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.defaultWidth = 800;
        this.defaultHeight = 400;
        this.setupCanvas();
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => this.setupCanvas(), 250);
        });
    }
    
    setupCanvas() {
        const rect = this.canvas.parentElement.getBoundingClientRect();
        let width = rect.width;
        let height = rect.height;
        
        if (!width || width === 0) {
            width = this.defaultWidth;
        }
        if (!height || height === 0) {
            height = this.defaultHeight;
        }
        
        const dpr = window.devicePixelRatio || 1;
        this.canvas.width = width * dpr;
        this.canvas.height = height * dpr;
        
        this.ctx.setTransform(1, 0, 0, 1, 0, 0);
        this.ctx.scale(dpr, dpr);
        
        this.width = width;
        this.height = height;
        
        if (rect.width > 0) {
            this.defaultWidth = rect.width;
            this.defaultHeight = rect.height;
        }
    }
    
    clear() {
        this.ctx.clearRect(0, 0, this.width, this.height);
    }
    
    drawGrid(offsetX = 0) {
        this.ctx.strokeStyle = '#e5e7eb';
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();
        
        const spacing = 40;
        
        for (let i = -50; i <= 50; i++) {
            const x = this.width/2 + i * spacing + offsetX;
            if (x >= 0 && x <= this.width) {
                this.ctx.moveTo(x, 0);
                this.ctx.lineTo(x, this.height);
            }
        }
        
        for (let y = 0; y < this.height; y += spacing) {
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(this.width, y);
        }
        
        this.ctx.stroke();
        
        this.ctx.strokeStyle = '#6b7280';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.moveTo(0, this.height/2);
        this.ctx.lineTo(this.width, this.height/2);
        this.ctx.stroke();
        
        this.ctx.strokeStyle = 'rgba(107, 114, 128, 0.3)';
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();
        this.ctx.moveTo(this.width/2, 0);
        this.ctx.lineTo(this.width/2, this.height);
        this.ctx.stroke();
    }
}

// Motion Creates Graph Animation (Tab 1)
class MotionCreatesAnimation {
    constructor(canvas) {
        this.manager = new CanvasManager(canvas);
        this.motion = MOTION;
        this.paperPosition = 0;
        this.trail = [];
        this.maxTrailLength = 500;
        this.paperSpeed = 30;
        this.animationId = null;
        this.isAnimating = false;
        this.animate();
    }
    
    setPaperPosition(pos) {
        this.paperPosition = parseFloat(pos);
        this.updateTrail();
        this.draw();
    }
    
    updateTrail() {
        const time = this.paperPosition;
        const y = this.motion.f(time);
        
        this.trail.push({ t: time, y: y });
        this.trail = this.trail.filter(pt => pt.t <= time);
        
        if (this.trail.length > this.maxTrailLength) {
            this.trail = this.trail.slice(-this.maxTrailLength);
        }
    }
    
    start() {
        this.isAnimating = true;
    }
    
    pause() {
        this.isAnimating = false;
    }
    
    reset() { 
        this.paperPosition = 0;
        this.trail = [];
        this.isAnimating = false;
        document.getElementById('mc-paper-slider').value = 0;
        this.draw();
    }
    
    animate() {
        if (this.isAnimating) {
            this.paperPosition += 0.02;
            document.getElementById('mc-paper-slider').value = this.paperPosition;
            this.updateTrail();
        }
        
        this.draw();
        this.animationId = requestAnimationFrame(() => this.animate());
    }
    
    draw() {
        const ctx = this.manager.ctx;
        const w = this.manager.width;
        const h = this.manager.height;
        const scale = 50;
        const presentX = w * 0.5;
        
        const time = this.paperPosition;
        const y = this.motion.f(time);
        const dy = this.motion.df(time);
        const d2y = this.motion.d2f(time);
        
        this.manager.clear();
        
        const gridOffset = time * this.paperSpeed;
        this.manager.drawGrid(gridOffset);
        
        const drawWidth = this.isAnimating ? presentX : w;
        
        if (this.trail.length > 1) {
            ctx.beginPath();
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            let firstPoint = true;
            for (let i = 0; i < this.trail.length; i++) {
                const pt = this.trail[i];
                const x = presentX - (time - pt.t) * this.paperSpeed;
                const py = h/2 - pt.y * scale;
                
                if (x >= -50 && x <= drawWidth) {
                    if (firstPoint) {
                        ctx.moveTo(x, py);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, py);
                    }
                }
            }
            ctx.stroke();
        }
        
        const pointY = h/2 - y * scale;
        
        const len = 100;
        const timeSpan = len / this.paperSpeed;
        const yChange = dy * timeSpan;
        const screenDy = yChange * scale;
        
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.setLineDash([5, 5]);
        ctx.moveTo(presentX - len, pointY + screenDy);
        ctx.lineTo(presentX + len, pointY - screenDy);
        ctx.stroke();
        ctx.restore();
        
        ctx.save();
        ctx.shadowColor = '#dc2626';
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(presentX, pointY, 10, 0, 2*Math.PI);
        ctx.fillStyle = '#dc2626';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
        
        document.getElementById('mc-position').textContent = y.toFixed(2);
        document.getElementById('mc-velocity').textContent = dy.toFixed(2);
        document.getElementById('mc-acceleration').textContent = d2y.toFixed(2);
        document.getElementById('mc-time').textContent = time.toFixed(2);
        document.getElementById('mc-vel-desc').textContent = this.motion.desc(time);
    }
    
    destroy() {
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
        }
    }
}

// Graph Controls Motion Animation (Tab 2)
class GraphControlsAnimation {
    constructor(canvas) {
        this.manager = new CanvasManager(canvas);
        this.motion = MOTION;
        this.paperPosition = 0;
        this.paperSpeed = 30;
        this.animationId = null;
        this.isAnimating = false;
        this.animate();
    }
    
    setPaperPosition(pos) {
        this.paperPosition = parseFloat(pos);
        this.draw();
    }
    
    start() {
        this.isAnimating = true;
    }
    
    pause() {
        this.isAnimating = false;
    }
    
    reset() {
        this.paperPosition = 0;
        this.isAnimating = false;
        document.getElementById('gc-paper-slider').value = 0;
        this.draw();
    }
    
    animate() {
        if (this.isAnimating) {
            this.paperPosition += 0.02;
            document.getElementById('gc-paper-slider').value = this.paperPosition;
        }
        
        this.draw();
        this.animationId = requestAnimationFrame(() => this.animate());
    }
    
    draw() {
        const ctx = this.manager.ctx;
        const w = this.manager.width;
        const h = this.manager.height;
        const scale = 50;
        const presentX = w * 0.5;
        
        const time = this.paperPosition;
        const y = this.motion.f(time);
        const dy = this.motion.df(time);
        const d2y = this.motion.d2f(time);
        
        this.manager.clear();
        
        const gridOffset = time * this.paperSpeed;
        this.manager.drawGrid(gridOffset);
        
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        let firstPoint = true;
        for (let i = 0; i <= 400; i++) {
            const t = time - 20 + i * 0.1;
            const x = presentX - (t - time) * this.paperSpeed;
            const fy = h/2 - this.motion.f(t) * scale;
            
            if (x >= -100 && x <= w + 100) {
                if (firstPoint) {
                    ctx.moveTo(x, fy);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, fy);
                }
            }
        }
        ctx.stroke();
        ctx.restore();
        
        const pointY = h/2 - y * scale;
        
        const len = 120;
        const screenSlope = dy * scale / this.paperSpeed;
        
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.setLineDash([5, 5]);
        ctx.moveTo(presentX - len, pointY - screenSlope * len);
        ctx.lineTo(presentX + len, pointY + screenSlope * len);
        ctx.stroke();
        ctx.restore();
        
        ctx.save();
        ctx.shadowColor = '#dc2626';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(presentX, pointY, 10, 0, 2*Math.PI);
        ctx.fillStyle = '#dc2626';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
        
        document.getElementById('gc-position').textContent = y.toFixed(2);
        document.getElementById('gc-velocity').textContent = dy.toFixed(2);
        document.getElementById('gc-time').textContent = time.toFixed(2);
        document.getElementById('gc-vel-desc').textContent = this.motion.desc(time);
        document.getElementById('gc-acceleration').textContent = d2y.toFixed(2);
    }
    
    destroy() {
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
        }
    }
}

// Fixed Interactive Explorer
class InteractiveExplorer {
    constructor(explorerCanvas, staticCanvas) {
        this.manager = new CanvasManager(explorerCanvas);
        this.staticManager = new CanvasManager(staticCanvas);  // Add manager for static canvas
        this.currentFunction = generateRandomFunction();
        this.paperPosition = 0;
        this.animationId = null;
        this.selectedCategory = null;
        this.score = 0;
        this.totalQuestions = 0;
        this.questionMode = 'intro';
        this.currentQuestion = null;
        this.attemptsOnCurrentQuestion = 0;
        this.intervalWindowOpen = false;
        this.selectedInterval = [-2, 2];
        
        this.animate();
        this.updateInfo(); // Update initial values to match the graph
        this.generateNewQuestion();
    }
    
    createIntervalWindow() {
        const windowHtml = `
            <div id="interval-window" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 500px; background: white; border: 2px solid var(--brand); border-radius: 12px;
                    padding: 1.5rem; z-index: 1000; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="color: var(--brand); margin: 0;">Interval Analysis</h4>
                    <button onclick="explorer.closeIntervalWindow()" 
                            style="padding: 0.25rem 0.5rem; background: white; color: var(--text-muted);
                                   border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                        ‚úï
                    </button>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                        Select interval to analyze:
                    </label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="interval-start" value="-2" step="0.5" 
                               style="width: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                        <span>to</span>
                        <input type="number" id="interval-end" value="2" step="0.5"
                               style="width: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                        <button onclick="explorer.analyzeInterval()" 
                                style="padding: 0.5rem 1rem; background: var(--brand); color: white;
                                       border: none; border-radius: 6px; cursor: pointer;">
                            Analyze
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button onclick="explorer.setIntervalPreset(-10, -5)" 
                            style="padding: 0.4rem 0.8rem; background: #f3f4f6; border: 1px solid var(--border);
                                   border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                        Far Past
                    </button>
                    <button onclick="explorer.setIntervalPreset(-2, 2)" 
                            style="padding: 0.4rem 0.8rem; background: #f3f4f6; border: 1px solid var(--border);
                                   border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                        Near Origin
                    </button>
                    <button onclick="explorer.setIntervalPreset(5, 10)" 
                            style="padding: 0.4rem 0.8rem; background: #f3f4f6; border: 1px solid var(--border);
                                   border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                        Far Future
                    </button>
                </div>
                
                <canvas id="interval-canvas" width="460" height="200" 
                        style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;"></canvas>
                
                <div id="interval-analysis" style="padding: 1rem; background: #f9fafb; border-radius: 8px;
                                                   font-size: 0.9rem; color: var(--text-muted);">
                    Select an interval to see its analysis...
                </div>
            </div>
        `;
        
        // Add to body if not already there
        if (!document.getElementById('interval-window')) {
            const div = document.createElement('div');
            div.innerHTML = windowHtml;
            document.body.appendChild(div.firstElementChild);
        }
    }
    
    showIntervalWindow() {
        const window = document.getElementById('interval-window');
        if (window) {
            window.style.display = 'block';
            this.intervalWindowOpen = true;
            this.analyzeInterval();
        }
    }
    
    closeIntervalWindow() {
        const window = document.getElementById('interval-window');
        if (window) {
            window.style.display = 'none';
            this.intervalWindowOpen = false;
        }
    }
    
    setIntervalPreset(start, end) {
        document.getElementById('interval-start').value = start;
        document.getElementById('interval-end').value = end;
        this.analyzeInterval();
    }
    
    analyzeInterval() {
        const start = parseFloat(document.getElementById('interval-start').value);
        const end = parseFloat(document.getElementById('interval-end').value);
        
        if (isNaN(start) || isNaN(end) || start >= end) {
            document.getElementById('interval-analysis').innerHTML = 
                '<span style="color: var(--error);">Please enter a valid interval with start < end</span>';
            return;
        }
        
        this.selectedInterval = [start, end];
        
        // Draw the interval graph
        const canvas = document.getElementById('interval-canvas');
        if (canvas) {
            this.drawIntervalGraph(canvas, start, end);
        }
        
        // Analyze the interval
        const samples = 100;
        const points = [];
        let minV = Infinity, maxV = -Infinity;
        let minA = Infinity, maxA = -Infinity;
        let criticalPoints = [];
        let inflectionPoints = [];
        
        for (let i = 0; i <= samples; i++) {
            const t = start + (end - start) * i / samples;
            const v = this.currentFunction.df(t);
            const a = this.currentFunction.d2f(t);
            
            points.push({ t, v, a });
            
            minV = Math.min(minV, v);
            maxV = Math.max(maxV, v);
            minA = Math.min(minA, a);
            maxA = Math.max(maxA, a);
            
            if (Math.abs(v) < 0.1) {
                criticalPoints.push(t);
            }
        }
        
        // Check for sign changes
        for (let i = 1; i < points.length; i++) {
            if (points[i-1].a * points[i].a < 0) {
                inflectionPoints.push(points[i].t);
            }
        }
        
        // Generate analysis text
        let analysis = '<div style="color: var(--text);">';
        analysis += `<strong>Interval: [${start.toFixed(1)}, ${end.toFixed(1)}]</strong><br><br>`;
        
        // Monotonicity
        if (minV > 0.05) {
            analysis += 'üìà <strong>Strictly increasing</strong> throughout<br>';
        } else if (maxV < -0.05) {
            analysis += 'üìâ <strong>Strictly decreasing</strong> throughout<br>';
        } else {
            analysis += 'üìä <strong>Mixed behavior</strong> (both increasing and decreasing)<br>';
            if (criticalPoints.length > 0) {
                analysis += `&nbsp;&nbsp;&nbsp;Critical points near: ${criticalPoints.slice(0, 3).map(t => t.toFixed(1)).join(', ')}<br>`;
            }
        }
        
        // Concavity
        analysis += '<br>';
        if (minA > 0.05) {
            analysis += '‚åí <strong>Concave up</strong> throughout<br>';
        } else if (maxA < -0.05) {
            analysis += '‚åí <strong>Concave down</strong> throughout<br>';
        } else {
            analysis += '„Ä∞Ô∏è <strong>Mixed concavity</strong><br>';
            if (inflectionPoints.length > 0) {
                analysis += `&nbsp;&nbsp;&nbsp;Inflection near: ${inflectionPoints.slice(0, 3).map(t => t.toFixed(1)).join(', ')}<br>`;
            }
        }
        
        // Speed info
        analysis += '<br>';
        analysis += `<strong>Velocity range:</strong> [${minV.toFixed(2)}, ${maxV.toFixed(2)}]<br>`;
        analysis += `<strong>Max speed:</strong> ${Math.max(Math.abs(minV), Math.abs(maxV)).toFixed(2)}<br>`;
        
        analysis += '</div>';
        
        document.getElementById('interval-analysis').innerHTML = analysis;
    }
    
    drawIntervalGraph(canvas, start, end) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        
        // Clear
        ctx.clearRect(0, 0, w, h);
        
        // Find y-range for scaling
        let minY = Infinity, maxY = -Infinity;
        const samples = 100;
        for (let i = 0; i <= samples; i++) {
            const t = start + (end - start) * i / samples;
            const y = this.currentFunction.f(t);
            minY = Math.min(minY, y);
            maxY = Math.max(maxY, y);
        }
        
        const yRange = maxY - minY;
        const yPadding = yRange * 0.1;
        minY -= yPadding;
        maxY += yPadding;
        
        // Draw axes
        ctx.strokeStyle = '#6b7280';
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        // If zero is in range, draw x-axis
        if (minY <= 0 && maxY >= 0) {
            const zeroY = h - (0 - minY) / (maxY - minY) * h;
            ctx.moveTo(0, zeroY);
            ctx.lineTo(w, zeroY);
        }
        
        ctx.stroke();
        
        // Draw function
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        for (let i = 0; i <= samples; i++) {
            const t = start + (end - start) * i / samples;
            const y = this.currentFunction.f(t);
            const x = i / samples * w;
            const py = h - (y - minY) / (maxY - minY) * h;
            
            if (i === 0) {
                ctx.moveTo(x, py);
            } else {
                ctx.lineTo(x, py);
            }
        }
        ctx.stroke();
        
        // Draw current position if in range
        if (this.paperPosition >= start && this.paperPosition <= end) {
            const currentX = (this.paperPosition - start) / (end - start) * w;
            const currentY = this.currentFunction.f(this.paperPosition);
            const currentPY = h - (currentY - minY) / (maxY - minY) * h;
            
            ctx.beginPath();
            ctx.arc(currentX, currentPY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#dc2626';
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // Labels
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px sans-serif';
        ctx.fillText(start.toFixed(1), 5, h - 5);
        ctx.fillText(end.toFixed(1), w - 25, h - 5);
    }
    
    setPaperPosition(pos) {
        this.paperPosition = parseFloat(pos);
        this.updateInfo();
    }
    
    generateNew() {
        this.currentFunction = generateRandomFunction();
        this.paperPosition = 0;
        this.score = 0;
        this.totalQuestions = 0;
        this.selectedCategory = null;
        this.questionMode = 'intro';
        this.attemptsOnCurrentQuestion = 0;
        document.getElementById('explorer-slider').value = 0;
        this.updateInfo(); // Update values for new function
        this.generateNewQuestion();
    }
    
    generateNewQuestion() {
        const container = document.getElementById('exploration-content');
        if (!container) return;
        
        this.attemptsOnCurrentQuestion = 0; // Reset attempts for new question
        
        if (this.questionMode === 'intro') {
            this.showIntroduction(container);
        } else {
            if (!this.selectedCategory) {
                this.showCategorySelection(container);
            } else {
                this.generateCategoryQuestion(container);
            }
        }
    }
    
    showIntroduction(container) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #e6fffb 0%, #f0fdf4 100%); 
                        padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--brand);">
                <h3 style="color: var(--brand); margin-bottom: 1rem;">Welcome to Interactive Exploration!</h3>
                <p style="margin-bottom: 1rem;">Discover how <strong>slope = velocity</strong> and <strong>curvature = acceleration</strong>.</p>
                <ul style="list-style: none; padding-left: 1rem;">
                    <li style="margin-bottom: 0.5rem;">‚Ä¢ The <strong>tangent line's slope</strong> shows how fast the object moves</li>
                    <li style="margin-bottom: 0.5rem;">‚Ä¢ The <strong>curve's bend</strong> shows how velocity changes</li>
                    <li style="margin-bottom: 0.5rem;">‚Ä¢ Move the slider to explore different moments in time</li>
                </ul>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button onclick="explorer.startQuestions()" 
                            style="padding: 0.75rem 2rem; background: var(--brand); color: white; 
                                   border: none; border-radius: 8px; font-size: 1rem; 
                                   font-weight: 600; cursor: pointer;">
                        Begin Exploration
                    </button>
                </div>
            </div>
        `;
    }
    
    startQuestions() {
        this.questionMode = 'active';
        this.generateNewQuestion();
    }
    
    showCategorySelection(container) {
        container.innerHTML = `
            <div style="background: white; border: 2px solid var(--brand); 
                        border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: var(--brand); margin-bottom: 1rem;">Choose Your Exploration Mode</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Select how you'd like to explore the derivative at this moment (t = ${this.paperPosition.toFixed(2)}):
                </p>
                
                <div style="display: grid; gap: 1rem;">
                    <button onclick="explorer.selectCategory('local')" 
                            style="padding: 1rem; background: white; border: 2px solid var(--border); 
                                   border-radius: 8px; cursor: pointer; text-align: left; 
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.borderColor='var(--brand)'; this.style.background='#f0fdf4';"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.background='white';">
                        <strong style="color: var(--brand);">Local Analysis</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                            Explore what's happening right here at t = ${this.paperPosition.toFixed(2)}
                        </p>
                    </button>
                    
                    <button onclick="explorer.selectCategory('global')" 
                            style="padding: 1rem; background: white; border: 2px solid var(--border); 
                                   border-radius: 8px; cursor: pointer; text-align: left; 
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.borderColor='var(--brand)'; this.style.background='#f0fdf4';"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.background='white';">
                        <strong style="color: var(--brand);">Global Exploration</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                            Find and analyze patterns across the entire graph
                        </p>
                    </button>
                    
                    <button onclick="explorer.selectCategory('numerical')" 
                            style="padding: 1rem; background: white; border: 2px solid var(--border); 
                                   border-radius: 8px; cursor: pointer; text-align: left; 
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.borderColor='var(--brand)'; this.style.background='#f0fdf4';"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.background='white';">
                        <strong style="color: var(--brand);">Numerical Intuition</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                            Build intuition about the meaning of slope and curvature values
                        </p>
                    </button>
                </div>
            </div>
        `;
    }
    
    selectCategory(category) {
        this.selectedCategory = category;
        this.generateCategoryQuestion(document.getElementById('exploration-content'));
    }
    
    generateCategoryQuestion(container) {
        const time = this.paperPosition;
        const y = this.currentFunction.f(time);
        const v = this.currentFunction.df(time);
        const a = this.currentFunction.d2f(time);
        
        let question;
        
        if (this.selectedCategory === 'local') {
            question = this.generateLocalQuestion(time, y, v, a);
        } else if (this.selectedCategory === 'global') {
            question = this.generateGlobalQuestion();
        } else if (this.selectedCategory === 'numerical') {
            question = this.generateNumericalQuestion(time, v, a);
        }
        
        this.currentQuestion = question;
        this.renderQuestion(container, question);
    }
    
    generateLocalQuestion(time, y, v, a) {
        const questions = [
            {
                id: 'tangent-direction',
                text: `Look at the tangent line at t = ${time.toFixed(2)}. Which way is it sloping?`,
                type: 'multiple-choice',
                options: [
                    'Upward (object moving up)',
                    'Horizontal (object at rest)',
                    'Downward (object moving down)'
                ],
                getCorrect: () => {
                    if (Math.abs(v) < 0.05) return 1;
                    return v > 0 ? 0 : 2;
                },
                getHint: (attempt) => {
                    if (attempt === 1) {
                        return 'Look at the orange dashed tangent line. Does it slope upward (/) or downward (\\)?';
                    } else if (attempt === 2) {
                        const actualV = v;
                        if (Math.abs(actualV) < 0.05) {
                            return 'The velocity value is very close to 0. What does that mean for the tangent?';
                        } else if (actualV > 0) {
                            return `The velocity is positive (${actualV.toFixed(2)}). Positive slope means...?`;
                        } else {
                            return `The velocity is negative (${actualV.toFixed(2)}). Negative slope means...?`;
                        }
                    }
                    return null;
                },
                feedback: () => {
                    if (Math.abs(v) < 0.05) return 'The tangent is horizontal, so the object is momentarily at rest.';
                    return v > 0 ? 'The upward slope means the object is moving upward.' : 
                                  'The downward slope means the object is moving downward.';
                }
            },
            {
                id: 'curvature-direction',
                text: `At t = ${time.toFixed(2)}, is the curve bending upward or downward?`,
                type: 'multiple-choice',
                options: [
                    'Upward (velocity increasing)',
                    'Straight (velocity constant)',
                    'Downward (velocity decreasing)'
                ],
                getCorrect: () => {
                    if (Math.abs(a) < 0.05) return 1;
                    return a > 0 ? 0 : 2;
                },
                getHint: (attempt) => {
                    if (attempt === 1) {
                        return 'Look at the curve near the red point. Is it shaped like a U (upward) or ‚à© (downward)?';
                    } else if (attempt === 2) {
                        const actualA = a;
                        if (Math.abs(actualA) < 0.05) {
                            return 'The acceleration is nearly 0. This means the curve is almost...?';
                        } else if (actualA > 0) {
                            return `Acceleration is positive (${actualA.toFixed(2)}). The curve opens...?`;
                        } else {
                            return `Acceleration is negative (${actualA.toFixed(2)}). The curve opens...?`;
                        }
                    }
                    return null;
                },
                feedback: () => {
                    if (Math.abs(a) < 0.05) return 'The curve is nearly straight here - velocity is changing very slowly.';
                    return a > 0 ? 'Upward curvature means velocity is increasing.' : 
                                  'Downward curvature means velocity is decreasing.';
                }
            }
        ];
        
        return questions[Math.floor(Math.random() * questions.length)];
    }
    
    generateGlobalQuestion() {
        // Analyze the function behavior in the visible range [-10, 10]
        const analyzeInterval = (start, end, samples = 100) => {
            const points = [];
            for (let i = 0; i <= samples; i++) {
                const t = start + (end - start) * i / samples;
                points.push({
                    t: t,
                    f: this.currentFunction.f(t),
                    df: this.currentFunction.df(t),
                    d2f: this.currentFunction.d2f(t)
                });
            }
            return points;
        };
        
        const visibleData = analyzeInterval(-10, 10);
        
        // Find critical points (where velocity ‚âà 0)
        const criticalPoints = visibleData.filter(p => Math.abs(p.df) < 0.1);
        
        // Find inflection regions (where acceleration changes sign)
        const inflectionRegions = [];
        for (let i = 1; i < visibleData.length; i++) {
            if (visibleData[i-1].d2f * visibleData[i].d2f < 0) {
                inflectionRegions.push(visibleData[i].t);
            }
        }
        
        const questions = [
            {
                id: 'find-rest-point',
                text: 'In the visible range, find a point where the object is momentarily at rest (horizontal tangent)',
                type: 'exploration-task',
                checkCondition: () => {
                    const v = this.currentFunction.df(this.paperPosition);
                    return Math.abs(v) < 0.1 && Math.abs(this.paperPosition) <= 10;
                },
                feedback: () => {
                    const v = this.currentFunction.df(this.paperPosition);
                    if (Math.abs(v) < 0.1) {
                        return `Perfect! At t = ${this.paperPosition.toFixed(2)}, the tangent is horizontal (velocity ‚âà 0).`;
                    }
                    if (criticalPoints.length === 0) {
                        return 'Actually, there are no rest points in the visible range. The object never stops!';
                    }
                    return `The tangent here has slope ${v.toFixed(2)}. Keep looking for a horizontal tangent.`;
                }
            },
            {
                id: 'identify-increasing',
                text: 'Find an interval where the function is increasing (positive velocity)',
                type: 'interval-analysis',
                checkCondition: () => {
                    const v = this.currentFunction.df(this.paperPosition);
                    return v > 0.2;
                },
                feedback: () => {
                    const v = this.currentFunction.df(this.paperPosition);
                    if (v > 0.2) {
                        return `Yes! At t = ${this.paperPosition.toFixed(2)}, the function is increasing (velocity = ${v.toFixed(2)} > 0).`;
                    } else if (v < -0.2) {
                        return `Here the function is decreasing (velocity = ${v.toFixed(2)} < 0). Look for where the tangent slopes upward.`;
                    } else {
                        return `This is near a critical point. Move to where the tangent clearly slopes upward.`;
                    }
                }
            },
            {
                id: 'identify-concave-up',
                text: 'Find a region where the curve is concave up (positive acceleration)',
                type: 'interval-analysis',
                checkCondition: () => {
                    const a = this.currentFunction.d2f(this.paperPosition);
                    return a > 0.1;
                },
                feedback: () => {
                    const a = this.currentFunction.d2f(this.paperPosition);
                    if (a > 0.1) {
                        return `Correct! The curve is concave up here (acceleration = ${a.toFixed(2)} > 0). The velocity is increasing.`;
                    } else if (a < -0.1) {
                        return `The curve is concave down here (acceleration = ${a.toFixed(2)} < 0). Look for U-shaped regions.`;
                    } else {
                        return `This is near an inflection point. Look for clearly U-shaped regions of the curve.`;
                    }
                }
            },
            {
                id: 'compare-speeds',
                text: `Compare the speeds at t = -5 and t = 5. Where is the object moving faster?`,
                type: 'comparison',
                options: [
                    'Faster at t = -5',
                    'Faster at t = 5',
                    'Same speed at both points'
                ],
                getCorrect: () => {
                    const v1 = Math.abs(this.currentFunction.df(-5));
                    const v2 = Math.abs(this.currentFunction.df(5));
                    if (Math.abs(v1 - v2) < 0.1) return 2;
                    return v1 > v2 ? 0 : 1;
                },
                getHint: (attempt) => {
                    const v1 = this.currentFunction.df(-5);
                    const v2 = this.currentFunction.df(5);
                    if (attempt === 1) {
                        return 'Move the slider to t = -5 and t = 5. Compare the steepness of the tangent lines.';
                    } else {
                        return `At t = -5, velocity = ${v1.toFixed(2)}. At t = 5, velocity = ${v2.toFixed(2)}. Compare the magnitudes.`;
                    }
                },
                feedback: () => {
                    const v1 = Math.abs(this.currentFunction.df(-5));
                    const v2 = Math.abs(this.currentFunction.df(5));
                    return `At t = -5, speed = ${v1.toFixed(2)}. At t = 5, speed = ${v2.toFixed(2)}. ${
                        Math.abs(v1 - v2) < 0.1 ? 'They\'re essentially the same!' :
                        v1 > v2 ? 'The object moves faster at t = -5.' : 'The object moves faster at t = 5.'
                    }`;
                }
            }
        ];
        
        // Filter out questions that don't make sense for this function
        const validQuestions = questions.filter(q => {
            if (q.id === 'find-rest-point' && criticalPoints.length === 0) {
                return false; // Don't ask for rest points if there aren't any
            }
            return true;
        });
        
        return validQuestions[Math.floor(Math.random() * validQuestions.length)];
    }
    
    generateNumericalQuestion(time, v, a) {
        const questions = [
            {
                id: 'velocity-magnitude',
                text: `The slope (velocity) here is ${v.toFixed(2)}. What does this number tell us?`,
                type: 'multiple-choice',
                options: [
                    'Object is nearly at rest',
                    'Object is moving at moderate speed',
                    'Object is moving very fast'
                ],
                getCorrect: () => {
                    const absV = Math.abs(v);
                    if (absV < 0.3) return 0;
                    if (absV < 1.5) return 1;
                    return 2;
                },
                getHint: (attempt) => {
                    const absV = Math.abs(v);
                    if (attempt === 1) {
                        return 'Think about the magnitude of the velocity. Is |' + v.toFixed(2) + '| close to 0, moderate, or large?';
                    } else if (attempt === 2) {
                        if (absV < 0.3) {
                            return 'A velocity magnitude less than 0.3 means the tangent is nearly horizontal.';
                        } else if (absV < 1.5) {
                            return 'A velocity magnitude between 0.3 and 1.5 indicates moderate movement.';
                        } else {
                            return 'A velocity magnitude greater than 1.5 means rapid motion!';
                        }
                    }
                    return null;
                },
                feedback: () => {
                    const absV = Math.abs(v);
                    if (absV < 0.3) {
                        return `|${v.toFixed(2)}| is close to 0 - the tangent is nearly horizontal.`;
                    }
                    if (absV < 1.5) {
                        return `|${v.toFixed(2)}| indicates moderate speed - noticeable but not extreme slope.`;
                    }
                    return `|${v.toFixed(2)}| is large - the tangent is steep, indicating rapid motion.`;
                }
            }
        ];
        
        return questions[0];
    }
    
    renderQuestion(container, question) {
        let html = `
            <div style="background: white; border: 2px solid var(--brand); 
                        border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--brand); margin: 0;">
                        ${this.getCategoryName()}
                    </h3>
                    <button onclick="explorer.changeCategory()" 
                            style="padding: 0.25rem 0.75rem; background: white; 
                                   color: var(--brand); border: 1px solid var(--brand); 
                                   border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                        Change Mode
                    </button>
                </div>
                <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: var(--text);">
                    ${question.text}
                </p>
        `;
        
        if (question.type === 'multiple-choice' || question.type === 'comparison') {
            html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            question.options.forEach((option, i) => {
                html += `
                    <button onclick="explorer.checkAnswer(${i})" 
                            class="answer-btn"
                            style="padding: 0.75rem 1rem; background: white; 
                                   border: 2px solid var(--border); border-radius: 8px; 
                                   cursor: pointer; text-align: left; font-size: 1rem;
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.borderColor='var(--brand)'; this.style.background='#f0fdf4';"
                            onmouseout="if(!this.disabled) { this.style.borderColor='var(--border)'; this.style.background='white'; }">
                        ${option}
                    </button>
                `;
            });
            html += '</div>';
            
            // Add interval viewer for comparison questions
            if (question.type === 'comparison') {
                html += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; 
                               border-radius: 8px; border: 1px solid #93c5fd;">
                        <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">
                            üí° Tip: Use the slider below to explore both time points
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="explorer.setPaperPosition(-5); document.getElementById('explorer-slider').value = -5;" 
                                    style="padding: 0.5rem 1rem; background: white; border: 1px solid #3b82f6; 
                                           border-radius: 6px; color: #3b82f6; font-size: 0.85rem; cursor: pointer;">
                                Go to t = -5
                            </button>
                            <button onclick="explorer.setPaperPosition(5); document.getElementById('explorer-slider').value = 5;" 
                                    style="padding: 0.5rem 1rem; background: white; border: 1px solid #3b82f6; 
                                           border-radius: 6px; color: #3b82f6; font-size: 0.85rem; cursor: pointer;">
                                Go to t = 5
                            </button>
                        </div>
                    </div>
                `;
            }
        } else if (question.type === 'exploration-task' || question.type === 'interval-analysis') {
            html += `
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; 
                            border-left: 3px solid #3b82f6; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #1e40af;">
                        Current position: <strong>t = ${this.paperPosition.toFixed(2)}</strong>
                    </p>
                    ${question.type === 'interval-analysis' ? `
                        <p style="margin: 0.5rem 0 0 0; color: #1e40af; font-size: 0.9rem;">
                            Visible range: t ‚àà [-10, 10]
                        </p>
                    ` : ''}
                </div>
                <button onclick="explorer.checkExplorationTask()" 
                        style="padding: 0.75rem 1.5rem; background: var(--brand); 
                               color: white; border: none; border-radius: 8px; 
                               font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Check Current Position
                </button>
                
                ${question.type === 'interval-analysis' ? `
                    <div style="margin-top: 1rem;">
                        <button onclick="explorer.showIntervalWindow()" 
                                style="padding: 0.5rem 1rem; background: white; 
                                       color: var(--brand); border: 2px solid var(--brand); 
                                       border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                            üìä Show Interval Analysis Window
                        </button>
                    </div>
                ` : ''}
            `;
        }
        
        html += `
                <div id="question-feedback" style="margin-top: 1.5rem;"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <button onclick="explorer.skipQuestion()" 
                            style="padding: 0.5rem 1rem; background: white; 
                                   color: var(--text-muted); border: 1px solid var(--border); 
                                   border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                        Skip This
                    </button>
                    <button onclick="explorer.newQuestionSameCategory()" 
                            style="padding: 0.5rem 1rem; background: white; 
                                   color: var(--brand); border: 2px solid var(--brand); 
                                   border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                        New Question
                    </button>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
        // Add interval window if it doesn't exist
        if (!document.getElementById('interval-window')) {
            this.createIntervalWindow();
        }
    }
    
    getCategoryName() {
        if (this.selectedCategory === 'local') return 'Local Analysis';
        if (this.selectedCategory === 'global') return 'Global Exploration';
        if (this.selectedCategory === 'numerical') return 'Numerical Intuition';
        return 'Exploration';
    }
    
    checkAnswer(choiceIndex) {
        const correct = this.currentQuestion.getCorrect();
        const isCorrect = choiceIndex === correct;
        this.attemptsOnCurrentQuestion++;
        
        const buttons = document.querySelectorAll('.answer-btn');
        
        if (isCorrect) {
            // Correct answer - highlight it and disable all buttons
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                btn.style.cursor = 'default';
                if (i === choiceIndex) {
                    btn.style.background = '#d1fae5';
                    btn.style.borderColor = 'var(--success)';
                }
            });
            
            const feedback = this.currentQuestion.feedback();
            this.showFeedback(true, feedback);
            
            this.score++;
            this.totalQuestions++;
            
            // Automatically generate new question and function after 2 seconds
            setTimeout(() => {
                this.currentFunction = generateRandomFunction();
                this.updateInfo();
                this.generateCategoryQuestion(document.getElementById('exploration-content'));
            }, 2000);
            
        } else {
            // Wrong answer - give hint but don't reveal answer
            buttons[choiceIndex].style.background = '#fee2e2';
            buttons[choiceIndex].style.borderColor = 'var(--error)';
            buttons[choiceIndex].disabled = true;
            
            // Provide hint based on number of attempts
            let hintMessage = '';
            if (this.currentQuestion.getHint) {
                hintMessage = this.currentQuestion.getHint(this.attemptsOnCurrentQuestion);
            }
            
            if (!hintMessage) {
                hintMessage = 'Try looking at the graph more carefully. What do you notice?';
            }
            
            // If they've tried all options, reveal answer and move on
            if (this.attemptsOnCurrentQuestion >= this.currentQuestion.options.length - 1) {
                buttons.forEach((btn, i) => {
                    btn.disabled = true;
                    btn.style.cursor = 'default';
                    if (i === correct) {
                        btn.style.background = '#d1fae5';
                        btn.style.borderColor = 'var(--success)';
                    }
                });
                
                const feedback = this.currentQuestion.feedback();
                this.showFeedback(false, `The correct answer was: "${this.currentQuestion.options[correct]}". ${feedback}`);
                
                // Generate new question with new function after delay
                setTimeout(() => {
                    this.currentFunction = generateRandomFunction();
                    this.updateInfo();
                    this.generateCategoryQuestion(document.getElementById('exploration-content'));
                }, 3000);
                
            } else {
                this.showFeedback(false, hintMessage);
            }
        }
    }
    
    checkExplorationTask() {
        const isCorrect = this.currentQuestion.checkCondition();
        const feedback = this.currentQuestion.feedback();
        
        this.showFeedback(isCorrect, feedback);
        
        if (isCorrect) {
            this.score++;
            this.totalQuestions++;
            
            // Generate new question after a short delay
            setTimeout(() => {
                this.currentFunction = generateRandomFunction();
                this.updateInfo();
                this.generateCategoryQuestion(document.getElementById('exploration-content'));
            }, 2000);
        }
    }
    
    showFeedback(isCorrect, message) {
        const feedbackDiv = document.getElementById('question-feedback');
        const color = isCorrect ? '#d1fae5' : '#fef3c7';
        const border = isCorrect ? 'var(--success)' : 'var(--warning)';
        const icon = isCorrect ? '‚úì' : 'üí°';
        const title = isCorrect ? 'Correct!' : 'Hint:';
        
        feedbackDiv.innerHTML = `
            <div style="background: ${color}; padding: 1rem; border-radius: 8px; 
                        border-left: 4px solid ${border};">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">
                    ${icon} ${title}
                </div>
                <div style="color: var(--text); line-height: 1.6;">
                    ${message}
                </div>
            </div>
        `;
    }
    
    changeCategory() {
        this.selectedCategory = null;
        this.generateNewQuestion();
    }
    
    skipQuestion() {
        this.currentFunction = generateRandomFunction();
        this.updateInfo();
        this.generateCategoryQuestion(document.getElementById('exploration-content'));
    }
    
    newQuestionSameCategory() {
        this.currentFunction = generateRandomFunction();
        this.updateInfo();
        this.generateCategoryQuestion(document.getElementById('exploration-content'));
    }
    
    updateInfo() {
        const time = this.paperPosition;
        const y = this.currentFunction.f(time);
        const v = this.currentFunction.df(time);
        const a = this.currentFunction.d2f(time);
        
        document.getElementById('current-time').textContent = time.toFixed(2);
        document.getElementById('slider-time').textContent = time.toFixed(2);
        document.getElementById('explorer-position').textContent = y.toFixed(3);
        document.getElementById('explorer-velocity').textContent = v.toFixed(3);
        document.getElementById('explorer-acceleration').textContent = a.toFixed(3);
        
        let behavior = '';
        let behaviorDesc = '';
        
        if (Math.abs(v) < 0.05) {
            behavior = 'At Rest';
            behaviorDesc = a > 0 ? 'At a valley' : a < 0 ? 'At a peak' : 'Stationary';
        } else if (v > 0) {
            behavior = 'Rising';
            behaviorDesc = a > 0.05 ? 'Getting faster' : a < -0.05 ? 'Slowing down' : 'Steady rise';
        } else {
            behavior = 'Falling';
            behaviorDesc = a < -0.05 ? 'Getting faster' : a > 0.05 ? 'Slowing down' : 'Steady fall';
        }
        
        document.getElementById('explorer-behavior').textContent = behavior;
        document.getElementById('behavior-desc').textContent = behaviorDesc;
        
        document.getElementById('position-desc').textContent = 
            y > 0.1 ? 'Above baseline' : y < -0.1 ? 'Below baseline' : 'Near baseline';
        document.getElementById('velocity-desc').textContent = 
            Math.abs(v) < 0.05 ? 'Nearly horizontal tangent' :
            v > 0 ? 'Upward slope' : 'Downward slope';
        document.getElementById('acceleration-desc').textContent = 
            Math.abs(a) < 0.05 ? 'Nearly straight curve' :
            a > 0 ? 'Upward bend' : 'Downward bend';
    }
    
    animate() {
        this.draw();
        this.drawStatic();  // Add static draw call
        this.animationId = requestAnimationFrame(() => this.animate());
    }
    
    // Add new method to draw the static graph
    drawStatic() {
        const ctx = this.staticManager.ctx;
        const w = this.staticManager.width;
        const h = this.staticManager.height;
        const scale = 50;
        
        const time = this.paperPosition;
        const y = this.currentFunction.f(time);
        const dy = this.currentFunction.df(time);
        
        this.staticManager.clear();
        this.staticManager.drawGrid();
        
        // Draw the function curve
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        let firstPoint = true;
        for (let i = 0; i <= 400; i++) {
            const t = -20 + i * 0.1;
            const x = w/2 + t * 30;
            const fy = h/2 - this.currentFunction.f(t) * scale;
            
            if (x >= 0 && x <= w) {
                if (firstPoint) {
                    ctx.moveTo(x, fy);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, fy);
                }
            }
        }
        ctx.stroke();
        ctx.restore();
        
        // Draw current point
        const pointX = w/2 + time * 30;
        const pointY = h/2 - y * scale;
        
       // Draw tangent line
const len = 100;
const slope = -dy * scale / 30;  // Fixed: negative because screen y increases downward

ctx.save();
ctx.beginPath();
ctx.strokeStyle = '#f59e0b';
ctx.lineWidth = 4;
ctx.lineCap = 'round';
ctx.setLineDash([5, 5]);
ctx.moveTo(pointX - len, pointY - slope * len);  // Fixed: corrected signs
ctx.lineTo(pointX + len, pointY + slope * len);   // Fixed: corrected signs
        ctx.stroke();
        ctx.restore();
        
        // Draw the point
        ctx.save();
        ctx.shadowColor = '#dc2626';
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(pointX, pointY, 8, 0, 2*Math.PI);
        ctx.fillStyle = '#dc2626';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
        
        // Draw time marker
        ctx.save();
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(pointX, 0);
        ctx.lineTo(pointX, h);
        ctx.stroke();
        ctx.restore();
    }
    
    draw() {
        const ctx = this.manager.ctx;
        const w = this.manager.width;
        const h = this.manager.height;
        const scale = 50;
        const paperSpeed = 30;
        const presentX = w * 0.5;  // This should be the center where NOW is
        
        const time = this.paperPosition;
        const y = this.currentFunction.f(time);
        const dy = this.currentFunction.df(time);
        
        this.manager.clear();
        
        const gridOffset = -time * paperSpeed;
        this.manager.drawGrid(gridOffset);
        
        // Draw the function curve
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        let firstPoint = true;
        for (let i = 0; i <= 800; i++) {
            const t = time - 40 + i * 0.1;
            const x = presentX + (t - time) * paperSpeed;  // Fixed: consistent with paper movement
            const fy = h/2 - this.currentFunction.f(t) * scale;
            
            if (x >= -100 && x <= w + 100) {
                if (firstPoint) {
                    ctx.moveTo(x, fy);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, fy);
                }
            }
        }
        ctx.stroke();
        ctx.restore();
        
        // The point should be at presentX (the NOW line)
        const pointY = h/2 - y * scale;
       // Draw tangent line
const len = 120;
const screenSlope = -dy * scale / paperSpeed;

ctx.save();
ctx.beginPath();
ctx.strokeStyle = '#f59e0b';
ctx.lineWidth = 5;
ctx.lineCap = 'round';
ctx.setLineDash([5, 5]);
ctx.moveTo(presentX - len, pointY - screenSlope * len);  // Fixed: corrected signs
ctx.lineTo(presentX + len, pointY + screenSlope * len);   // Fixed: corrected signs
        ctx.stroke();
        ctx.restore();
        
        // Draw the point exactly at presentX (NOW line)
        ctx.save();
        ctx.shadowColor = '#dc2626';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(presentX, pointY, 10, 0, 2*Math.PI);
        ctx.fillStyle = '#dc2626';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
    }
    
    destroy() {
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
        }
    }
}

// Initialize
let mcAnim, gcAnim, explorer;

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        try {
            mcAnim = new MotionCreatesAnimation(document.getElementById('motion-canvas'));
            gcAnim = new GraphControlsAnimation(document.getElementById('graph-canvas'));
            
            // Pass both canvases to the explorer - static and moving
            explorer = new InteractiveExplorer(
                document.getElementById('explorer-canvas'),
                document.getElementById('static-canvas')
            );
            
            window.explorer = explorer;
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Tab 1 Controls
            document.getElementById('mc-start-btn').addEventListener('click', function() {
                mcAnim.start();
                this.classList.add('active');
                document.getElementById('mc-pause-btn').classList.remove('active');
            });
            
            document.getElementById('mc-pause-btn').addEventListener('click', function() {
                mcAnim.pause();
                this.classList.add('active');
                document.getElementById('mc-start-btn').classList.remove('active');
            });
            
            document.getElementById('mc-reset-btn').addEventListener('click', () => {
                mcAnim.reset();
                document.getElementById('mc-start-btn').classList.remove('active');
                document.getElementById('mc-pause-btn').classList.remove('active');
            });
            
            document.getElementById('mc-paper-slider').addEventListener('input', (e) => {
                mcAnim.setPaperPosition(e.target.value);
            });
            
            // Tab 2 Controls
            document.getElementById('gc-start-btn').addEventListener('click', function() {
                gcAnim.start();
                this.classList.add('active');
                document.getElementById('gc-pause-btn').classList.remove('active');
            });
            
            document.getElementById('gc-pause-btn').addEventListener('click', function() {
                gcAnim.pause();
                this.classList.add('active');
                document.getElementById('gc-start-btn').classList.remove('active');
            });
            
            document.getElementById('gc-reset-btn').addEventListener('click', () => {
                gcAnim.reset();
                document.getElementById('gc-start-btn').classList.remove('active');
                document.getElementById('gc-pause-btn').classList.remove('active');
            });
            
            document.getElementById('gc-paper-slider').addEventListener('input', (e) => {
                gcAnim.setPaperPosition(e.target.value);
            });
            
            // Tab 3 Controls
            document.getElementById('explorer-slider').addEventListener('input', (e) => {
                explorer.setPaperPosition(e.target.value);
            });
            
            document.getElementById('new-function-btn').addEventListener('click', () => {
                explorer.generateNew();
            });
            
            console.log('Application initialized successfully');
            
        } catch (error) {
            console.error('Initialization error:', error);
        }
        
        window.addEventListener('beforeunload', () => {
            if (mcAnim) mcAnim.destroy();
            if (gcAnim) gcAnim.destroy();
            if (explorer) explorer.destroy();
        });
    }, 50);
});
</script>
</body>
</html>
