<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Series Explorer | Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #10b981;
            --background: #f7faf9;
            --interactive: #e6fffb;
            --text-primary: #212121;
            --text-muted: #4b5563;
            --accent-amber: #f59e0b;
            --accent-red: #c62828;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            padding-top: 60px;
            min-height: 100vh;
        }
        
        .mathswell-nav {
            position: fixed; top: 0; left: 0; right: 0;
            background: white; border-bottom: 2px solid var(--primary);
            padding: 0.75rem 1rem; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        
        .mw-link {
            display: flex; align-items: center; gap: 0.5rem;
            text-decoration: none; color: var(--primary);
            font-weight: 600; letter-spacing: 1px;
        }
        
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        
        /* Tabs */
        .tabs {
            display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
            background: white; padding: 0.5rem; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 2rem;
        }
        
        .tab-btn {
            padding: 0.6rem 1.25rem; border: none; background: transparent;
            color: var(--text-muted); cursor: pointer; border-radius: 8px;
            font-weight: 500; transition: all 0.2s ease; font-size: 0.9rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn:hover:not(.active) { background: var(--interactive); color: var(--primary); }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Hero */
        .hero { text-align: center; margin-bottom: 2rem; }
        .hero h1 { font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; }
        .hero p { font-size: 1rem; color: var(--text-muted); max-width: 650px; margin: 0 auto; line-height: 1.5; }
        
        /* Explorer Layout */
        .explorer-layout { display: grid; grid-template-columns: 260px 1fr; gap: 1.5rem; }
        
        .control-panel {
            background: white; border-radius: 12px; padding: 1.25rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); height: fit-content;
            position: sticky; top: 80px;
        }
        
        .preset-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
        .preset-pill {
            padding: 0.35rem 0.7rem; border-radius: 999px; background: white;
            border: 2px solid var(--primary); color: var(--primary);
            cursor: pointer; transition: all 0.2s ease; font-size: 0.75rem; font-weight: 500;
        }
        .preset-pill:hover { background: var(--interactive); }
        .preset-pill.active { background: var(--primary); color: white; }
        
        .control-group { margin-bottom: 1rem; }
        .control-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .slider-container { display: flex; align-items: center; gap: 0.5rem; }
        input[type="range"] { flex: 1; height: 5px; background: var(--interactive); border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        .slider-value { min-width: 35px; text-align: right; font-family: monospace; color: var(--primary); font-weight: 600; font-size: 0.8rem; }
        
        .info-display {
            background: var(--interactive); border: 1px solid var(--primary);
            border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem;
        }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
        .info-item:last-child { margin-bottom: 0; }
        .info-value { font-family: monospace; color: var(--primary); font-weight: 600; }
        
        .btn {
            padding: 0.45rem 0.7rem; border: 2px solid var(--primary);
            background: white; color: var(--primary); border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: all 0.2s ease; font-size: 0.8rem;
        }
        .btn:hover { background: var(--primary); color: white; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        
        .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        /* Visualization */
        .unified-viz {
            background: white; border-radius: 12px; padding: 1.25rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        .viz-box {
            background: var(--background); border-radius: 8px; padding: 0.75rem;
            border: 1px solid #e0e0e0;
        }
        .viz-box.full-width { grid-column: 1 / -1; }
        .viz-box canvas { width: 100%; display: block; }
        #numberline-canvas { background: white; border-radius: 8px; min-height: 140px; }
        
        .viz-title { font-size: 0.8rem; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem; }
        
        .numerical-display {
            background: #1a1a1a; border-radius: 6px; padding: 0.75rem;
            font-family: monospace; text-align: center;
        }
        .sum-display { font-size: 1.3rem; letter-spacing: 1px; color: #0f0; }
        .digit-stable { color: #0f0; }
        .digit-changing { color: #ff0; background: rgba(255,255,0,0.1); }
        .term-info { font-size: 0.7rem; color: #888; margin-top: 0.3rem; }
        
        .step-controls {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0;
        }
        
        .step-btn {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--primary);
            background: white; color: var(--primary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }
        .step-btn:hover:not(:disabled) { background: var(--primary); color: white; }
        .step-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .step-counter { font-family: monospace; color: var(--primary); font-weight: 600; min-width: 90px; text-align: center; font-size: 0.85rem; }
        
        /* ============ TAB 2 ============ */
        .section-box {
            background: white; border-radius: 12px; padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); margin-bottom: 1.5rem;
        }
        
        .section-box h2 { color: var(--primary); margin-bottom: 1rem; text-align: center; font-size: 1.4rem; }
        
        .test-rule {
            background: var(--interactive); padding: 1rem; border-radius: 8px;
            margin-bottom: 1rem; text-align: center;
        }
        
        .divergence-graphs {
            display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;
        }
        
        .graph-box { text-align: center; }
        .graph-title { color: var(--primary); margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; }
        .graph-box canvas { border: 1px solid var(--primary); border-radius: 8px; }
        
        .animate-btn-container { text-align: center; margin-top: 1rem; }
        
        .comparison-scenarios {
            display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .scenario-card {
            background: white; border-radius: 10px; padding: 1rem;
            box-shadow: 0 3px 12px rgba(0,0,0,0.1); cursor: pointer;
            transition: all 0.2s ease; border: 2px solid transparent;
            text-align: center; width: 200px;
        }
        .scenario-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .scenario-card.active { border-color: var(--primary); background: var(--interactive); }
        
        .scenario-icon { font-size: 2rem; margin-bottom: 0.4rem; }
        .scenario-title { color: var(--primary); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .scenario-desc { font-size: 0.75rem; color: var(--text-muted); }
        
        .lab-result {
            margin-top: 1rem; padding: 1rem; border-radius: 8px;
            font-size: 0.95rem; line-height: 1.5;
        }
        .lab-result.valid { background: #d1fae5; border-left: 4px solid var(--success); }
        .lab-result.invalid { background: #fef3c7; border-left: 4px solid var(--accent-amber); }
        
        /* ============ TAB 3: Challenge ============ */
        .challenge-layout { display: grid; grid-template-columns: 1fr 340px; gap: 1.5rem; }
        
        .challenge-viz {
            background: white; border-radius: 12px; padding: 1.25rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .challenge-controls {
            background: white; border-radius: 12px; padding: 1.25rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); height: fit-content;
        }
        
        .series-display {
            background: var(--interactive); border-radius: 8px; padding: 1rem;
            text-align: center; margin-bottom: 1rem;
        }
        .series-display h4 { color: var(--primary); margin-bottom: 0.5rem; font-size: 0.85rem; }
        .series-formula { font-size: 1.2rem; min-height: 2.5rem; }
        
        .step-section {
            border: 2px solid #e0e0e0; border-radius: 8px; padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .step-section.active { border-color: var(--primary); background: var(--interactive); }
        .step-section.completed { border-color: var(--success); background: #d1fae5; }
        .step-section.hidden { display: none; }
        
        .step-header { font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.85rem; }
        
        .input-row { display: flex; gap: 0.5rem; align-items: center; }
        .input-row input { flex: 1; padding: 0.5rem; border: 2px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        .input-row input:focus { border-color: var(--primary); outline: none; }
        
        .comparison-options { display: flex; flex-direction: column; gap: 0.4rem; margin-top: 0.5rem; }
        .comp-option {
            padding: 0.5rem; border: 2px solid #ddd; border-radius: 6px;
            background: white; cursor: pointer; font-size: 0.8rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .comp-option:hover { border-color: var(--primary); background: var(--interactive); }
        .comp-option.selected { border-color: var(--accent-amber); background: #fffbeb; }
        .behavior-tag { font-size: 0.65rem; padding: 0.1rem 0.3rem; border-radius: 3px; }
        .behavior-tag.diverges { background: #fee2e2; color: #991b1b; }
        .behavior-tag.converges { background: #d1fae5; color: #065f46; }
        
        .reasoning-options { display: flex; flex-direction: column; gap: 0.3rem; margin-top: 0.5rem; }
        .reason-btn {
            padding: 0.5rem; border: 2px solid #ddd; border-radius: 6px;
            background: white; cursor: pointer; font-size: 0.75rem; text-align: left;
            transition: all 0.2s ease;
        }
        .reason-btn:hover { border-color: var(--primary); background: var(--interactive); }
        .reason-btn.selected { border-color: var(--primary); background: var(--primary); color: white; }
        
        .mathpal-box {
            background: var(--interactive); border-left: 4px solid var(--accent-amber);
            padding: 0.75rem; margin-top: 0.75rem; border-radius: 0 6px 6px 0;
        }
        .mathpal-header { display: flex; align-items: center; gap: 0.4rem; font-weight: 600; color: var(--primary); font-size: 0.8rem; margin-bottom: 0.4rem; }
        .mathpal-text { font-size: 0.85rem; line-height: 1.4; }
        
        /* MathPal Disclosure Banner */
        .ai-disclosure-banner {
            background: var(--interactive);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        .ai-disclosure-banner .banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: center;
        }
        .ai-disclosure-banner .banner-text {
            text-align: left;
        }
        .ai-disclosure-banner .banner-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .ai-disclosure-banner .banner-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* MathPal Avatar */
        .mathpal-avatar {
            animation: mathpal-bob 3s ease-in-out infinite;
        }
        @keyframes mathpal-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .robot-eye {
            animation: robot-blink 5s infinite;
        }
        @keyframes robot-blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.1; }
        }
        
        /* MathPal Thinking Animation */
        .mathpal-thinking {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-style: italic;
        }
        .mathpal-thinking.show { display: flex; }
        .thinking-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: thinking-bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Hint Buttons */
        .hint-buttons {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .hint-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--primary);
            border-radius: 12px;
            background: white;
            color: var(--primary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hint-btn:hover {
            background: var(--interactive);
        }
        .hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .view-tabs { display: flex; gap: 0.3rem; margin-bottom: 0.75rem; }
        .view-tab {
            padding: 0.4rem 0.7rem; border: 2px solid #ddd; border-radius: 6px;
            background: white; cursor: pointer; font-size: 0.75rem;
        }
        .view-tab.active { border-color: var(--primary); background: var(--primary); color: white; }
        
        .legend-box { display: flex; gap: 1.5rem; justify-content: center; margin: 0.5rem 0; font-size: 0.75rem; }
        .legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .legend-color { width: 20px; height: 3px; border-radius: 2px; }
        
        .viz-controls {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0;
        }
        
        /* Solution Box - Textbook Style */
        .solution-box {
            background: white; border: 2px solid var(--primary);
            border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
            display: none; page-break-inside: avoid;
        }
        .solution-box.show { display: block; }
        
        .solution-header {
            text-align: center; margin-bottom: 1rem; padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary);
        }
        .solution-header h3 { color: var(--primary); font-size: 1.1rem; margin-bottom: 0.25rem; }
        .solution-problem { font-size: 1.2rem; }
        
        .solution-content { line-height: 1.8; font-size: 0.95rem; }
        .solution-content p { margin-bottom: 0.75rem; text-indent: 1.5rem; }
        .solution-content p:first-child { text-indent: 0; }
        .solution-content .math-block { text-align: center; margin: 1rem 0; font-size: 1.1rem; }
        .solution-content .conclusion { 
            margin-top: 1rem; padding: 0.75rem; background: var(--interactive);
            border-radius: 6px; text-align: center; font-weight: 600;
        }
        .solution-content .note {
            margin-top: 1rem; padding: 0.75rem; background: #fef3c7;
            border-left: 3px solid var(--accent-amber); font-size: 0.85rem;
            font-style: italic;
        }
        
        .print-btn { margin-top: 1rem; width: 100%; }
        
        /* Print Styles */
        @media print {
            body { padding-top: 0; background: white; }
            .mathswell-nav, .tabs, .challenge-controls, .view-tabs, .viz-controls,
            .legend-box, canvas, .no-print { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 1rem; }
            .challenge-layout { display: block; }
            .challenge-viz { box-shadow: none; padding: 0; }
            .solution-box { 
                border: 2px solid #000; 
                display: block !important;
                margin: 0;
            }
            .solution-box.show { display: block !important; }
            .solution-header { border-bottom-color: #000; }
            .solution-header h3 { color: #000; }
            .solution-content .conclusion { background: #eee; border: 1px solid #000; }
        }
        
        /* Mobile */
        @media (max-width: 900px) {
            .explorer-layout, .challenge-layout { grid-template-columns: 1fr; }
            .control-panel { position: relative; top: 0; }
            .viz-grid { grid-template-columns: 1fr; }
            .comparison-scenarios { flex-direction: column; align-items: center; }
        }
        
        @media (max-width: 600px) {
            .tabs { flex-direction: column; align-items: stretch; }
            .tab-btn { justify-content: center; }
            input, button, select { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="mathswell-nav no-print">
        <a href="/" class="mw-link">
            <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
            <span>MATHSWELL</span>
        </a>
    </div>
    
    <div class="container">
        <div class="tabs no-print">
            <button class="tab-btn active" data-tab="explorer">üî¨ Explorer</button>
            <button class="tab-btn" data-tab="lab">‚öñÔ∏è Comparison Lab</button>
            <button class="tab-btn" data-tab="challenge">üéØ Challenge</button>
        </div>
        
        <!-- ============ TAB 1: Explorer ============ -->
        <div id="explorer" class="tab-content active">
            <div class="hero">
                <h1>Series Explorer: Three Views of Infinity</h1>
                <p>Watch how partial sums behave as you add more terms. Does the sum settle down or grow forever?</p>
            </div>
            
            <div class="explorer-layout">
                <div class="control-panel">
                    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem;">Choose a Series</h3>
                    <div class="preset-pills">
                        <button class="preset-pill active" onclick="loadSeries('geometric', this)">Geometric</button>
                        <button class="preset-pill" onclick="loadSeries('harmonic', this)">Harmonic</button>
                        <button class="preset-pill" onclick="loadSeries('p-series', this)">p-Series</button>
                        <button class="preset-pill" onclick="loadSeries('alternating', this)">Alternating</button>
                        <button class="preset-pill" onclick="loadSeries('telescoping', this)">Telescoping</button>
                    </div>
                    
                    <div class="control-group" id="parameterControl">
                        <label id="paramLabel">Common Ratio (r)</label>
                        <div class="slider-container">
                            <input type="range" id="paramSlider" min="0.1" max="1.5" step="0.1" value="0.5">
                            <span class="slider-value" id="paramValue">0.5</span>
                        </div>
                    </div>
                    
                    <div class="info-display">
                        <div class="info-item">
                            <span>Partial Sum:</span>
                            <span class="info-value" id="partialSum">0.000</span>
                        </div>
                        <div class="info-item">
                            <span>Behavior:</span>
                            <span class="info-value" id="convergenceStatus">Settles</span>
                        </div>
                        <div class="info-item">
                            <span>Formula:</span>
                            <span class="info-value" id="formulaDisplay">Œ£ r‚Åø</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="animateBtn" onclick="toggleAnimation()">‚ñ∂ Play</button>
                        <button class="btn" onclick="resetExplorer()">‚Ü∫ Reset</button>
                    </div>
                </div>
                
                <div class="unified-viz">
                    <div class="viz-grid">
                        <div class="viz-box">
                            <div class="viz-title">üî¢ Numerical View</div>
                            <div class="numerical-display">
                                <div class="sum-display" id="sumDisplay">0.00000000</div>
                                <div class="term-info" id="termInfo">Term 0</div>
                            </div>
                        </div>
                        
                        <div class="viz-box">
                            <div class="viz-title">üìä Staircase View</div>
                            <canvas id="staircase-canvas" height="160"></canvas>
                        </div>
                        
                        <div class="viz-box full-width">
                            <div class="viz-title">‚û°Ô∏è Number Line ‚Äî Watch the Sum Accumulate</div>
                            <canvas id="numberline-canvas" height="160"></canvas>
                        </div>
                    </div>
                    
                    <div class="step-controls">
                        <button class="step-btn" id="stepBackBtn" onclick="stepBack()">‚àí</button>
                        <div class="step-counter"><span id="currentTermDisplay">0</span> / <span id="maxTermsDisplay">100</span></div>
                        <button class="step-btn" id="stepForwardBtn" onclick="stepForward()">+</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============ TAB 2: Comparison Lab ============ -->
        <div id="lab" class="tab-content">
            <!-- Section 1: The Necessary Condition -->
            <div class="section-box">
                <h2>üìê The Necessary Condition</h2>
                <div class="test-rule">
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--primary); font-weight: 600;">
                        If Œ£a‚Çô converges, then a‚Çô ‚Üí 0
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                        For a series to have a finite sum, its terms must eventually become negligible.
                    </div>
                </div>
                
                <div class="divergence-graphs">
                    <div class="graph-box">
                        <div class="graph-title">Terms: a‚Çô = (¬Ω)‚Åø</div>
                        <canvas id="conv-terms-canvas" width="320" height="180"></canvas>
                    </div>
                    <div class="graph-box">
                        <div class="graph-title">Partial Sums: S‚Çô ‚Üí 2</div>
                        <canvas id="conv-sums-canvas" width="320" height="180"></canvas>
                    </div>
                </div>
                <p style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                    ‚úì Terms shrink to 0 &nbsp;‚Üí&nbsp; ‚úì Sum settles at 2
                </p>
                
                <div class="animate-btn-container">
                    <button class="btn btn-primary" id="convAnimateBtn" onclick="animateConvergentGraphs()">‚ñ∂ Animate</button>
                </div>
            </div>
            
            <!-- Section 2: The Surprising Harmonic Series -->
            <div class="section-box">
                <h2>üö® But The Converse is FALSE!</h2>
                <div class="test-rule" style="background: #fef3c7; border-left: 4px solid var(--accent-amber);">
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #92400e; font-weight: 600;">
                        a‚Çô ‚Üí 0 does NOT guarantee convergence
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                        The harmonic series is the classic counterexample: each term 1/n ‚Üí 0, yet Œ£(1/n) ‚Üí ‚àû
                    </div>
                </div>
                
                <div class="divergence-graphs">
                    <div class="graph-box">
                        <div class="graph-title">Terms: a‚Çô = 1/n ‚Üí 0</div>
                        <canvas id="terms-canvas" width="320" height="180"></canvas>
                    </div>
                    <div class="graph-box">
                        <div class="graph-title">Partial Sums: S‚Çô ‚Üí ‚àû (!)</div>
                        <canvas id="sums-canvas" width="320" height="180"></canvas>
                    </div>
                </div>
                <p style="text-align: center; color: var(--accent-red); font-size: 0.85rem; margin-top: 0.5rem; font-weight: 500;">
                    ‚úì Terms shrink to 0 &nbsp;‚Üí&nbsp; ‚úó Sum STILL grows forever!
                </p>
                
                <div class="animate-btn-container">
                    <button class="btn btn-primary" id="divergenceAnimateBtn" onclick="animateDivergenceGraphs()">‚ñ∂ Animate</button>
                </div>
            </div>
            
            <!-- Section 3: The Divergence Test -->
            <div class="section-box">
                <h2>üß™ The Divergence Test</h2>
                <div class="test-rule" style="background: #d1fae5;">
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--primary); font-weight: 600;">
                        If a<sub>n</sub> does not ‚Üí 0, then Œ£a<sub>n</sub> diverges
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                        This is the contrapositive of the necessary condition ‚Äî and it's always conclusive!
                    </div>
                </div>
                
                <div class="divergence-graphs">
                    <div class="graph-box">
                        <div class="graph-title">Terms: a‚Çô = n/(n+1) ‚Üí 1 ‚â† 0</div>
                        <canvas id="divtest-terms-canvas" width="320" height="180"></canvas>
                    </div>
                    <div class="graph-box">
                        <div class="graph-title">Partial Sums: S‚Çô ‚Üí ‚àû</div>
                        <canvas id="divtest-sums-canvas" width="320" height="180"></canvas>
                    </div>
                </div>
                <p style="text-align: center; color: var(--success); font-size: 0.85rem; margin-top: 0.5rem; font-weight: 500;">
                    ‚úó Terms don't go to 0 &nbsp;‚Üí&nbsp; Series MUST diverge (no further analysis needed)
                </p>
                
                <div class="animate-btn-container">
                    <button class="btn btn-primary" id="divtestAnimateBtn" onclick="animateDivTestGraphs()">‚ñ∂ Animate</button>
                </div>
                
                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; margin-top: 1rem; font-size: 0.85rem;">
                    <strong>‚ö†Ô∏è Caution:</strong> If a‚Çô ‚Üí 0, the test is <em>inconclusive</em>. The series might converge (like geometric) or diverge (like harmonic). We need other tools!
                </div>
            </div>
            
            <!-- Section 4: The Comparison Principle -->
            <div class="section-box">
                <h2>‚öñÔ∏è The Comparison Principle</h2>
                <p style="text-align: center; margin-bottom: 1rem; color: var(--text-muted);">When the divergence test is inconclusive (a‚Çô ‚Üí 0), comparison can help. Click each case:</p>
                
                <div class="comparison-scenarios">
                    <div class="scenario-card" onclick="loadLabScenario('ceiling', this)">
                        <div class="scenario-icon">üìâ</div>
                        <div class="scenario-title">Smaller than Convergent</div>
                        <div class="scenario-desc">Must converge!</div>
                    </div>
                    <div class="scenario-card" onclick="loadLabScenario('floor', this)">
                        <div class="scenario-icon">üìà</div>
                        <div class="scenario-title">Bigger than Divergent</div>
                        <div class="scenario-desc">Must diverge!</div>
                    </div>
                    <div class="scenario-card" onclick="loadLabScenario('bigger-converge', this)">
                        <div class="scenario-icon">ü§∑</div>
                        <div class="scenario-title">Bigger than Convergent</div>
                        <div class="scenario-desc">Could go either way!</div>
                    </div>
                    <div class="scenario-card" onclick="loadLabScenario('smaller-diverge', this)">
                        <div class="scenario-icon">üòï</div>
                        <div class="scenario-title">Smaller than Divergent</div>
                        <div class="scenario-desc">Could go either way!</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center;">
                    <canvas id="lab-canvas" width="600" height="260"></canvas>
                </div>
                <div id="lab-result" class="lab-result" style="display: none; max-width: 600px; margin: 0.75rem auto 0;"></div>
            </div>
        </div>
        
        <!-- ============ TAB 3: Challenge ============ -->
        <div id="challenge" class="tab-content">
            <!-- MathPal Disclosure Banner -->
            <div class="ai-disclosure-banner">
                <div class="banner-content">
                    <svg class="mathpal-avatar" width="40" height="40" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="#e6fffb"/>
                        <rect x="35" y="60" width="30" height="25" fill="#0f766e" rx="3"/>
                        <rect x="30" y="35" width="40" height="30" fill="#10b981" rx="8"/>
                        <line x1="50" y1="35" x2="50" y2="25" stroke="#0f766e" stroke-width="2"/>
                        <circle cx="50" cy="23" r="3" fill="#f59e0b"/>
                        <circle cx="40" cy="47" r="5" fill="white"/>
                        <circle cx="60" cy="47" r="5" fill="white"/>
                        <circle cx="40" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                        <circle cx="60" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                        <path d="M 40 55 Q 50 60 60 55" stroke="#0f766e" stroke-width="2" fill="none"/>
                    </svg>
                    <div class="banner-text">
                        <div class="banner-title">MathPal - Your AI Study Buddy</div>
                        <div class="banner-subtitle">Learns alongside you ‚Ä¢ Can make mistakes ‚Ä¢ May be occasionally unavailable</div>
                    </div>
                </div>
            </div>
            
            <div class="challenge-layout">
                <div class="challenge-viz">
                    <div class="view-tabs no-print">
                        <button class="view-tab active" onclick="switchChallengeView('numerical', this)">üî¢ Numerical</button>
                        <button class="view-tab" onclick="switchChallengeView('staircase', this)">üìä Staircase</button>
                        <button class="view-tab" onclick="switchChallengeView('numberline', this)">‚û°Ô∏è Number Line</button>
                    </div>
                    
                    <div class="legend-box no-print" id="challengeLegend" style="display: none;">
                        <div class="legend-item"><div class="legend-color" style="background: #0f766e;"></div><span>Our Series</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>Comparison</span></div>
                    </div>
                    
                    <canvas id="challenge-canvas" width="680" height="300"></canvas>
                    
                    <div class="viz-controls no-print">
                        <button class="step-btn" onclick="challengeStepBack()">‚àí</button>
                        <div class="step-counter">n = <span id="challengeTermDisplay">1</span></div>
                        <button class="step-btn" onclick="challengeStepForward()">+</button>
                        <button class="btn" onclick="challengeAnimate()" id="challengeAnimateBtn" style="margin-left: 1rem;">‚ñ∂ Animate</button>
                    </div>
                    
                    <div class="solution-box" id="solutionBox">
                        <div class="solution-header">
                            <h3>Solution</h3>
                            <div class="solution-problem" id="solutionProblem"></div>
                        </div>
                        <div class="solution-content" id="solutionContent"></div>
                        <button class="btn btn-primary print-btn no-print" onclick="printSolution()">üñ®Ô∏è Print Solution</button>
                    </div>
                </div>
                
                <div class="challenge-controls no-print">
                    <div class="series-display">
                        <h4>üéØ Determine the Behavior</h4>
                        <div class="series-formula" id="challengeSeriesFormula"></div>
                    </div>
                    
                    <!-- Step 1: Divergence Test -->
                    <div class="step-section active" id="challengeStep1">
                        <div class="step-header">What is lim(n‚Üí‚àû) a‚Çô ?</div>
                        <div class="input-row">
                            <input type="text" id="limitInput" placeholder="Enter limit (0, 1, ‚àû, etc.)">
                            <button class="btn" onclick="checkLimit()">Check</button>
                        </div>
                        <div id="limitFeedback" style="margin-top: 0.5rem; font-size: 0.8rem;"></div>
                    </div>
                    
                    <!-- Step 2: Choose Comparison -->
                    <div class="step-section hidden" id="challengeStep2">
                        <div class="step-header">Choose a comparison series:</div>
                        <div class="comparison-options" id="comparisonOptions"></div>
                    </div>
                    
                    <!-- Step 3: Justify -->
                    <div class="step-section hidden" id="challengeStep3">
                        <div class="step-header">Why does this comparison help?</div>
                        <div class="reasoning-options" id="reasoningOptions">
                            <button class="reason-btn" onclick="selectReason('smaller-conv', this)">Our series is <strong>smaller</strong> and comparison <strong>converges</strong></button>
                            <button class="reason-btn" onclick="selectReason('bigger-div', this)">Our series is <strong>bigger</strong> and comparison <strong>diverges</strong></button>
                            <button class="reason-btn" onclick="selectReason('bigger-conv', this)">Our series is <strong>bigger</strong> and comparison <strong>converges</strong></button>
                            <button class="reason-btn" onclick="selectReason('smaller-div', this)">Our series is <strong>smaller</strong> and comparison <strong>diverges</strong></button>
                        </div>
                    </div>
                    
                    <!-- MathPal Box with AI -->
                    <div class="mathpal-box">
                        <div class="mathpal-header">
                            <svg width="20" height="20" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="#e6fffb"/>
                                <rect x="35" y="60" width="30" height="25" fill="#0f766e" rx="3"/>
                                <rect x="30" y="35" width="40" height="30" fill="#10b981" rx="8"/>
                                <circle cx="40" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                                <circle cx="60" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                                <path d="M 40 55 Q 50 60 60 55" stroke="#0f766e" stroke-width="2" fill="none"/>
                            </svg>
                            MathPal
                        </div>
                        <div class="mathpal-thinking" id="mathpalThinking">
                            <span>Thinking</span>
                            <div class="thinking-dots"><span></span><span></span><span></span></div>
                        </div>
                        <div class="mathpal-text" id="mathpalText">Hey! Let's figure this one out together. First, what happens to the general term as n gets really big?</div>
                        <div class="hint-buttons" id="hintButtons">
                            <button class="hint-btn" onclick="requestHint('nudge')">üí≠ Nudge</button>
                            <button class="hint-btn" onclick="requestHint('observation')">üîç What to look for</button>
                            <button class="hint-btn" onclick="requestHint('strategy')">ü§ù Work together</button>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 0.75rem;">
                        <button class="btn btn-primary" onclick="newChallenge()">üé≤ New Problem</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =========================================
        // RENDER MATH HELPER
        // =========================================
        function renderMath(element, latex, displayMode = false) {
            if (!element) return;
            try {
                katex.render(latex, element, { displayMode: displayMode, throwOnError: false });
            } catch(e) {
                element.textContent = latex;
            }
        }
        
        // =========================================
        // GLOBAL STATE
        // =========================================
        let currentSeries = 'geometric';
        let seriesTerms = [];
        let partialSums = [];
        let currentTermIndex = 0;
        const maxTerms = 100;
        let animationId = null;
        let isAnimating = false;
        
        let divergenceAnimationId = null;
        let divergenceFrame = 0;
        
        // Challenge state
        let challengeProblem = null;
        let selectedComparison = null;
        let selectedReason = null;
        let challengeTerms = 50;
        let challengeView = 'numerical';
        let challengeAnimId = null;
        
        // Series configurations for number line
        const seriesConfig = {
            geometric: { minX: 0, maxX: 3 },
            harmonic: { minX: 0, maxX: 6 },
            'p-series': { minX: 0, maxX: 4 },
            alternating: { minX: -0.5, maxX: 1.5 },
            telescoping: { minX: 0, maxX: 1.5 }
        };
        
        // Famous comparison series
        const famousSeries = {
            'harmonic': { name: '1/n', latex: '\\frac{1}{n}', fn: n => 1/n, diverges: true },
            'p2': { name: '1/n¬≤', latex: '\\frac{1}{n^2}', fn: n => 1/(n*n), diverges: false },
            'p1.5': { name: '1/(n‚àön)', latex: '\\frac{1}{n\\sqrt{n}}', fn: n => 1/Math.pow(n, 1.5), diverges: false },
            'sqrt': { name: '1/‚àön', latex: '\\frac{1}{\\sqrt{n}}', fn: n => 1/Math.sqrt(n), diverges: true },
            'p3': { name: '1/n¬≥', latex: '\\frac{1}{n^3}', fn: n => 1/(n*n*n), diverges: false },
            'half-harmonic': { name: '1/(2n)', latex: '\\frac{1}{2n}', fn: n => 1/(2*n), diverges: true }
        };
        
        // Challenge problems
        const challengeProblems = [
            {
                name: '1/‚àön',
                latex: '\\sum_{n=1}^{\\infty} \\frac{1}{\\sqrt{n}}',
                termLatex: '\\frac{1}{\\sqrt{n}}',
                fn: n => 1/Math.sqrt(n),
                limit: '0',
                diverges: true,
                isPSeries: true,
                pValue: 0.5,
                comparisons: ['harmonic', 'p2', 'p1.5'],
                bestComparison: 'harmonic',
                bestReason: 'bigger-div',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = 1/‚àön ‚Üí 0. Since the limit is 0, the Divergence Test is inconclusive, and we must investigate further.",
                    comparison: "We compare with the harmonic series Œ£(1/n). For n ‚â• 1, we have ‚àön ‚â§ n, which means 1/‚àön ‚â• 1/n.",
                    inequality: "For all n ‚â• 1:\n\n‚àön ‚â§ n\n\nTherefore 1/‚àön ‚â• 1/n",
                    conclusion: "Since Œ£(1/n) diverges (harmonic series) and our series has larger terms, by the Comparison Test, the given series DIVERGES.",
                    note: "This is actually a p-series with p = 1/2 < 1, which also tells us directly that it diverges."
                }
            },
            {
                name: '1/(n¬≤+n)',
                latex: '\\sum_{n=1}^{\\infty} \\frac{1}{n^2+n}',
                termLatex: '\\frac{1}{n^2+n}',
                fn: n => 1/(n*n+n),
                limit: '0',
                diverges: false,
                isPSeries: false,
                comparisons: ['harmonic', 'p2', 'p3'],
                bestComparison: 'p2',
                bestReason: 'smaller-conv',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = 1/(n¬≤+n) ‚Üí 0. Since the limit is 0, the Divergence Test is inconclusive, and we must investigate further.",
                    comparison: "For large values of n, we have n¬≤+n ‚âà n¬≤, so 1/(n¬≤+n) ‚âà 1/n¬≤. This suggests comparison with the p-series Œ£(1/n¬≤).",
                    inequality: "We can verify that for all n ‚â• 1:\n\nn¬≤+n > n¬≤\n\nTherefore 1/(n¬≤+n) < 1/n¬≤",
                    conclusion: "Since Œ£(1/n¬≤) converges (p-series with p = 2 > 1) and our series has smaller terms, by the Comparison Test, the given series CONVERGES."
                }
            },
            {
                name: '1/(n¬≤+2n)',
                latex: '\\sum_{n=1}^{\\infty} \\frac{1}{n^2+2n}',
                termLatex: '\\frac{1}{n^2+2n}',
                fn: n => 1/(n*n+2*n),
                limit: '0',
                diverges: false,
                isPSeries: false,
                comparisons: ['harmonic', 'p2', 'p1.5'],
                bestComparison: 'p2',
                bestReason: 'smaller-conv',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = 1/(n¬≤+2n) ‚Üí 0. Since the limit is 0, the Divergence Test is inconclusive, and we must investigate further.",
                    comparison: "For large n, n¬≤+2n ‚âà n¬≤, so 1/(n¬≤+2n) ‚âà 1/n¬≤. We compare with Œ£(1/n¬≤).",
                    inequality: "For all n ‚â• 1:\n\nn¬≤+2n > n¬≤\n\nTherefore 1/(n¬≤+2n) < 1/n¬≤",
                    conclusion: "Since Œ£(1/n¬≤) converges (p-series with p = 2 > 1) and our series has smaller terms, by the Comparison Test, the given series CONVERGES."
                }
            },
            {
                name: '1/(‚àön - 1)',
                latex: '\\sum_{n=2}^{\\infty} \\frac{1}{\\sqrt{n}-1}',
                termLatex: '\\frac{1}{\\sqrt{n}-1}',
                fn: n => n < 2 ? 0 : 1/(Math.sqrt(n)-1),
                limit: '0',
                diverges: true,
                isPSeries: false,
                comparisons: ['harmonic', 'p2', 'sqrt'],
                bestComparison: 'sqrt',
                bestReason: 'bigger-div',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = 1/(‚àön-1) ‚Üí 0. Since the limit is 0, the Divergence Test is inconclusive, and we must investigate further.",
                    comparison: "For large n, ‚àön - 1 ‚âà ‚àön, so 1/(‚àön-1) ‚âà 1/‚àön. We compare with Œ£(1/‚àön).",
                    inequality: "For all n ‚â• 2:\n\n‚àön - 1 < ‚àön\n\nTherefore 1/(‚àön-1) > 1/‚àön",
                    conclusion: "Since Œ£(1/‚àön) diverges (p-series with p = 1/2 < 1) and our series has larger terms, by the Comparison Test, the given series DIVERGES."
                }
            },
            {
                name: 'ln(n)/n¬≤',
                latex: '\\sum_{n=2}^{\\infty} \\frac{\\ln(n)}{n^2}',
                termLatex: '\\frac{\\ln(n)}{n^2}',
                fn: n => n < 2 ? 0 : Math.log(n)/(n*n),
                limit: '0',
                diverges: false,
                isPSeries: false,
                comparisons: ['harmonic', 'p2', 'p1.5'],
                bestComparison: 'p1.5',
                bestReason: 'smaller-conv',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = ln(n)/n¬≤ ‚Üí 0 (since ln(n) grows slower than any power of n). The Divergence Test is inconclusive.",
                    comparison: "For large n, ln(n) < ‚àön. So ln(n)/n¬≤ < ‚àön/n¬≤ = 1/n^(3/2). We compare with Œ£(1/(n‚àön)).",
                    inequality: "For n ‚â• 3:\n\nln(n) < ‚àön\n\nTherefore ln(n)/n¬≤ < ‚àön/n¬≤ = 1/n^(3/2)",
                    conclusion: "Since Œ£(1/n^(3/2)) converges (p-series with p = 3/2 > 1) and our series eventually has smaller terms, by the Comparison Test, the given series CONVERGES."
                }
            },
            {
                name: '1/(n¬≤+1)',
                latex: '\\sum_{n=1}^{\\infty} \\frac{1}{n^2+1}',
                termLatex: '\\frac{1}{n^2+1}',
                fn: n => 1/(n*n+1),
                limit: '0',
                diverges: false,
                isPSeries: false,
                comparisons: ['harmonic', 'p2', 'p3'],
                bestComparison: 'p2',
                bestReason: 'smaller-conv',
                solution: {
                    intro: "We wish to determine whether the series converges or diverges.",
                    limitCheck: "First, we check the Divergence Test. As n ‚Üí ‚àû, the general term a‚Çô = 1/(n¬≤+1) ‚Üí 0. Since the limit is 0, the Divergence Test is inconclusive, and we must investigate further.",
                    comparison: "For large values of n, we have n¬≤+1 ‚âà n¬≤, so 1/(n¬≤+1) ‚âà 1/n¬≤. This suggests comparison with Œ£(1/n¬≤).",
                    inequality: "We can verify that for all n ‚â• 1:\n\nn¬≤+1 > n¬≤\n\nTherefore 1/(n¬≤+1) < 1/n¬≤",
                    conclusion: "Since Œ£(1/n¬≤) converges (p-series with p = 2 > 1) and our series has smaller terms, by the Comparison Test, the given series CONVERGES."
                }
            }
        ];
        
        // =========================================
        // INITIALIZATION
        // =========================================
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchToTab(btn.dataset.tab));
            });
            
            document.getElementById('paramSlider').addEventListener('input', (e) => {
                document.getElementById('paramValue').textContent = e.target.value;
                updateSeries();
            });
            
            document.getElementById('limitInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkLimit();
            });
            
            loadSeries('geometric', document.querySelector('.preset-pill'));
            // Initialize Tab 2 graphs at frame 0
            drawConvergentGraphs(0);
            drawDivergenceGraphs(0);
            drawDivTestGraphs(0);
            newChallenge();
        });
        
        function switchToTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            setTimeout(() => {
                if (tabId === 'explorer') drawAllViews();
                if (tabId === 'lab') {
                    drawConvergentGraphs(convergentFrame || 0);
                    drawDivergenceGraphs(divergenceFrame || 0);
                    drawDivTestGraphs(divtestFrame || 0);
                }
                if (tabId === 'challenge') drawChallengeView();
            }, 100);
        }
        
        // =========================================
        // TAB 1: EXPLORER
        // =========================================
        function loadSeries(type, btn) {
            currentSeries = type;
            document.querySelectorAll('.preset-pill').forEach(p => p.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            const paramControl = document.getElementById('parameterControl');
            const paramSlider = document.getElementById('paramSlider');
            const paramLabel = document.getElementById('paramLabel');
            
            if (type === 'geometric') {
                paramControl.style.display = 'block';
                paramLabel.textContent = 'Common Ratio (r)';
                paramSlider.min = '0.1'; paramSlider.max = '1.5'; paramSlider.step = '0.1'; paramSlider.value = '0.5';
            } else if (type === 'p-series') {
                paramControl.style.display = 'block';
                paramLabel.textContent = 'Exponent (p)';
                paramSlider.min = '0.5'; paramSlider.max = '3'; paramSlider.step = '0.1'; paramSlider.value = '2';
            } else {
                paramControl.style.display = 'none';
            }
            
            document.getElementById('paramValue').textContent = paramSlider.value;
            stopAnimation();
            updateSeries();
        }
        
        function updateSeries() {
            const param = parseFloat(document.getElementById('paramSlider').value);
            
            seriesTerms = [];
            for (let i = 1; i <= maxTerms; i++) {
                switch(currentSeries) {
                    case 'geometric': seriesTerms.push(Math.pow(param, i-1)); break;
                    case 'harmonic': seriesTerms.push(1/i); break;
                    case 'p-series': seriesTerms.push(1/Math.pow(i, param)); break;
                    case 'alternating': seriesTerms.push(Math.pow(-1, i+1)/i); break;
                    case 'telescoping': seriesTerms.push(1/i - 1/(i+1)); break;
                }
            }
            
            partialSums = [];
            let sum = 0;
            for (let t of seriesTerms) { sum += t; partialSums.push(sum); }
            
            // Update config for dynamic series
            const allSums = [...partialSums];
            const minS = Math.min(0, ...allSums);
            const maxS = Math.max(...allSums);
            
            if (currentSeries === 'geometric') {
                seriesConfig.geometric.minX = 0;
                seriesConfig.geometric.maxX = param < 1 ? Math.min(1/(1-param) * 1.1, 10) : maxS * 1.1;
            } else if (currentSeries === 'alternating') {
                seriesConfig.alternating.minX = minS * 1.2;
                seriesConfig.alternating.maxX = maxS * 1.2;
            } else if (currentSeries === 'harmonic') {
                seriesConfig.harmonic.maxX = maxS * 1.05;
            } else if (currentSeries === 'p-series') {
                seriesConfig['p-series'].maxX = param > 1 ? maxS * 1.2 : maxS * 1.05;
            }
            
            let status = '', formula = '';
            switch(currentSeries) {
                case 'geometric':
                    status = param < 1 ? 'Settles' : 'Grows';
                    formula = `Œ£ (${param})‚Åø`;
                    break;
                case 'harmonic': status = 'Grows'; formula = 'Œ£ 1/n'; break;
                case 'p-series':
                    status = param > 1 ? 'Settles' : 'Grows';
                    formula = `Œ£ 1/n·µñ (p=${param})`;
                    break;
                case 'alternating': status = 'Settles'; formula = 'Œ£ (-1)‚Åø‚Å∫¬π/n'; break;
                case 'telescoping': status = 'Settles ‚Üí 1'; formula = 'Œ£ (1/n ‚àí 1/(n+1))'; break;
            }
            
            document.getElementById('convergenceStatus').textContent = status;
            document.getElementById('formulaDisplay').textContent = formula;
            document.getElementById('maxTermsDisplay').textContent = maxTerms;
            
            currentTermIndex = 1; // Start at first term
            updateDisplays();
            drawAllViews();
        }
        
        function updateDisplays() {
            const idx = Math.max(0, currentTermIndex - 1);
            const sum = currentTermIndex > 0 ? partialSums[idx] : 0;
            
            document.getElementById('partialSum').textContent = sum.toFixed(6);
            document.getElementById('currentTermDisplay').textContent = currentTermIndex;
            
            const display = document.getElementById('sumDisplay');
            const sumStr = sum.toFixed(8);
            const prevSum = currentTermIndex > 1 ? partialSums[idx-1].toFixed(8) : '0.00000000';
            
            display.innerHTML = sumStr.split('').map((d, i) => {
                if (d === '.') return '.';
                const cls = (currentTermIndex <= 1 || (i < prevSum.length && d === prevSum[i])) ? 'digit-stable' : 'digit-changing';
                return `<span class="${cls}">${d}</span>`;
            }).join('');
            
            document.getElementById('termInfo').textContent = currentTermIndex > 0 
                ? `Term ${currentTermIndex}: ${seriesTerms[idx] >= 0 ? '+' : ''}${seriesTerms[idx].toFixed(5)}`
                : 'No terms';
            
            document.getElementById('stepBackBtn').disabled = currentTermIndex <= 1;
            document.getElementById('stepForwardBtn').disabled = currentTermIndex >= maxTerms;
        }
        
        function drawAllViews() {
            drawNumberLine();
            drawStaircase();
        }
        
        function drawNumberLine() {
            const canvas = document.getElementById('numberline-canvas');
            if (!canvas || !canvas.offsetParent) return;
            
            canvas.width = canvas.offsetWidth;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 50;
            const lineY = canvas.height / 2 + 20;
            const width = canvas.width - 2 * padding;
            
            // Calculate dynamic range from actual partial sums
            const displaySums = partialSums.slice(0, currentTermIndex);
            const allVals = [...displaySums, 0];
            
            // Get range for all 100 terms to keep scale consistent during animation
            let nlMin = Math.min(0, ...partialSums) * 1.1;
            let nlMax = Math.max(...partialSums) * 1.1;
            
            // Handle edge cases
            if (nlMin === nlMax) { nlMin = 0; nlMax = 1; }
            if (!isFinite(nlMin)) nlMin = 0;
            if (!isFinite(nlMax)) nlMax = 1;
            
            const nlRange = nlMax - nlMin || 1;
            const getX = val => padding + ((val - nlMin) / nlRange) * width;
            
            // Draw number line
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, lineY);
            ctx.lineTo(padding + width, lineY);
            ctx.stroke();
            
            // Arrow at end
            ctx.beginPath();
            ctx.moveTo(padding + width - 8, lineY - 5);
            ctx.lineTo(padding + width, lineY);
            ctx.lineTo(padding + width - 8, lineY + 5);
            ctx.stroke();
            
            // Tick marks and labels
            ctx.fillStyle = '#666';
            ctx.font = '10px monospace';
            ctx.textAlign = 'center';
            const tickCount = 6;
            for (let i = 0; i <= tickCount; i++) {
                const val = nlMin + (nlRange * i / tickCount);
                const x = getX(val);
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, lineY - 5);
                ctx.lineTo(x, lineY + 5);
                ctx.stroke();
                ctx.fillStyle = '#666';
                ctx.fillText(val.toFixed(1), x, lineY + 18);
            }
            
            if (currentTermIndex === 0) {
                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Press + or Play to see accumulation', canvas.width/2, lineY - 40);
                return;
            }
            
            // Draw accumulation arcs
            const displayTerms = seriesTerms.slice(0, currentTermIndex);
            let prevX = getX(0);
            
            for (let i = 0; i < currentTermIndex; i++) {
                const sum = displaySums[i];
                const term = displayTerms[i];
                const x = getX(sum);
                
                // Draw arc
                if (Math.abs(x - prevX) > 2) {
                    const midX = (prevX + x) / 2;
                    const arcHeight = Math.min(25, Math.abs(x - prevX) * 0.3);
                    const arcY = term >= 0 ? lineY - arcHeight : lineY + arcHeight;
                    
                    ctx.strokeStyle = i === currentTermIndex - 1 ? 'rgba(15,118,110,0.8)' : 'rgba(15,118,110,0.2)';
                    ctx.lineWidth = i === currentTermIndex - 1 ? 2 : 1;
                    ctx.beginPath();
                    ctx.moveTo(prevX, lineY);
                    ctx.quadraticCurveTo(midX, arcY, x, lineY);
                    ctx.stroke();
                }
                
                prevX = x;
            }
            
            // Final point and label
            const finalSum = displaySums[currentTermIndex - 1];
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(getX(finalSum), lineY, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`S${currentTermIndex}`, getX(finalSum), lineY - 15);
        }
        
        function drawStaircase() {
            const canvas = document.getElementById('staircase-canvas');
            if (!canvas || !canvas.offsetParent) return;
            
            canvas.width = canvas.offsetWidth;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 30;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            
            ctx.strokeStyle = '#ddd';
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            if (currentTermIndex === 0) return;
            
            const displaySums = partialSums.slice(0, currentTermIndex);
            const maxSum = Math.max(...partialSums) * 1.1;
            const minSum = Math.min(0, ...partialSums);
            const range = (maxSum - minSum) || 1;
            
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const xStep = width / maxTerms;
            let prevY = canvas.height - padding - ((0 - minSum) / range) * height;
            ctx.moveTo(padding, prevY);
            
            for (let i = 0; i < currentTermIndex; i++) {
                const x = padding + (i + 1) * xStep;
                const y = canvas.height - padding - ((displaySums[i] - minSum) / range) * height;
                ctx.lineTo(x, prevY);
                ctx.lineTo(x, y);
                prevY = y;
            }
            ctx.stroke();
            
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(padding + currentTermIndex * xStep, prevY, 4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function stepForward() { if (currentTermIndex < maxTerms) { currentTermIndex++; updateDisplays(); drawAllViews(); } }
        function stepBack() { if (currentTermIndex > 1) { currentTermIndex--; updateDisplays(); drawAllViews(); } }
        
        function toggleAnimation() { isAnimating ? stopAnimation() : startAnimation(); }
        
        function startAnimation() {
            isAnimating = true;
            document.getElementById('animateBtn').textContent = '‚è∏ Pause';
            currentTermIndex = 1;
            animationId = setInterval(() => {
                if (currentTermIndex < maxTerms) { currentTermIndex++; updateDisplays(); drawAllViews(); }
                else stopAnimation();
            }, 60);
        }
        
        function stopAnimation() {
            isAnimating = false;
            document.getElementById('animateBtn').textContent = '‚ñ∂ Play';
            if (animationId) { clearInterval(animationId); animationId = null; }
        }
        
        function resetExplorer() {
            stopAnimation();
            currentTermIndex = 1;
            updateDisplays();
            drawAllViews();
        }
        
        // =========================================
        // TAB 2: COMPARISON LAB
        // =========================================
        function drawDivergenceGraphs(frame) {
            const n = Math.min(frame + 1, 100);
            
            const termsCanvas = document.getElementById('terms-canvas');
            if (termsCanvas) {
                const ctx = termsCanvas.getContext('2d');
                ctx.clearRect(0, 0, termsCanvas.width, termsCanvas.height);
                
                const p = 30, w = termsCanvas.width - 2*p, h = termsCanvas.height - 2*p;
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, termsCanvas.height - p); ctx.lineTo(termsCanvas.width - p, termsCanvas.height - p);
                ctx.stroke();
                
                ctx.strokeStyle = '#0f766e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 1; i <= n; i++) {
                    const x = p + (i/100) * w;
                    const y = termsCanvas.height - p - (1/i) * h;
                    i === 1 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                if (n > 0) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, termsCanvas.height - p - (1/n)*h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 30) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí 0', termsCanvas.width - p - 5, termsCanvas.height - p - 8);
                }
            }
            
            const sumsCanvas = document.getElementById('sums-canvas');
            if (sumsCanvas) {
                const ctx = sumsCanvas.getContext('2d');
                ctx.clearRect(0, 0, sumsCanvas.width, sumsCanvas.height);
                
                const p = 30, w = sumsCanvas.width - 2*p, h = sumsCanvas.height - 2*p;
                
                const sums = [];
                let s = 0;
                for (let i = 1; i <= n; i++) { s += 1/i; sums.push(s); }
                
                let maxS = 0, ts = 0;
                for (let i = 1; i <= 100; i++) ts += 1/i;
                maxS = ts * 1.1;
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, sumsCanvas.height - p); ctx.lineTo(sumsCanvas.width - p, sumsCanvas.height - p);
                ctx.stroke();
                
                if (n > 0) {
                    ctx.strokeStyle = '#0f766e';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = 0; i < sums.length; i++) {
                        const x = p + ((i+1)/100) * w;
                        const y = sumsCanvas.height - p - (sums[i]/maxS) * h;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    
                    ctx.fillStyle = '#f59e0b';
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, sumsCanvas.height - p - (sums[n-1]/maxS)*h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 30) {
                    ctx.fillStyle = '#c62828';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí ‚àû', sumsCanvas.width - p - 5, p + 15);
                }
            }
        }
        
        function animateDivergenceGraphs() {
            const btn = document.getElementById('divergenceAnimateBtn');
            if (divergenceAnimationId) {
                clearInterval(divergenceAnimationId);
                divergenceAnimationId = null;
                btn.textContent = '‚ñ∂ Animate';
                return;
            }
            divergenceFrame = 0;
            btn.textContent = '‚è∏ Pause';
            divergenceAnimationId = setInterval(() => {
                if (divergenceFrame < 100) { divergenceFrame++; drawDivergenceGraphs(divergenceFrame); }
                else { clearInterval(divergenceAnimationId); divergenceAnimationId = null; btn.textContent = 'üîÑ Replay'; }
            }, 40);
        }
        
        // Convergent series (geometric r=0.5)
        let convergentFrame = 0;
        let convergentAnimationId = null;
        
        function drawConvergentGraphs(frame) {
            const n = Math.min(frame + 1, 100);
            
            // Terms canvas
            const termsCanvas = document.getElementById('conv-terms-canvas');
            if (termsCanvas) {
                const ctx = termsCanvas.getContext('2d');
                ctx.clearRect(0, 0, termsCanvas.width, termsCanvas.height);
                
                const p = 30, w = termsCanvas.width - 2*p, h = termsCanvas.height - 2*p;
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, termsCanvas.height - p); ctx.lineTo(termsCanvas.width - p, termsCanvas.height - p);
                ctx.stroke();
                
                ctx.strokeStyle = '#0f766e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 1; i <= n; i++) {
                    const x = p + (i/100) * w;
                    const term = Math.pow(0.5, i);
                    const y = termsCanvas.height - p - term * h;
                    i === 1 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                if (n > 0) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, termsCanvas.height - p - Math.pow(0.5, n) * h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 20) {
                    ctx.fillStyle = '#10b981';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí 0', termsCanvas.width - p - 5, termsCanvas.height - p - 8);
                }
            }
            
            // Sums canvas
            const sumsCanvas = document.getElementById('conv-sums-canvas');
            if (sumsCanvas) {
                const ctx = sumsCanvas.getContext('2d');
                ctx.clearRect(0, 0, sumsCanvas.width, sumsCanvas.height);
                
                const p = 30, w = sumsCanvas.width - 2*p, h = sumsCanvas.height - 2*p;
                
                const sums = [];
                let s = 0;
                for (let i = 1; i <= n; i++) { s += Math.pow(0.5, i); sums.push(s); }
                
                const maxS = 2.2; // Sum approaches 1, but display up to 2.2 for context
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, sumsCanvas.height - p); ctx.lineTo(sumsCanvas.width - p, sumsCanvas.height - p);
                ctx.stroke();
                
                // Draw limit line at 1
                ctx.strokeStyle = '#10b981';
                ctx.setLineDash([5, 3]);
                ctx.beginPath();
                const limitY = sumsCanvas.height - p - (1/maxS) * h;
                ctx.moveTo(p, limitY);
                ctx.lineTo(sumsCanvas.width - p, limitY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                if (n > 0) {
                    ctx.strokeStyle = '#0f766e';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = 0; i < sums.length; i++) {
                        const x = p + ((i+1)/100) * w;
                        const y = sumsCanvas.height - p - (sums[i]/maxS) * h;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    
                    ctx.fillStyle = '#f59e0b';
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, sumsCanvas.height - p - (sums[n-1]/maxS)*h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 30) {
                    ctx.fillStyle = '#10b981';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí 1', sumsCanvas.width - p - 5, limitY - 5);
                }
            }
        }
        
        function animateConvergentGraphs() {
            const btn = document.getElementById('convAnimateBtn');
            if (convergentAnimationId) {
                clearInterval(convergentAnimationId);
                convergentAnimationId = null;
                btn.textContent = '‚ñ∂ Animate';
                return;
            }
            convergentFrame = 0;
            btn.textContent = '‚è∏ Pause';
            convergentAnimationId = setInterval(() => {
                if (convergentFrame < 100) { convergentFrame++; drawConvergentGraphs(convergentFrame); }
                else { clearInterval(convergentAnimationId); convergentAnimationId = null; btn.textContent = 'üîÑ Replay'; }
            }, 40);
        }
        
        // Divergence Test example (n/(n+1))
        let divtestFrame = 0;
        let divtestAnimationId = null;
        
        function drawDivTestGraphs(frame) {
            const n = Math.min(frame + 1, 100);
            
            // Terms canvas
            const termsCanvas = document.getElementById('divtest-terms-canvas');
            if (termsCanvas) {
                const ctx = termsCanvas.getContext('2d');
                ctx.clearRect(0, 0, termsCanvas.width, termsCanvas.height);
                
                const p = 30, w = termsCanvas.width - 2*p, h = termsCanvas.height - 2*p;
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, termsCanvas.height - p); ctx.lineTo(termsCanvas.width - p, termsCanvas.height - p);
                ctx.stroke();
                
                // Draw limit line at 1
                ctx.strokeStyle = '#c62828';
                ctx.setLineDash([5, 3]);
                ctx.beginPath();
                const limitY = termsCanvas.height - p - h;
                ctx.moveTo(p, limitY);
                ctx.lineTo(termsCanvas.width - p, limitY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.strokeStyle = '#0f766e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 1; i <= n; i++) {
                    const x = p + (i/100) * w;
                    const term = i/(i+1);
                    const y = termsCanvas.height - p - term * h;
                    i === 1 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                if (n > 0) {
                    ctx.fillStyle = '#f59e0b';
                    const term = n/(n+1);
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, termsCanvas.height - p - term * h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 30) {
                    ctx.fillStyle = '#c62828';
                    ctx.font = 'bold 10px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí 1 ‚â† 0', termsCanvas.width - p - 5, limitY - 5);
                }
            }
            
            // Sums canvas
            const sumsCanvas = document.getElementById('divtest-sums-canvas');
            if (sumsCanvas) {
                const ctx = sumsCanvas.getContext('2d');
                ctx.clearRect(0, 0, sumsCanvas.width, sumsCanvas.height);
                
                const p = 30, w = sumsCanvas.width - 2*p, h = sumsCanvas.height - 2*p;
                
                const sums = [];
                let s = 0;
                for (let i = 1; i <= n; i++) { s += i/(i+1); sums.push(s); }
                
                // Calculate max for 100 terms
                let maxS = 0;
                let ts = 0;
                for (let i = 1; i <= 100; i++) ts += i/(i+1);
                maxS = ts * 1.1;
                
                ctx.strokeStyle = '#ddd';
                ctx.beginPath();
                ctx.moveTo(p, p); ctx.lineTo(p, sumsCanvas.height - p); ctx.lineTo(sumsCanvas.width - p, sumsCanvas.height - p);
                ctx.stroke();
                
                if (n > 0) {
                    ctx.strokeStyle = '#0f766e';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = 0; i < sums.length; i++) {
                        const x = p + ((i+1)/100) * w;
                        const y = sumsCanvas.height - p - (sums[i]/maxS) * h;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    
                    ctx.fillStyle = '#f59e0b';
                    ctx.beginPath();
                    ctx.arc(p + (n/100)*w, sumsCanvas.height - p - (sums[n-1]/maxS)*h, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                
                if (n > 30) {
                    ctx.fillStyle = '#c62828';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('‚Üí ‚àû', sumsCanvas.width - p - 5, p + 15);
                }
            }
        }
        
        function animateDivTestGraphs() {
            const btn = document.getElementById('divtestAnimateBtn');
            if (divtestAnimationId) {
                clearInterval(divtestAnimationId);
                divtestAnimationId = null;
                btn.textContent = '‚ñ∂ Animate';
                return;
            }
            divtestFrame = 0;
            btn.textContent = '‚è∏ Pause';
            divtestAnimationId = setInterval(() => {
                if (divtestFrame < 100) { divtestFrame++; drawDivTestGraphs(divtestFrame); }
                else { clearInterval(divtestAnimationId); divtestAnimationId = null; btn.textContent = 'üîÑ Replay'; }
            }, 40);
        }
        
        function loadLabScenario(scenario, card) {
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
            if (card) card.classList.add('active');
            
            const canvas = document.getElementById('lab-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const p = 40, w = canvas.width - 2*p, h = canvas.height - 2*p;
            const n = 50;
            
            let series1 = [], series2 = [], series3 = [];
            let label1 = '', label2 = '', label3 = '';
            let resultText = '', resultClass = '';
            
            for (let i = 1; i <= n; i++) {
                switch(scenario) {
                    case 'ceiling':
                        series1.push(sumTo(j => 1/Math.pow(j,1.5), i)); label1 = '1/(n‚àön) (conv)';
                        series2.push(sumTo(j => 1/(j*j), i)); label2 = '1/n¬≤ (ours)';
                        resultText = '<strong>‚úì Conclusive!</strong> Our series is smaller than one that converges ‚Üí ours must converge.';
                        resultClass = 'valid';
                        break;
                    case 'floor':
                        series1.push(sumTo(j => 1/j, i)); label1 = '1/n (div)';
                        series2.push(sumTo(j => 1/Math.sqrt(j), i)); label2 = '1/‚àön (ours)';
                        resultText = '<strong>‚úì Conclusive!</strong> Our series is bigger than one that diverges ‚Üí ours must diverge.';
                        resultClass = 'valid';
                        break;
                    case 'bigger-converge':
                        series1.push(sumTo(j => 1/(j*j), i)); label1 = '1/n¬≤ (conv)';
                        series2.push(sumTo(j => 1/j, i)); label2 = '1/n (div)';
                        series3.push(sumTo(j => 1/Math.pow(j,1.5), i)); label3 = '1/(n‚àön) (conv)';
                        resultText = '<strong>‚úó Inconclusive!</strong> Bigger than convergent could go either way. Example: 1/n diverges, but 1/(n‚àön) converges ‚Äî both are bigger than 1/n¬≤.';
                        resultClass = 'invalid';
                        break;
                    case 'smaller-diverge':
                        series1.push(sumTo(j => 1/Math.sqrt(j), i)); label1 = '1/‚àön (div)';
                        series2.push(sumTo(j => 1/(j*j), i)); label2 = '1/n¬≤ (conv)';
                        series3.push(sumTo(j => 1/j, i)); label3 = '1/n (div)';
                        resultText = '<strong>‚úó Inconclusive!</strong> Smaller than divergent could go either way. Example: 1/n¬≤ converges, but 1/n diverges ‚Äî both are smaller than 1/‚àön.';
                        resultClass = 'invalid';
                        break;
                }
            }
            
            const allVals = [...series1, ...series2, ...(series3 || [])];
            const maxV = Math.max(...allVals) * 1.05;
            const yScale = h / maxV;
            const xStep = w / n;
            
            ctx.strokeStyle = '#ddd';
            ctx.beginPath();
            ctx.moveTo(p, p); ctx.lineTo(p, canvas.height - p); ctx.lineTo(canvas.width - p, canvas.height - p);
            ctx.stroke();
            
            // Series 1 (orange)
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            series1.forEach((v, i) => { const x = p + i*xStep, y = canvas.height - p - v*yScale; i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); });
            ctx.stroke();
            
            // Series 2 (teal)
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            series2.forEach((v, i) => { const x = p + i*xStep, y = canvas.height - p - v*yScale; i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); });
            ctx.stroke();
            
            // Series 3 if exists (purple)
            if (series3.length) {
                ctx.strokeStyle = '#7c3aed';
                ctx.lineWidth = 2.5;
                ctx.beginPath();
                series3.forEach((v, i) => { const x = p + i*xStep, y = canvas.height - p - v*yScale; i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); });
                ctx.stroke();
            }
            
            // Labels
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#f59e0b'; ctx.fillText('‚óè ' + label1, p + 5, p + 12);
            ctx.fillStyle = '#0f766e'; ctx.fillText('‚óè ' + label2, p + 5, p + 26);
            if (label3) { ctx.fillStyle = '#7c3aed'; ctx.fillText('‚óè ' + label3, p + 5, p + 40); }
            
            const result = document.getElementById('lab-result');
            result.innerHTML = resultText;
            result.className = 'lab-result ' + resultClass;
            result.style.display = 'block';
        }
        
        function sumTo(fn, n) { let s = 0; for (let i = 1; i <= n; i++) s += fn(i); return s; }
        
        // =========================================
        // MATHPAL AI FUNCTIONS
        // =========================================
        function showMathPalThinking() {
            document.getElementById('mathpalThinking').classList.add('show');
            document.getElementById('mathpalText').style.display = 'none';
        }
        
        function hideMathPalThinking() {
            document.getElementById('mathpalThinking').classList.remove('show');
            document.getElementById('mathpalText').style.display = 'block';
        }
        
        function setMathPalText(text) {
            const el = document.getElementById('mathpalText');
            el.innerHTML = text;
            // Render any LaTeX in the response
            if (text.includes('$')) {
                el.innerHTML = text.replace(/\$([^$]+)\$/g, (match, latex) => {
                    const span = document.createElement('span');
                    try {
                        katex.render(latex, span, { throwOnError: false });
                        return span.outerHTML;
                    } catch(e) {
                        return match;
                    }
                });
            }
        }
        
        function getMathPalFallback(context) {
            const fallbacks = {
                intro: "Hey! Let's figure this one out together. What happens to the general term as n gets really big?",
                limitCorrect: "Nice! The limit is 0, so we can't use the Divergence Test. I'm thinking we need to compare this to a series we know. What do you think?",
                limitWrong: "Hmm, I got something different. Try plugging in really big values for n ‚Äî what happens to the fraction?",
                comparisonSelected: "Good pick! Now let's think about which series is bigger. Try animating the graph to see!",
                reasonIncorrect: "Wait, that reasoning doesn't quite work. Remember: smaller than convergent = convergent, bigger than divergent = divergent. The other combinations are inconclusive.",
                hint_nudge: "Take a look at the dominant terms in the numerator and denominator. For really large n, which one 'wins'?",
                hint_observation: "Try increasing the number of terms. Watch how the partial sums grow ‚Äî does it look like it's leveling off or shooting up?",
                hint_strategy: "Let's work through this: first find the limit, then if it's 0, pick a comparison series that looks similar for large n."
            };
            return fallbacks[context] || "Let's keep working on this together!";
        }
        
        async function callMathPalAI(prompt, context) {
            showMathPalThinking();
            
            const mathpalPrompt = `You are MathPal, a friendly peer study buddy (not a teacher) helping with infinite series.
Speak casually like a classmate: "I got...", "I tried...", "Want to see what I think?"
Keep responses to 2-3 SHORT sentences, very conversational.
Use $ for LaTeX math when showing formulas.
Never lecture ‚Äî suggest and explore together.

Current problem: ${challengeProblem.name} = ${challengeProblem.termLatex}
The series ${challengeProblem.diverges ? 'diverges' : 'converges'}.
Correct comparison: ${challengeProblem.comparison} with reasoning: ${challengeProblem.reason}

Context: ${context}

${prompt}`;
            
            for (let attempt = 0; attempt <= 2; attempt++) {
                try {
                    if (attempt > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: mathpalPrompt }] }] 
                        })
                    });
                    
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error('Empty response');
                    
                    hideMathPalThinking();
                    setMathPalText(text);
                    return text;
                    
                } catch (error) {
                    console.log('MathPal API attempt failed:', error);
                    if (attempt === 2) {
                        hideMathPalThinking();
                        setMathPalText(getMathPalFallback(context));
                        return null;
                    }
                }
            }
        }
        
        async function requestHint(type) {
            const hintPrompts = {
                nudge: `Give a very gentle hint about ${challengeProblem.name}. Don't give away the answer, just point them in the right direction. One sentence max.`,
                observation: `Suggest something specific to observe in the visualization for ${challengeProblem.name}. What pattern should they look for?`,
                strategy: `Share your thinking process for analyzing ${challengeProblem.name}. What steps would you take? Keep it collaborative.`
            };
            
            const hintContexts = {
                nudge: 'hint_nudge',
                observation: 'hint_observation', 
                strategy: 'hint_strategy'
            };
            
            await callMathPalAI(hintPrompts[type], hintContexts[type]);
        }
        
        // =========================================
        // TAB 3: CHALLENGE
        // =========================================
        function newChallenge() {
            challengeProblem = challengeProblems[Math.floor(Math.random() * challengeProblems.length)];
            selectedComparison = null;
            selectedReason = null;
            challengeTerms = 1;
            
            // Reset UI
            renderMath(document.getElementById('challengeSeriesFormula'), challengeProblem.latex, true);
            
            document.getElementById('challengeStep1').className = 'step-section active';
            document.getElementById('challengeStep2').className = 'step-section hidden';
            document.getElementById('challengeStep3').className = 'step-section hidden';
            document.getElementById('limitInput').value = '';
            document.getElementById('limitFeedback').innerHTML = '';
            document.getElementById('solutionBox').classList.remove('show');
            document.getElementById('challengeLegend').style.display = 'none';
            
            document.querySelectorAll('.comp-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.reason-btn').forEach(b => b.classList.remove('selected'));
            
            // Call MathPal for intro
            callMathPalAI(
                `Greet the student and ask about finding the limit of ${challengeProblem.termLatex} as n approaches infinity. Be encouraging and curious.`,
                'intro'
            );
            
            document.getElementById('challengeTermDisplay').textContent = challengeTerms;
            drawChallengeView();
        }
        
        function checkLimit() {
            const input = document.getElementById('limitInput').value.trim().toLowerCase();
            const feedback = document.getElementById('limitFeedback');
            
            const isZero = input === '0' || input === 'zero';
            const isCorrectNonZero = !challengeProblem.limit === '0' && (input === challengeProblem.limit);
            
            if (isZero && challengeProblem.limit === '0') {
                feedback.innerHTML = '<span style="color: var(--success);">‚úì Correct!</span>';
                document.getElementById('challengeStep1').className = 'step-section completed';
                document.getElementById('challengeStep2').className = 'step-section active';
                document.getElementById('challengeStep2').classList.remove('hidden');
                
                // Build comparison options
                buildComparisonOptions();
                
                // Call MathPal
                callMathPalAI(
                    `The student correctly found the limit is 0. Celebrate briefly and suggest thinking about comparison series. What series might behave similarly to ${challengeProblem.termLatex}?`,
                    'limitCorrect'
                );
            } else if (input === '' || input === null) {
                feedback.innerHTML = '<span style="color: var(--accent-amber);">Enter a value</span>';
            } else if (!isZero && challengeProblem.limit === '0') {
                feedback.innerHTML = '<span style="color: var(--accent-red);">Not quite. Think about what happens as n gets very large.</span>';
                callMathPalAI(
                    `The student guessed "${input}" but the limit of ${challengeProblem.termLatex} is actually 0. Give a gentle hint without revealing the answer. Maybe suggest plugging in large values.`,
                    'limitWrong'
                );
            } else {
                feedback.innerHTML = '<span style="color: var(--success);">‚úì Correct! Since the limit ‚â† 0, the series diverges by the Divergence Test.</span>';
                showSolution();
            }
        }
        
        function buildComparisonOptions() {
            const container = document.getElementById('comparisonOptions');
            container.innerHTML = '';
            
            challengeProblem.comparisons.forEach(compId => {
                const comp = famousSeries[compId];
                const btn = document.createElement('button');
                btn.className = 'comp-option';
                btn.onclick = () => selectComparison(compId, btn);
                
                const nameSpan = document.createElement('span');
                nameSpan.id = 'comp-name-' + compId;
                renderMath(nameSpan, comp.latex);
                
                const tag = document.createElement('span');
                tag.className = 'behavior-tag ' + (comp.diverges ? 'diverges' : 'converges');
                tag.textContent = comp.diverges ? 'diverges' : 'converges';
                
                btn.appendChild(nameSpan);
                btn.appendChild(tag);
                container.appendChild(btn);
            });
        }
        
        function selectComparison(compId, btn) {
            selectedComparison = compId;
            document.querySelectorAll('.comp-option').forEach(o => o.classList.remove('selected'));
            if (btn) btn.classList.add('selected');
            
            document.getElementById('challengeStep2').className = 'step-section completed';
            document.getElementById('challengeStep3').className = 'step-section active';
            document.getElementById('challengeStep3').classList.remove('hidden');
            document.getElementById('challengeLegend').style.display = 'flex';
            
            const comp = famousSeries[compId];
            
            // Call MathPal
            callMathPalAI(
                `The student selected ${comp.name} as comparison for ${challengeProblem.name}. ${compId === challengeProblem.bestComparison ? 'Good choice!' : 'This might work but ' + famousSeries[challengeProblem.bestComparison].name + ' would be better.'} Ask them to think about whether ${challengeProblem.name} is bigger or smaller than ${comp.name}. Suggest animating the graph.`,
                'comparisonSelected'
            );
            
            drawChallengeView();
        }
        
        function selectReason(reason, btn) {
            selectedReason = reason;
            document.querySelectorAll('.reason-btn').forEach(b => b.classList.remove('selected'));
            if (btn) btn.classList.add('selected');
            
            const comp = famousSeries[selectedComparison];
            const isCorrectComparison = selectedComparison === challengeProblem.bestComparison;
            const isCorrectReason = reason === challengeProblem.bestReason;
            
            if (isCorrectReason && isCorrectComparison) {
                callMathPalAI(
                    `The student got it right! ${challengeProblem.name} ${challengeProblem.diverges ? 'diverges' : 'converges'} by comparison with ${comp.name}. Celebrate their success briefly.`,
                    'correct'
                );
                showSolution();
            } else if (reason === 'bigger-conv' || reason === 'smaller-div') {
                callMathPalAI(
                    `The student chose inconclusive reasoning: "${reason === 'bigger-conv' ? 'bigger than convergent' : 'smaller than divergent'}". Explain why this doesn't work ‚Äî give a counter-example if helpful. Keep it friendly.`,
                    'reasonIncorrect'
                );
            } else if (!isCorrectComparison) {
                // They have the right logic but wrong comparison
                callMathPalAI(
                    `The student has the right logic (${reason}) but applied it to ${comp.name} instead of ${famousSeries[challengeProblem.bestComparison].name}. Ask them to check if ${challengeProblem.name} is really ${reason.includes('smaller') ? 'smaller' : 'bigger'} than ${comp.name}. Suggest looking at the graph.`,
                    'wrongComparison'
                );
            } else {
                callMathPalAI(
                    `The student picked ${comp.name} (correct!) but chose wrong reasoning: ${reason}. The correct reasoning is ${challengeProblem.bestReason}. Give a hint about comparing the terms without revealing the answer.`,
                    'wrongReason'
                );
            }
        }
        
        function showSolution() {
            const sol = challengeProblem.solution;
            
            renderMath(document.getElementById('solutionProblem'), challengeProblem.latex, true);
            
            let content = `
                <p>${sol.intro}</p>
                <p>${sol.limitCheck}</p>
                <p>${sol.comparison}</p>
                <div class="math-block">${sol.inequality.replace(/\n/g, '<br>')}</div>
                <div class="conclusion">${sol.conclusion}</div>
            `;
            
            if (sol.note) {
                content += `<div class="note"><strong>Note:</strong> ${sol.note}</div>`;
            }
            
            document.getElementById('solutionContent').innerHTML = content;
            document.getElementById('solutionBox').classList.add('show');
            
            document.getElementById('challengeStep3').className = 'step-section completed';
        }
        
        function switchChallengeView(view, btn) {
            challengeView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            drawChallengeView();
        }
        
        function drawChallengeView() {
            const canvas = document.getElementById('challenge-canvas');
            if (!canvas || !challengeProblem) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const p = 50, w = canvas.width - 2*p, h = canvas.height - 2*p;
            
            // Calculate our series partial sums
            const ourSums = [];
            let s = 0;
            for (let i = 1; i <= challengeTerms; i++) {
                s += challengeProblem.fn(i);
                ourSums.push(s);
            }
            
            // Calculate comparison if selected
            let compSums = [];
            if (selectedComparison) {
                const comp = famousSeries[selectedComparison];
                s = 0;
                for (let i = 1; i <= challengeTerms; i++) {
                    s += comp.fn(i);
                    compSums.push(s);
                }
            }
            
            // Show legend only when comparison is selected
            document.getElementById('challengeLegend').style.display = selectedComparison ? 'flex' : 'none';
            
            const allV = [...ourSums, ...compSums];
            const maxV = Math.max(...allV) * 1.1 || 1;
            const minV = Math.min(0, ...allV);
            
            if (challengeView === 'numerical') {
                drawNumericalView(ctx, canvas, ourSums, compSums);
            } else if (challengeView === 'staircase') {
                drawStaircaseView(ctx, canvas, p, w, h, ourSums, compSums, maxV, minV);
            } else if (challengeView === 'numberline') {
                drawNumberLineView(ctx, canvas, p, w, ourSums, compSums, maxV, minV);
            }
        }
        
        function drawNumericalView(ctx, canvas, ourSums, compSums) {
            const p = 50, w = canvas.width - 2*p, h = canvas.height - 2*p;
            
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(p, p, w, h);
            
            if (challengeTerms === 0 || ourSums.length === 0) {
                ctx.fillStyle = '#888';
                ctx.font = '14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Press + or Animate to see partial sums', canvas.width/2, canvas.height/2);
                return;
            }
            
            const currentSum = ourSums[challengeTerms - 1];
            const currentTerm = challengeProblem.fn(challengeTerms);
            
            // Main sum display
            ctx.fillStyle = '#0f0';
            ctx.font = 'bold 24px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(`S${challengeTerms} = ${currentSum.toFixed(6)}`, canvas.width/2, canvas.height/2 - 20);
            
            // Current term
            ctx.fillStyle = '#888';
            ctx.font = '14px monospace';
            ctx.fillText(`a${challengeTerms} = ${currentTerm.toFixed(6)}`, canvas.width/2, canvas.height/2 + 15);
            
            // Comparison if selected
            if (selectedComparison && compSums.length > 0) {
                ctx.fillStyle = '#f59e0b';
                ctx.font = '16px monospace';
                ctx.fillText(`Comparison S${challengeTerms} = ${compSums[challengeTerms-1].toFixed(6)}`, canvas.width/2, canvas.height/2 + 55);
            }
        }
        
        function drawStaircaseView(ctx, canvas, p, w, h, ourSums, compSums, maxV, minV) {
            const canvasH = canvas.height;
            const range = maxV - minV || 1;
            const yScale = h / range;
            const maxTermsToShow = Math.max(challengeTerms, 20);
            const xStep = w / maxTermsToShow;
            
            // Axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(p, p);
            ctx.lineTo(p, canvasH - p);
            ctx.lineTo(p + w, canvasH - p);
            ctx.stroke();
            
            // Y-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxV.toFixed(2), p - 5, p + 10);
            ctx.fillText('0', p - 5, canvasH - p + 5);
            
            // X-axis labels
            ctx.textAlign = 'center';
            ctx.fillText('n', p + w/2, canvasH - 10);
            
            if (challengeTerms === 0) return;
            
            // Comparison staircase (orange) - draw first so our series is on top
            if (compSums.length > 0) {
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 2;
                ctx.beginPath();
                let prevY = canvasH - p - (0 - minV) * yScale;
                ctx.moveTo(p, prevY);
                for (let i = 0; i < challengeTerms; i++) {
                    const x = p + (i + 1) * xStep;
                    const y = canvasH - p - (compSums[i] - minV) * yScale;
                    ctx.lineTo(x, prevY); // horizontal
                    ctx.lineTo(x, y);     // vertical
                    prevY = y;
                }
                ctx.stroke();
                
                // Endpoint marker
                ctx.fillStyle = '#f59e0b';
                ctx.beginPath();
                ctx.arc(p + challengeTerms * xStep, prevY, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Our series staircase (teal)
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let prevY = canvasH - p - (0 - minV) * yScale;
            ctx.moveTo(p, prevY);
            for (let i = 0; i < challengeTerms; i++) {
                const x = p + (i + 1) * xStep;
                const y = canvasH - p - (ourSums[i] - minV) * yScale;
                ctx.lineTo(x, prevY); // horizontal
                ctx.lineTo(x, y);     // vertical
                prevY = y;
            }
            ctx.stroke();
            
            // Endpoint marker and label
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(p + challengeTerms * xStep, prevY, 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`S${challengeTerms}`, p + challengeTerms * xStep + 8, prevY + 4);
        }
        
        function drawNumberLineView(ctx, canvas, p, w, ourSums, compSums, maxV, minV) {
            const lineY = canvas.height / 2 + 20;
            
            // Determine range for number line
            const allVals = [...ourSums, ...compSums, 0];
            let nlMin = Math.min(...allVals) * 1.1;
            let nlMax = Math.max(...allVals) * 1.1;
            if (nlMin === nlMax) { nlMin = 0; nlMax = 1; }
            const nlRange = nlMax - nlMin || 1;
            
            const getX = val => p + ((val - nlMin) / nlRange) * w;
            
            // Draw number line
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(p, lineY);
            ctx.lineTo(p + w, lineY);
            ctx.stroke();
            
            // Arrow at end
            ctx.beginPath();
            ctx.moveTo(p + w - 8, lineY - 5);
            ctx.lineTo(p + w, lineY);
            ctx.lineTo(p + w - 8, lineY + 5);
            ctx.stroke();
            
            // Tick marks and labels
            ctx.fillStyle = '#666';
            ctx.font = '10px monospace';
            ctx.textAlign = 'center';
            const tickCount = 6;
            for (let i = 0; i <= tickCount; i++) {
                const val = nlMin + (nlRange * i / tickCount);
                const x = getX(val);
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, lineY - 5);
                ctx.lineTo(x, lineY + 5);
                ctx.stroke();
                ctx.fillStyle = '#666';
                ctx.fillText(val.toFixed(1), x, lineY + 18);
            }
            
            if (challengeTerms === 0) {
                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Press + or Animate to see accumulation', canvas.width/2, lineY - 50);
                return;
            }
            
            // Draw comparison accumulation arcs (orange)
            if (compSums.length > 0) {
                let prevX = getX(0);
                for (let i = 0; i < challengeTerms; i++) {
                    const x = getX(compSums[i]);
                    if (Math.abs(x - prevX) > 2) {
                        const midX = (prevX + x) / 2;
                        const arcHeight = Math.min(15, Math.abs(x - prevX) * 0.2);
                        ctx.strokeStyle = i === challengeTerms - 1 ? 'rgba(245,158,11,0.8)' : 'rgba(245,158,11,0.2)';
                        ctx.lineWidth = i === challengeTerms - 1 ? 2 : 1;
                        ctx.beginPath();
                        ctx.moveTo(prevX, lineY);
                        ctx.quadraticCurveTo(midX, lineY + arcHeight + 5, x, lineY);
                        ctx.stroke();
                    }
                    prevX = x;
                }
                // Endpoint
                ctx.fillStyle = '#f59e0b';
                ctx.beginPath();
                ctx.arc(getX(compSums[challengeTerms-1]), lineY, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw our series accumulation arcs (teal)
            let prevX = getX(0);
            for (let i = 0; i < challengeTerms; i++) {
                const x = getX(ourSums[i]);
                if (Math.abs(x - prevX) > 2) {
                    const midX = (prevX + x) / 2;
                    const arcHeight = Math.min(20, Math.abs(x - prevX) * 0.25);
                    ctx.strokeStyle = i === challengeTerms - 1 ? 'rgba(15,118,110,0.8)' : 'rgba(15,118,110,0.2)';
                    ctx.lineWidth = i === challengeTerms - 1 ? 2 : 1;
                    ctx.beginPath();
                    ctx.moveTo(prevX, lineY);
                    ctx.quadraticCurveTo(midX, lineY - arcHeight, x, lineY);
                    ctx.stroke();
                }
                prevX = x;
            }
            
            // Final point and label
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(getX(ourSums[challengeTerms-1]), lineY, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`S${challengeTerms}`, getX(ourSums[challengeTerms-1]), lineY - 15);
        }
        
        function challengeStepForward() {
            if (challengeTerms < 100) {
                challengeTerms++;
                document.getElementById('challengeTermDisplay').textContent = challengeTerms;
                drawChallengeView();
            }
        }
        
        function challengeStepBack() {
            if (challengeTerms > 1) {
                challengeTerms--;
                document.getElementById('challengeTermDisplay').textContent = challengeTerms;
                drawChallengeView();
            }
        }
        
        function challengeAnimate() {
            const btn = document.getElementById('challengeAnimateBtn');
            if (challengeAnimId) {
                clearInterval(challengeAnimId);
                challengeAnimId = null;
                btn.textContent = '‚ñ∂ Animate';
                return;
            }
            
            challengeTerms = 1;
            btn.textContent = '‚è∏ Pause';
            challengeAnimId = setInterval(() => {
                if (challengeTerms < 100) {
                    challengeTerms++;
                    document.getElementById('challengeTermDisplay').textContent = challengeTerms;
                    drawChallengeView();
                } else {
                    clearInterval(challengeAnimId);
                    challengeAnimId = null;
                    btn.textContent = '‚ñ∂ Animate';
                }
            }, 60);
        }
        
        function printSolution() {
            window.print();
        }
    </script>
</body>
</html>
