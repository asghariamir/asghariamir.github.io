<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romberg Integration Explorer - Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #10b981;
            --bg-light: #f7faf9;
            --accent-amber: #f59e0b;
            --accent-red: #dc2626;
            --text-dark: #212121;
            --text-muted: #4b5563;
            --border-light: #e5e7eb;
            --interactive-bg: #e6fffb;
            
            /* Order colors for table */
            --order-0: #6b7280;
            --order-2: #f59e0b;
            --order-4: #10b981;
            --order-6: #3b82f6;
            --order-8: #8b5cf6;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .main-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2rem;
            color: var(--primary);
            margin: 1rem 0 0.5rem;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        /* Mathswell Nav */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: 0.75rem 0 1rem;
        }
        
        .mathswell-nav a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--primary);
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .mathswell-nav a:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            justify-content: center;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background: var(--bg-light);
        }
        
        .tab-button.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards and Sections */
        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }
        
        h2 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        h3 {
            font-size: 1.2rem;
            color: var(--text-dark);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        /* Concept Cards */
        .concept-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .concept-card {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 1.25rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .concept-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .concept-card p {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* Formula Box */
        .formula-box {
            background: var(--interactive-bg);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }
        
        .formula-box .formula-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .formula-box .katex {
            font-size: 1.3rem;
        }
        
        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .insight-card {
            background: white;
            border-left: 4px solid var(--primary);
            padding: 1rem 1.25rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .insight-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        /* Nav Buttons */
        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .nav-button {
            flex: 1;
            min-width: 200px;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .nav-button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }
        
        /* Preset Pills */
        .preset-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .preset-pill {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .preset-pill:hover {
            background: var(--interactive-bg);
            transform: translateY(-2px);
        }
        
        .preset-pill.active {
            background: var(--primary);
            color: white;
        }
        
        /* Function Preview */
        .function-preview {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--interactive-bg);
            border-radius: 6px;
            font-size: 0.95rem;
            min-height: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .function-preview .preview-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .function-preview .katex {
            font-size: 1.1rem;
        }
        
        /* Control Grid */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }
        
        .control-group label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .control-group input, .control-group select {
            padding: 0.6rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .primary-button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }
        
        .primary-button:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-1px);
        }
        
        .primary-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        
        .secondary-button {
            padding: 0.75rem 1.5rem;
            background: var(--accent-amber);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }
        
        .secondary-button:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .secondary-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        
        .reset-button {
            padding: 0.75rem 1.5rem;
            background: white;
            color: var(--text-muted);
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reset-button:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        
        /* Results Display */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .result-card {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border-light);
            transition: transform 0.2s;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .result-card .label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .result-card .value {
            font-size: 1.3rem;
            font-weight: bold;
            font-family: monospace;
            color: var(--primary);
        }
        
        .result-card .value.error {
            color: var(--accent-red);
        }
        
        /* Romberg Table */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        th, td {
            border: 1px solid var(--border-light);
            padding: 10px 14px;
            text-align: center;
            min-width: 130px;
        }
        
        thead th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
            position: sticky;
            top: 0;
        }
        
        th.order-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        td {
            font-family: monospace;
            transition: all 0.3s ease;
        }
        
        td.highlight {
            background: var(--accent-amber);
            color: white;
            font-weight: bold;
        }
        
        td.new-value {
            animation: popIn 0.5s ease;
            background: var(--interactive-bg);
        }
        
        td.diagonal {
            background: linear-gradient(135deg, var(--interactive-bg) 0%, #d5f5f0 100%);
            font-weight: bold;
            color: var(--primary);
        }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Order Legend */
        .order-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 8px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Learning Points */
        .learning-points {
            background: var(--bg-light);
            border-left: 4px solid var(--primary);
            border-radius: 6px;
            padding: 1rem 1.25rem;
            margin: 1.5rem 0;
        }
        
        .learning-points h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .learning-points ul {
            list-style: none;
            padding-left: 0;
        }
        
        .learning-points li {
            padding-left: 1.5rem;
            position: relative;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }
        
        .learning-points li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }
        
        /* Challenge Tab Styles */
        .challenge-type-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .challenge-type-card {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .challenge-type-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(15, 118, 110, 0.15);
        }
        
        .challenge-type-card.active {
            border-color: var(--primary);
            background: var(--interactive-bg);
        }
        
        .challenge-type-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .challenge-type-card h4 {
            color: var(--primary);
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }
        
        .challenge-type-card p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0;
        }
        
        .challenge-prompt {
            text-align: center;
            padding: 3rem;
            background: var(--bg-light);
            border-radius: 12px;
            color: var(--text-muted);
        }
        
        .challenge-prompt p {
            font-size: 1.1rem;
            margin: 0;
        }
        
        .problem-area {
            animation: fadeIn 0.3s ease;
        }
        
        .problem-box {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .problem-type-label {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .problem-number {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .problem-question {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text-dark);
            margin-bottom: 1.25rem;
        }
        
        .problem-question .math-display {
            margin: 1rem 0;
            padding: 0.75rem;
        }
        
        .problem-input-area {
            margin-bottom: 1rem;
        }
        
        .problem-input-area input,
        .problem-input-area select {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            font-family: monospace;
            transition: border-color 0.2s;
        }
        
        .problem-input-area input:focus,
        .problem-input-area select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .problem-actions {
            margin-bottom: 1rem;
        }
        
        .problem-actions .primary-button {
            padding: 0.6rem 1.5rem;
            width: auto;
        }
        
        .problem-feedback {
            min-height: 1.5rem;
            font-size: 0.95rem;
            padding: 0.5rem 0;
        }
        
        .problem-feedback.correct {
            color: var(--primary-light);
        }
        
        .problem-feedback.incorrect {
            color: var(--accent-red);
        }
        
        /* Worked Example Styles */
        .worked-example-container {
            margin-bottom: 1.5rem;
        }
        
        .worked-example-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            transition: all 0.2s;
            width: 100%;
            text-align: left;
        }
        
        .worked-example-toggle:hover {
            border-color: var(--primary);
            background: white;
        }
        
        .worked-example-toggle.open {
            border-color: var(--primary);
            background: white;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            font-size: 0.8rem;
        }
        
        .worked-example-toggle.open .toggle-icon {
            transform: rotate(90deg);
        }
        
        .worked-example-content {
            background: white;
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 1.5rem;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .worked-example-content .worked-example-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .worked-example-steps {
            padding-left: 0.5rem;
        }
        
        .worked-example-step {
            margin-bottom: 1.25rem;
            padding-left: 1rem;
            border-left: 3px solid var(--interactive-bg);
        }
        
        .worked-example-step:last-child {
            margin-bottom: 0;
        }
        
        .step-label {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .step-content {
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .step-content .katex {
            font-size: 1.1rem;
        }
        
        .step-math {
            background: var(--bg-light);
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            text-align: center;
        }
        
        .generate-new-container {
            text-align: center;
        }
        
        .generate-new-container .secondary-button {
            width: auto;
            padding: 0.75rem 2rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .challenge-type-cards {
                grid-template-columns: 1fr;
            }
            
            .problem-input-area input,
            .problem-input-area select {
                max-width: 100%;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .concept-cards {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .challenge-workspace {
                grid-template-columns: 1fr;
            }
            
            .preset-pills {
                justify-content: center;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab-button {
                flex: 1;
                min-width: 100px;
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }
    
        /* Week Navigation Bar */
        .week-nav-bar {
            background: white;
            border-top: 2px solid var(--primary);
            padding: 1rem;
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .week-nav-bar a, .week-nav-bar span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .week-nav-bar .nav-prev,
        .week-nav-bar .nav-next {
            color: var(--primary);
            border: 2px solid var(--primary);
            background: white;
        }
        
        .week-nav-bar .nav-prev:hover,
        .week-nav-bar .nav-next:hover {
            background: var(--interactive-bg);
            transform: translateY(-2px);
        }
        
        .week-nav-bar .nav-hub {
            background: var(--primary);
            color: white;
        }
        
        .week-nav-bar .nav-hub:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .week-nav-bar .nav-disabled {
            color: var(--text-muted);
            border: 2px solid var(--border-light);
            opacity: 0.5;
            cursor: default;
        }
        
        @media (max-width: 600px) {
            .week-nav-bar {
                flex-direction: column;
            }
            .week-nav-bar a, .week-nav-bar span {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header">
            <div class="mathswell-nav">
                <a href="/">
                    <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
                    <span>MATHSWELL</span>
                </a>
            </div>
            <h1>Romberg Integration Explorer</h1>
            <p class="subtitle">Master Richardson Extrapolation through interactive table building</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('introduction')">Introduction</button>
            <button class="tab-button" onclick="switchTab('explorer')">Explorer</button>
            <button class="tab-button" onclick="switchTab('challenge')">Challenge</button>
        </div>
        
        <!-- Introduction Tab -->
        <div id="introduction-tab" class="tab-content active">
            <div class="section">
                <h2>What is Romberg Integration?</h2>
                <p style="color: var(--text-muted); line-height: 1.7; margin-bottom: 1rem;">
                    Romberg integration is a powerful technique that systematically improves the accuracy of numerical integration by applying <strong>Richardson extrapolation</strong> repeatedly to trapezium rule estimates. Instead of simply using smaller step sizes (which is computationally expensive), Romberg cleverly combines results from different step sizes to cancel error terms and achieve higher accuracy.
                </p>
                
                <div class="concept-cards">
                    <div class="concept-card">
                        <h4>üìê Trapezium Rule Foundation</h4>
                        <p>The first column of the Romberg table contains trapezium rule estimates with step sizes h, h/2, h/4, etc. Each has error O(h¬≤).</p>
                    </div>
                    <div class="concept-card">
                        <h4>üîÑ Richardson Extrapolation</h4>
                        <p>By combining two estimates with different step sizes, we can cancel the leading error term and achieve higher-order accuracy.</p>
                    </div>
                    <div class="concept-card">
                        <h4>üìä Triangular Table</h4>
                        <p>Each column increases the order by 2: O(h¬≤) ‚Üí O(h‚Å¥) ‚Üí O(h‚Å∂) ‚Üí ... The diagonal entries give the best estimates.</p>
                    </div>
                </div>
                
                <h3>The Key Formulas</h3>
                <div class="formula-box">
                    <div class="formula-label">Trapezium Rule (Column 0)</div>
                    <div id="trap-formula"></div>
                </div>
                
                <div class="formula-box">
                    <div class="formula-label">Richardson Extrapolation Formula</div>
                    <div id="richardson-formula"></div>
                </div>
                
                <div class="formula-box">
                    <div class="formula-label">Simpson's Rule (Column 1) - Special Case</div>
                    <div id="simpson-formula"></div>
                </div>
                
                <h3>Two Key Perspectives</h3>
                <div class="insights-grid">
                    <div class="insight-card">
                        <h4>üéØ Order Doubling</h4>
                        <p>Each extrapolation step increases the order of accuracy. Column 0 is O(h¬≤), Column 1 is O(h‚Å¥), Column 2 is O(h‚Å∂), and so on. This means errors decrease dramatically with each column.</p>
                    </div>
                    <div class="insight-card">
                        <h4>üí° Simpson = Extrapolated Trapezium</h4>
                        <p>Simpson's rule is not a "new" rule ‚Äî it's simply the first extrapolation of the trapezium rule! This reveals the deep connection between integration rules and error analysis.</p>
                    </div>
                </div>
                
                <div class="learning-points">
                    <h4>üí° Week 6 Connection</h4>
                    <ul>
                        <li>Romberg builds directly on Week 5's Richardson extrapolation ideas</li>
                        <li>The trapezium rule's O(h¬≤) error comes from Taylor expansion analysis</li>
                        <li>Each diagonal entry represents a successively more accurate estimate</li>
                        <li>In practice, 4-5 levels usually achieve machine precision</li>
                    </ul>
                </div>
                
                <div class="nav-buttons">
                    <button class="nav-button" onclick="switchTab('explorer')">
                        Build a Romberg Table ‚Üí
                    </button>
                    <button class="nav-button" onclick="switchTab('challenge')">
                        Test Your Understanding ‚Üí
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Explorer Tab -->
        <div id="explorer-tab" class="tab-content">
            <div class="section">
                <h2>Build Your Romberg Table</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Select an example or enter your own function. Generate the first column of trapezium estimates, then use "Extrapolate" to build each successive column and watch the accuracy improve dramatically.
                </p>
                
                <h3>Preset Examples</h3>
                <div class="preset-pills" id="preset-pills">
                    <!-- Populated by JS -->
                </div>
                
                <div class="control-grid">
                    <div class="control-group full-width">
                        <label>Function f(x):</label>
                        <input type="text" id="function-input" placeholder="e.g., exp(-x^2)">
                        <div id="function-preview" class="function-preview"></div>
                    </div>
                    <div class="control-group">
                        <label>Interval Start (a):</label>
                        <input type="text" id="a-input" value="0">
                    </div>
                    <div class="control-group">
                        <label>Interval End (b):</label>
                        <input type="text" id="b-input" value="1">
                    </div>
                    <div class="control-group">
                        <label>Table Depth (k): <span id="depth-label">5</span></label>
                        <input type="range" id="depth-slider" min="3" max="8" value="5">
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="generate-btn" class="primary-button">Generate Trapezium Column</button>
                    <button id="extrapolate-btn" class="secondary-button" disabled>Extrapolate Next Level</button>
                    <button id="reset-btn" class="reset-button">Reset</button>
                </div>
                
                <div class="results-grid">
                    <div class="result-card">
                        <div class="label">True Integral (Benchmark)</div>
                        <div id="true-integral-val" class="value">‚Äî</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Best Estimate</div>
                        <div id="best-estimate-val" class="value">‚Äî</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Error</div>
                        <div id="error-val" class="value error">‚Äî</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Current Order</div>
                        <div id="order-val" class="value">‚Äî</div>
                    </div>
                </div>
                
                <div class="order-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--order-0);"></div>
                        <span>R(k,0) ‚Äî O(h¬≤)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--order-2);"></div>
                        <span>R(k,1) ‚Äî O(h‚Å¥)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--order-4);"></div>
                        <span>R(k,2) ‚Äî O(h‚Å∂)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--order-6);"></div>
                        <span>R(k,3) ‚Äî O(h‚Å∏)</span>
                    </div>
                </div>
                
                <h3>Romberg Table</h3>
                <div id="romberg-container" class="table-container">
                    <p style="padding: 2rem; text-align: center; color: var(--text-muted);">Click "Generate Trapezium Column" to begin building the table.</p>
                </div>
                
                <div class="learning-points" id="dynamic-insights" style="display: none;">
                    <h4>üí° What's Happening</h4>
                    <ul id="insights-list">
                        <!-- Populated dynamically -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Challenge Tab -->
        <div id="challenge-tab" class="tab-content">
            <div class="section">
                <h2>Challenge Your Understanding</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Choose a challenge type to practice. Each type focuses on a different aspect of Romberg integration. Generate as many problems as you need ‚Äî a worked example is always available.
                </p>
                
                <!-- Challenge Type Cards -->
                <div class="challenge-type-cards">
                    <div class="challenge-type-card" data-type="trapezium" onclick="selectChallengeType('trapezium')">
                        <div class="challenge-type-icon">üìä</div>
                        <h4>First Column</h4>
                        <p>Computing Trapezium Estimates</p>
                    </div>
                    <div class="challenge-type-card" data-type="extrapolation" onclick="selectChallengeType('extrapolation')">
                        <div class="challenge-type-icon">üîÑ</div>
                        <h4>Extrapolation</h4>
                        <p>Filling the Table</p>
                    </div>
                    <div class="challenge-type-card" data-type="order" onclick="selectChallengeType('order')">
                        <div class="challenge-type-icon">üìà</div>
                        <h4>Order & Accuracy</h4>
                        <p>Why It Works</p>
                    </div>
                </div>
                
                <!-- Problem Area (hidden until type selected) -->
                <div id="problem-area" class="problem-area" style="display: none;">
                    <div class="problem-box">
                        <div class="problem-header">
                            <span id="problem-type-label" class="problem-type-label">Type</span>
                            <span id="problem-number" class="problem-number">Problem #1</span>
                        </div>
                        <div id="problem-question" class="problem-question">
                            <!-- Question content -->
                        </div>
                        <div id="problem-input-area" class="problem-input-area">
                            <!-- Input field(s) -->
                        </div>
                        <div class="problem-actions">
                            <button id="check-answer-btn" class="primary-button" onclick="checkChallengeAnswer()">Check Answer</button>
                        </div>
                        <div id="problem-feedback" class="problem-feedback"></div>
                    </div>
                    
                    <!-- Worked Example Toggle -->
                    <div class="worked-example-container">
                        <button class="worked-example-toggle" onclick="toggleWorkedExample()">
                            <span class="toggle-icon">‚ñ∂</span>
                            <span>üìñ See Worked Example</span>
                        </button>
                        
                        <div id="worked-example-content" class="worked-example-content" style="display: none;">
                            <div class="worked-example-header">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                    <line x1="8" y1="6" x2="16" y2="6"/>
                                    <line x1="8" y1="10" x2="14" y2="10"/>
                                </svg>
                                <div>
                                    <h4 style="margin: 0; color: var(--primary);">Worked Example</h4>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">Step-by-step solution</p>
                                </div>
                            </div>
                            <div id="worked-example-steps" class="worked-example-steps">
                                <!-- Steps populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate New Problem -->
                    <div class="generate-new-container">
                        <button class="secondary-button" onclick="generateNewProblem()">
                            üîÑ Generate New Problem
                        </button>
                    </div>
                </div>
                
                <!-- Initial prompt when no type selected -->
                <div id="challenge-prompt" class="challenge-prompt">
                    <p>üëÜ Select a challenge type above to begin practicing</p>
                </div>
                
                <div class="nav-buttons" style="margin-top: 2rem;">
                    <button class="nav-button" onclick="switchTab('explorer')">
                        ‚Üê Back to Explorer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ============ PRESETS ============
        const PRESETS = {
            "Gaussian": { f: "exp(-x^2)", a: "0", b: "1", label: "‚à´<sub>0</sub><sup>1</sup> e<sup>‚àíx¬≤</sup> dx" },
            "sin(x)": { f: "sin(x)", a: "0", b: "pi", label: "‚à´<sub>0</sub><sup>œÄ</sup> sin(x) dx" },
            "1/(1+x¬≤)": { f: "4/(1+x^2)", a: "0", b: "1", label: "‚à´<sub>0</sub><sup>1</sup> 4/(1+x¬≤) dx = œÄ" },
            "‚àöx": { f: "sqrt(x)", a: "0", b: "1", label: "‚à´<sub>0</sub><sup>1</sup> ‚àöx dx" },
            "x¬≤": { f: "x^2", a: "0", b: "1", label: "‚à´<sub>0</sub><sup>1</sup> x¬≤ dx = ‚Öì" },
            "e^x": { f: "exp(x)", a: "0", b: "1", label: "‚à´<sub>0</sub><sup>1</sup> e<sup>x</sup> dx" },
        };
        
        // ============ STATE ============
        let state = {
            compiledFunc: null,
            a: 0,
            b: 1,
            depth: 5,
            trueIntegral: null,
            rombergTable: [],
            currentLevel: -1,
            activePreset: null
        };
        
        // ============ DOM REFS ============
        const DOM = {
            presetPills: document.getElementById('preset-pills'),
            functionInput: document.getElementById('function-input'),
            functionPreview: document.getElementById('function-preview'),
            aInput: document.getElementById('a-input'),
            bInput: document.getElementById('b-input'),
            depthSlider: document.getElementById('depth-slider'),
            depthLabel: document.getElementById('depth-label'),
            generateBtn: document.getElementById('generate-btn'),
            extrapolateBtn: document.getElementById('extrapolate-btn'),
            resetBtn: document.getElementById('reset-btn'),
            trueIntegralVal: document.getElementById('true-integral-val'),
            bestEstimateVal: document.getElementById('best-estimate-val'),
            errorVal: document.getElementById('error-val'),
            orderVal: document.getElementById('order-val'),
            rombergContainer: document.getElementById('romberg-container'),
            dynamicInsights: document.getElementById('dynamic-insights'),
            insightsList: document.getElementById('insights-list')
        };
        
        // ============ INITIALIZATION ============
        function initialize() {
            // Render formulas
            katex.render(String.raw`T_n = \frac{h}{2}\left[f(a) + 2\sum_{i=1}^{n-1} f(a+ih) + f(b)\right]`, document.getElementById('trap-formula'), {displayMode: true});
            katex.render(String.raw`R(k,j) = \frac{4^j R(k,j-1) - R(k-1,j-1)}{4^j - 1}`, document.getElementById('richardson-formula'), {displayMode: true});
            katex.render(String.raw`S = \frac{4T_{2n} - T_n}{3} = R(k,1)`, document.getElementById('simpson-formula'), {displayMode: true});
            
            // Build preset pills
            Object.entries(PRESETS).forEach(([name, preset]) => {
                const pill = document.createElement('button');
                pill.className = 'preset-pill';
                pill.innerHTML = preset.label;
                pill.dataset.name = name;
                pill.onclick = () => loadPreset(name);
                DOM.presetPills.appendChild(pill);
            });
            
            // Event listeners
            DOM.depthSlider.addEventListener('input', () => {
                DOM.depthLabel.textContent = DOM.depthSlider.value;
            });
            
            DOM.functionInput.addEventListener('input', updateFunctionPreview);
            
            DOM.generateBtn.addEventListener('click', generateTable);
            DOM.extrapolateBtn.addEventListener('click', extrapolateNextLevel);
            DOM.resetBtn.addEventListener('click', resetExplorer);
            
            // Load first preset
            loadPreset('Gaussian');
        }
        
        function loadPreset(name) {
            const preset = PRESETS[name];
            if (!preset) return;
            
            DOM.functionInput.value = preset.f;
            DOM.aInput.value = preset.a;
            DOM.bInput.value = preset.b;
            state.activePreset = name;
            
            // Update pill styling
            document.querySelectorAll('.preset-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.name === name);
            });
            
            updateFunctionPreview();
        }
        
        function updateFunctionPreview() {
            const preview = document.getElementById('function-preview');
            const funcStr = DOM.functionInput.value.trim();
            
            if (!funcStr) {
                preview.innerHTML = '<span class="preview-label">Enter a function above</span>';
                return;
            }
            
            // Convert math.js syntax to LaTeX
            const latex = mathToLatex(funcStr);
            
            preview.innerHTML = '<span class="preview-label">f(x) =</span> <span id="function-latex"></span>';
            
            try {
                katex.render(latex, document.getElementById('function-latex'), { displayMode: false });
            } catch (e) {
                preview.innerHTML = `<span class="preview-label">f(x) = ${funcStr}</span>`;
            }
        }
        
        function mathToLatex(str) {
            // Convert common math.js expressions to LaTeX
            let latex = str
                .replace(/\*\*/g, '^')
                .replace(/\*/g, ' \\cdot ')
                .replace(/sqrt\(([^)]+)\)/g, '\\sqrt{$1}')
                .replace(/exp\(([^)]+)\)/g, 'e^{$1}')
                .replace(/sin\(([^)]+)\)/g, '\\sin($1)')
                .replace(/cos\(([^)]+)\)/g, '\\cos($1)')
                .replace(/tan\(([^)]+)\)/g, '\\tan($1)')
                .replace(/log\(([^)]+)\)/g, '\\ln($1)')
                .replace(/pi/g, '\\pi')
                .replace(/\^2/g, '^{2}')
                .replace(/\^3/g, '^{3}')
                .replace(/\^4/g, '^{4}')
                .replace(/\^(-?[0-9]+)/g, '^{$1}')
                .replace(/([0-9])x/g, '$1 x')
                .replace(/\(x\)/g, '(x)');
            
            return latex;
        }
        
        // ============ MATH FUNCTIONS ============
        function f(x) {
            try {
                return state.compiledFunc.evaluate({x: x});
            } catch {
                return NaN;
            }
        }
        
        function trapezoid(n, a, b) {
            const h = (b - a) / n;
            let sum = (f(a) + f(b)) / 2;
            for (let i = 1; i < n; i++) {
                sum += f(a + i * h);
            }
            return sum * h;
        }
        
        // ============ TABLE GENERATION ============
        function generateTable() {
            try {
                state.compiledFunc = math.compile(DOM.functionInput.value);
                state.a = math.evaluate(DOM.aInput.value);
                state.b = math.evaluate(DOM.bInput.value);
                state.depth = parseInt(DOM.depthSlider.value);
            } catch (e) {
                alert(`Invalid function or range: ${e.message}`);
                return;
            }
            
            // Calculate "true" integral using high-precision trapezoid
            state.trueIntegral = trapezoid(Math.pow(2, 14), state.a, state.b);
            
            // Initialize Romberg table
            state.rombergTable = Array(state.depth).fill(0).map(() => Array(state.depth).fill(null));
            state.currentLevel = 0;
            
            // Fill first column with trapezium estimates
            for (let i = 0; i < state.depth; i++) {
                const n = Math.pow(2, i);
                state.rombergTable[i][0] = trapezoid(n, state.a, state.b);
            }
            
            DOM.extrapolateBtn.disabled = false;
            renderRombergTable();
            updateResultsPanel();
            updateInsights();
        }
        
        async function extrapolateNextLevel() {
            const j = state.currentLevel + 1;
            if (j >= state.depth) {
                DOM.extrapolateBtn.disabled = true;
                return;
            }
            
            DOM.extrapolateBtn.disabled = true;
            DOM.generateBtn.disabled = true;
            
            for (let i = j; i < state.depth; i++) {
                const powerOf4 = Math.pow(4, j);
                const R_curr = state.rombergTable[i][j-1];
                const R_prev = state.rombergTable[i-1][j-1];
                
                // Highlight source cells
                const cell1 = document.getElementById(`cell-${i}-${j-1}`);
                const cell2 = document.getElementById(`cell-${i-1}-${j-1}`);
                if (cell1) cell1.classList.add('highlight');
                if (cell2) cell2.classList.add('highlight');
                
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Calculate and store new value
                const extrapolatedValue = (powerOf4 * R_curr - R_prev) / (powerOf4 - 1);
                state.rombergTable[i][j] = extrapolatedValue;
                
                renderRombergTable();
                
                if (cell1) cell1.classList.remove('highlight');
                if (cell2) cell2.classList.remove('highlight');
            }
            
            state.currentLevel = j;
            updateResultsPanel();
            updateInsights();
            
            DOM.generateBtn.disabled = false;
            if (state.currentLevel < state.depth - 1) {
                DOM.extrapolateBtn.disabled = false;
            }
        }
        
        function renderRombergTable() {
            const orderLabels = ['O(h¬≤)', 'O(h‚Å¥)', 'O(h‚Å∂)', 'O(h‚Å∏)', 'O(h¬π‚Å∞)', 'O(h¬π¬≤)', 'O(h¬π‚Å¥)', 'O(h¬π‚Å∂)'];
            
            let html = '<table>';
            html += '<thead><tr><th>k</th><th>n=2·µè</th>';
            for (let j = 0; j < state.depth; j++) {
                html += `<th>R(k,${j})<br><span class="order-label">${orderLabels[j] || ''}</span></th>`;
            }
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < state.depth; i++) {
                html += `<tr><td>${i}</td><td>${Math.pow(2, i)}</td>`;
                for (let j = 0; j < state.depth; j++) {
                    const value = state.rombergTable[i][j];
                    const id = `cell-${i}-${j}`;
                    const isNew = j === state.currentLevel && i >= j && j > 0;
                    const isDiagonal = i === j && value !== null;
                    
                    let classes = [];
                    if (isNew) classes.push('new-value');
                    if (isDiagonal) classes.push('diagonal');
                    
                    if (value !== null) {
                        html += `<td id="${id}" class="${classes.join(' ')}">${value.toFixed(10)}</td>`;
                    } else {
                        html += `<td id="${id}" style="color: #e0e0e0;">‚Äî</td>`;
                    }
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            DOM.rombergContainer.innerHTML = html;
        }
        
        function updateResultsPanel() {
            DOM.trueIntegralVal.textContent = state.trueIntegral ? state.trueIntegral.toFixed(10) : '‚Äî';
            
            // Best estimate is diagonal element at current level
            const bestRow = Math.min(state.currentLevel, state.depth - 1);
            const bestEstimate = state.rombergTable[bestRow]?.[bestRow];
            
            if (bestEstimate !== null && bestEstimate !== undefined) {
                DOM.bestEstimateVal.textContent = bestEstimate.toFixed(10);
                const error = Math.abs(state.trueIntegral - bestEstimate);
                DOM.errorVal.textContent = error.toExponential(3);
                DOM.orderVal.textContent = `O(h${2 * (state.currentLevel + 1) > 10 ? '¬π' : ''}${['¬≤','‚Å¥','‚Å∂','‚Å∏','‚Å∞'][state.currentLevel] || ''})`;
            } else {
                DOM.bestEstimateVal.textContent = '‚Äî';
                DOM.errorVal.textContent = '‚Äî';
                DOM.orderVal.textContent = '‚Äî';
            }
        }
        
        function updateInsights() {
            DOM.dynamicInsights.style.display = 'block';
            const insights = [];
            
            if (state.currentLevel === 0) {
                insights.push('Column 0 shows trapezium rule estimates with different step sizes');
                insights.push('Notice how estimates improve as n doubles (h halves)');
                insights.push('Click "Extrapolate" to apply Richardson extrapolation');
            } else if (state.currentLevel === 1) {
                insights.push('Column 1 is equivalent to Simpson\'s rule!');
                insights.push('The formula (4T‚ÇÇ‚Çô - T‚Çô)/3 cancels the O(h¬≤) error term');
                insights.push('Notice the dramatic error reduction ‚Äî this is O(h‚Å¥) accuracy');
            } else if (state.currentLevel === 2) {
                insights.push('Column 2 achieves O(h‚Å∂) accuracy');
                insights.push('Each extrapolation cancels another error term from the Taylor expansion');
                insights.push('The diagonal R(k,k) entries give the best estimates at each level');
            } else {
                insights.push(`Column ${state.currentLevel} achieves O(h^${2*(state.currentLevel+1)}) accuracy`);
                insights.push('Further extrapolation may hit machine precision limits');
                insights.push('Compare diagonal entries to see diminishing returns');
            }
            
            DOM.insightsList.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        }
        
        function resetExplorer() {
            state.rombergTable = [];
            state.currentLevel = -1;
            state.trueIntegral = null;
            
            DOM.extrapolateBtn.disabled = true;
            DOM.trueIntegralVal.textContent = '‚Äî';
            DOM.bestEstimateVal.textContent = '‚Äî';
            DOM.errorVal.textContent = '‚Äî';
            DOM.orderVal.textContent = '‚Äî';
            DOM.dynamicInsights.style.display = 'none';
            DOM.rombergContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-muted);">Click "Generate Trapezium Column" to begin building the table.</p>';
        }
        
        // ============ TAB SWITCHING ============
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        };
        
        // ============ CHALLENGE TAB ============
        let challengeState = {
            currentType: null,
            currentProblem: null,
            problemCount: { trapezium: 0, extrapolation: 0, order: 0 }
        };
        
        window.selectChallengeType = function(type) {
            challengeState.currentType = type;
            
            // Update card styling
            document.querySelectorAll('.challenge-type-card').forEach(card => {
                card.classList.toggle('active', card.dataset.type === type);
            });
            
            // Hide prompt, show problem area
            document.getElementById('challenge-prompt').style.display = 'none';
            document.getElementById('problem-area').style.display = 'block';
            
            // Update type label
            const typeLabels = {
                trapezium: 'First Column',
                extrapolation: 'Extrapolation',
                order: 'Order & Accuracy'
            };
            document.getElementById('problem-type-label').textContent = typeLabels[type];
            
            // Generate first problem
            generateNewProblem();
        };
        
        window.generateNewProblem = function() {
            const type = challengeState.currentType;
            if (!type) return;
            
            challengeState.problemCount[type]++;
            document.getElementById('problem-number').textContent = `Problem #${challengeState.problemCount[type]}`;
            
            // Reset state
            document.getElementById('problem-feedback').innerHTML = '';
            document.getElementById('problem-feedback').className = 'problem-feedback';
            
            // Close worked example if open
            const toggle = document.querySelector('.worked-example-toggle');
            const content = document.getElementById('worked-example-content');
            toggle.classList.remove('open');
            content.style.display = 'none';
            
            // Generate problem based on type
            if (type === 'trapezium') {
                generateTrapeziumProblem();
            } else if (type === 'extrapolation') {
                generateExtrapolationProblem();
            } else if (type === 'order') {
                generateOrderProblem();
            }
        };
        
        function generateTrapeziumProblem() {
            // Dynamic problem generation with random parameters
            const functions = [
                { f: 'x^2', label: 'x¬≤', fFunc: x => x*x },
                { f: 'x^3', label: 'x¬≥', fFunc: x => x*x*x },
                { f: 'x', label: 'x', fFunc: x => x },
                { f: '2*x', label: '2x', fFunc: x => 2*x },
                { f: 'x^2 + 1', label: 'x¬≤ + 1', fFunc: x => x*x + 1 },
                { f: '3*x^2', label: '3x¬≤', fFunc: x => 3*x*x },
                { f: 'x^4', label: 'x‚Å¥', fFunc: x => x*x*x*x },
                { f: '1 + x', label: '1 + x', fFunc: x => 1 + x },
            ];
            
            const intervals = [
                { a: 0, b: 1 },
                { a: 0, b: 2 },
                { a: 1, b: 2 },
                { a: 0, b: 4 },
                { a: 1, b: 3 },
            ];
            
            const nValues = [2, 4, 8];
            
            // Random selection
            const func = functions[Math.floor(Math.random() * functions.length)];
            const interval = intervals[Math.floor(Math.random() * intervals.length)];
            const n = nValues[Math.floor(Math.random() * nValues.length)];
            
            const p = {
                f: func.f,
                fLabel: func.label,
                fFunc: func.fFunc,
                a: interval.a,
                b: interval.b,
                n: n
            };
            
            const h = (p.b - p.a) / p.n;
            
            // Calculate answer
            let sum = (p.fFunc(p.a) + p.fFunc(p.b)) / 2;
            for (let i = 1; i < p.n; i++) {
                sum += p.fFunc(p.a + i * h);
            }
            const answer = sum * h;
            
            challengeState.currentProblem = {
                type: 'trapezium',
                answer: answer,
                data: p,
                h: h
            };
            
            document.getElementById('problem-question').innerHTML = `
                <p>Compute the trapezium rule estimate <strong>T<sub>${p.n}</sub></strong> for:</p>
                <div class="math-display" id="trap-problem-integral"></div>
                <p>Use <strong>n = ${p.n}</strong> subintervals (so h = ${h}).</p>
            `;
            
            katex.render(`\\int_{${p.a}}^{${p.b}} ${p.fLabel.replace('¬≤', '^2').replace('¬≥', '^3').replace('‚Å¥', '^4')} \\, dx`, document.getElementById('trap-problem-integral'), {displayMode: true});
            
            document.getElementById('problem-input-area').innerHTML = `
                <input type="text" id="challenge-answer-input" placeholder="Enter T${p.n} (e.g., 0.375)">
            `;
            
            // Generate worked example
            generateTrapeziumWorkedExample(p, h, answer);
        }
        
        function generateTrapeziumWorkedExample(p, h, answer) {
            const nodes = [];
            for (let i = 0; i <= p.n; i++) {
                const x = p.a + i * h;
                const fx = p.fFunc(x);
                nodes.push({ x: x, fx: fx });
            }
            
            const nodesStr = nodes.map(n => `f(${n.x}) = ${n.fx}`).join(', ');
            const midSum = nodes.slice(1, -1).map(n => n.fx).reduce((a, b) => a + b, 0);
            
            const stepsHtml = `
                <div class="worked-example-step">
                    <div class="step-label">Step 1: Identify the setup</div>
                    <div class="step-content">
                        We need T<sub>${p.n}</sub> for ‚à´<sub>${p.a}</sub><sup>${p.b}</sup> ${p.fLabel} dx with n = ${p.n} subintervals.<br>
                        Step size: h = (${p.b} ‚àí ${p.a}) / ${p.n} = ${h}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 2: Recall the formula</div>
                    <div class="step-content">
                        <div class="step-math" id="trap-we-formula"></div>
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 3: Evaluate f at the nodes</div>
                    <div class="step-content">
                        Nodes: x = ${nodes.map(n => n.x).join(', ')}<br>
                        Values: ${nodesStr}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 4: Apply the formula</div>
                    <div class="step-content">
                        T<sub>${p.n}</sub> = (${h}/2) √ó [${nodes[0].fx} + 2(${midSum}) + ${nodes[nodes.length-1].fx}]<br>
                        = (${h}/2) √ó [${nodes[0].fx} + ${2*midSum} + ${nodes[nodes.length-1].fx}]<br>
                        = (${h}/2) √ó ${nodes[0].fx + 2*midSum + nodes[nodes.length-1].fx}<br>
                        = ${(h/2) * (nodes[0].fx + 2*midSum + nodes[nodes.length-1].fx)}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 5: Final answer</div>
                    <div class="step-content">
                        <strong>T<sub>${p.n}</sub> = ${answer}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('worked-example-steps').innerHTML = stepsHtml;
            
            katex.render(`T_n = \\frac{h}{2}\\left[f(a) + 2\\sum_{i=1}^{n-1} f(a+ih) + f(b)\\right]`, 
                document.getElementById('trap-we-formula'), {displayMode: true});
        }
        
        function generateExtrapolationProblem() {
            // Randomly choose problem subtype
            const subtypes = ['simpson', 'simpson', 'simpson', 'higher_order']; // weight toward simpson
            const subtype = subtypes[Math.floor(Math.random() * subtypes.length)];
            
            if (subtype === 'simpson') {
                // Generate Simpson extrapolation problems with varied values
                // Use actual trapezium values from simple functions
                const scenarios = [
                    // f = x¬≤, [0,1]
                    { T_n: 0.5, T_2n: 0.375, n: 1, label_n: 'T‚ÇÅ', label_2n: 'T‚ÇÇ', k: 1 },
                    { T_n: 0.375, T_2n: 0.34375, n: 2, label_n: 'T‚ÇÇ', label_2n: 'T‚ÇÑ', k: 2 },
                    { T_n: 0.34375, T_2n: 0.3359375, n: 4, label_n: 'T‚ÇÑ', label_2n: 'T‚Çà', k: 3 },
                    // f = x¬≥, [0,1]
                    { T_n: 0.5, T_2n: 0.3125, n: 1, label_n: 'T‚ÇÅ', label_2n: 'T‚ÇÇ', k: 1 },
                    { T_n: 0.3125, T_2n: 0.265625, n: 2, label_n: 'T‚ÇÇ', label_2n: 'T‚ÇÑ', k: 2 },
                    // f = x, [0,2]
                    { T_n: 2, T_2n: 2, n: 1, label_n: 'T‚ÇÅ', label_2n: 'T‚ÇÇ', k: 1 },
                    // f = x¬≤, [0,2]
                    { T_n: 4, T_2n: 3, n: 1, label_n: 'T‚ÇÅ', label_2n: 'T‚ÇÇ', k: 1 },
                    { T_n: 3, T_2n: 2.75, n: 2, label_n: 'T‚ÇÇ', label_2n: 'T‚ÇÑ', k: 2 },
                ];
                
                const s = scenarios[Math.floor(Math.random() * scenarios.length)];
                const answer = (4 * s.T_2n - s.T_n) / 3;
                
                challengeState.currentProblem = {
                    type: 'extrapolation',
                    answer: answer,
                    data: { ...s, j: 1 }
                };
                
                document.getElementById('problem-question').innerHTML = `
                    <p>Given <strong>${s.label_n} = ${s.T_n}</strong> and <strong>${s.label_2n} = ${s.T_2n}</strong>, compute the Simpson extrapolation <strong>R(${s.k + 1},1)</strong>.</p>
                    <p style="color: var(--text-muted); font-size: 0.95rem;">Hint: Use R(k,1) = (4¬∑T<sub>2n</sub> ‚àí T<sub>n</sub>) / 3</p>
                `;
                
                generateSimpsonWorkedExample(s, answer);
                
            } else {
                // Higher-order extrapolation (column 2 or 3)
                const j = Math.random() < 0.7 ? 2 : 3;
                const coef = Math.pow(4, j);
                const denom = coef - 1;
                
                // Generate plausible R values
                const baseVal = 0.3 + Math.random() * 0.4; // random between 0.3 and 0.7
                const R_prev = parseFloat(baseVal.toFixed(6));
                const R_curr = parseFloat((baseVal + (Math.random() - 0.5) * 0.01).toFixed(6));
                
                const answer = (coef * R_curr - R_prev) / denom;
                const k = j + Math.floor(Math.random() * 2) + 1;
                
                challengeState.currentProblem = {
                    type: 'extrapolation',
                    answer: answer,
                    data: { R_prev, R_curr, j, coef, denom, k }
                };
                
                document.getElementById('problem-question').innerHTML = `
                    <p>Given <strong>R(${k-1},${j-1}) = ${R_prev}</strong> and <strong>R(${k},${j-1}) = ${R_curr}</strong>, compute <strong>R(${k},${j})</strong>.</p>
                    <p style="color: var(--text-muted); font-size: 0.95rem;">Hint: For column j = ${j}, use coefficient 4<sup>${j}</sup> = ${coef}</p>
                `;
                
                generateHigherOrderWorkedExample({ R_prev, R_curr, j, coef, denom, k }, answer);
            }
            
            document.getElementById('problem-input-area').innerHTML = `
                <input type="text" id="challenge-answer-input" placeholder="Enter your answer (e.g., 0.3333)">
            `;
        }
        
        function generateSimpsonWorkedExample(s, answer) {
            const stepsHtml = `
                <div class="worked-example-step">
                    <div class="step-label">Step 1: Identify the values</div>
                    <div class="step-content">
                        We have ${s.label_n} = ${s.T_n} and ${s.label_2n} = ${s.T_2n}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 2: Recall Simpson's extrapolation formula</div>
                    <div class="step-content">
                        <div class="step-math" id="extrap-we-formula"></div>
                        This is column j = 1, which cancels the O(h¬≤) error term.
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 3: Substitute values</div>
                    <div class="step-content">
                        R(${s.k + 1},1) = (4 √ó ${s.T_2n} ‚àí ${s.T_n}) / 3<br>
                        = (${4 * s.T_2n} ‚àí ${s.T_n}) / 3<br>
                        = ${4 * s.T_2n - s.T_n} / 3
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 4: Calculate</div>
                    <div class="step-content">
                        <strong>R(${s.k + 1},1) = ${answer}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('worked-example-steps').innerHTML = stepsHtml;
            katex.render(`R(k,1) = \\frac{4 T_{2n} - T_n}{3}`, document.getElementById('extrap-we-formula'), {displayMode: true});
        }
        
        function generateHigherOrderWorkedExample(p, answer) {
            const stepsHtml = `
                <div class="worked-example-step">
                    <div class="step-label">Step 1: Identify column and coefficient</div>
                    <div class="step-content">
                        We're computing column j = ${p.j}<br>
                        Coefficient: 4<sup>${p.j}</sup> = ${p.coef}<br>
                        Denominator: ${p.coef} ‚àí 1 = ${p.denom}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 2: Recall the general formula</div>
                    <div class="step-content">
                        <div class="step-math" id="extrap-we-formula"></div>
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 3: Substitute values</div>
                    <div class="step-content">
                        R(${p.k},${p.j}) = (${p.coef} √ó ${p.R_curr} ‚àí ${p.R_prev}) / ${p.denom}<br>
                        = (${(p.coef * p.R_curr).toFixed(6)} ‚àí ${p.R_prev}) / ${p.denom}<br>
                        = ${(p.coef * p.R_curr - p.R_prev).toFixed(6)} / ${p.denom}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 4: Final answer</div>
                    <div class="step-content">
                        <strong>R(${p.k},${p.j}) = ${answer.toFixed(6)}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('worked-example-steps').innerHTML = stepsHtml;
            katex.render(`R(k,j) = \\frac{4^j \\cdot R(k,j-1) - R(k-1,j-1)}{4^j - 1}`, document.getElementById('extrap-we-formula'), {displayMode: true});
        }
        
        function generateOrderProblem() {
            // Larger pool of conceptual problems with some randomization
            const problemGenerators = [
                // Error reduction factor problems
                () => {
                    const order = [2, 4, 6][Math.floor(Math.random() * 3)];
                    const factor = Math.pow(2, order);
                    return {
                        question: `A numerical method has error O(h<sup>${order}</sup>). If you halve the step size, by what factor does the error decrease?`,
                        type: 'input',
                        answer: String(factor),
                        explanation: `Error ~ h<sup>${order}</sup>. If h ‚Üí h/2, error ~ (h/2)<sup>${order}</sup> = h<sup>${order}</sup>/${factor}. So error decreases by factor <strong>${factor}</strong>.`
                    };
                },
                // Column order problems
                () => {
                    const j = [0, 1, 2, 3][Math.floor(Math.random() * 4)];
                    const order = 2 * (j + 1);
                    const orderStr = ['O(h¬≤)', 'O(h‚Å¥)', 'O(h‚Å∂)', 'O(h‚Å∏)'][j];
                    return {
                        question: `In the Romberg table, what is the error order of column ${j}?`,
                        type: 'select',
                        options: ['O(h¬≤)', 'O(h‚Å¥)', 'O(h‚Å∂)', 'O(h‚Å∏)'],
                        answer: orderStr,
                        explanation: `Column j has error O(h<sup>2(j+1)</sup>). For j = ${j}, that's O(h<sup>${order}</sup>) = ${orderStr}.`
                    };
                },
                // 4^j coefficient problems
                () => {
                    const j = [1, 2, 3, 4][Math.floor(Math.random() * 4)];
                    const coef = Math.pow(4, j);
                    return {
                        question: `What is the coefficient 4<sup>j</sup> when extrapolating to column j = ${j}?`,
                        type: 'input',
                        answer: String(coef),
                        explanation: `4<sup>${j}</sup> = ${coef}. The denominator in the formula would be ${coef} ‚àí 1 = ${coef - 1}.`
                    };
                },
                // Simpson equivalence
                () => ({
                    question: `Simpson's rule is equivalent to which Romberg table column?`,
                    type: 'select',
                    options: ['Column 0 (Trapezium)', 'Column 1', 'Column 2', 'Column 3'],
                    answer: 'Column 1',
                    explanation: `Simpson's rule is the first extrapolation of the trapezium rule, which is column 1 (j = 1). It achieves O(h‚Å¥) accuracy.`
                }),
                // Denominator problems
                () => {
                    const j = [1, 2, 3][Math.floor(Math.random() * 3)];
                    const denom = Math.pow(4, j) - 1;
                    return {
                        question: `In the Richardson extrapolation formula for column j = ${j}, what is the denominator (4<sup>j</sup> ‚àí 1)?`,
                        type: 'input',
                        answer: String(denom),
                        explanation: `4<sup>${j}</sup> ‚àí 1 = ${Math.pow(4, j)} ‚àí 1 = <strong>${denom}</strong>.`
                    };
                },
                // Which is more accurate
                () => {
                    const k = 3 + Math.floor(Math.random() * 3);
                    return {
                        question: `Which gives a more accurate estimate: R(${k},0) or R(${k-1},1)?`,
                        type: 'select',
                        options: [`R(${k},0) ‚Äî uses more points`, `R(${k-1},1) ‚Äî higher order`, 'They are equally accurate', 'Cannot determine'],
                        answer: `R(${k-1},1) ‚Äî higher order`,
                        explanation: `R(${k-1},1) has O(h‚Å¥) error while R(${k},0) has O(h¬≤) error. Higher order wins despite fewer function evaluations!`
                    };
                },
                // Order increase per column
                () => ({
                    question: `Each Richardson extrapolation step increases the error order by how much?`,
                    type: 'select',
                    options: ['1', '2', '4', 'It doubles'],
                    answer: '2',
                    explanation: `Each extrapolation cancels the next even power of h in the error expansion: O(h¬≤) ‚Üí O(h‚Å¥) ‚Üí O(h‚Å∂). The order increases by 2 each time.`
                }),
                // Diagonal significance
                () => ({
                    question: `In the Romberg table, the diagonal entries R(k,k) are special because:`,
                    type: 'select',
                    options: ['They require the fewest evaluations', 'They give the best accuracy for each level', 'They are always exact', 'They equal Simpson\'s rule'],
                    answer: 'They give the best accuracy for each level',
                    explanation: `The diagonal R(k,k) achieves the highest order of accuracy (O(h<sup>2k+2</sup>)) available at level k.`
                }),
                // When to stop
                () => ({
                    question: `If R(4,4) = 0.74682413 and R(5,5) = 0.74682413, what does this suggest?`,
                    type: 'select',
                    options: ['An error in the calculation', 'Machine precision has been reached', 'The function is linear', 'More extrapolation is needed'],
                    answer: 'Machine precision has been reached',
                    explanation: `When successive diagonal entries agree to all displayed digits, further extrapolation won't improve accuracy ‚Äî we've hit the limits of floating-point precision.`
                }),
            ];
            
            // Randomly select a problem generator and create the problem
            const generator = problemGenerators[Math.floor(Math.random() * problemGenerators.length)];
            const p = generator();
            
            challengeState.currentProblem = {
                type: 'order',
                answer: p.answer,
                data: p
            };
            
            document.getElementById('problem-question').innerHTML = `<p>${p.question}</p>`;
            
            if (p.type === 'select') {
                document.getElementById('problem-input-area').innerHTML = `
                    <select id="challenge-answer-input">
                        <option value="">Select an answer...</option>
                        ${p.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            } else {
                document.getElementById('problem-input-area').innerHTML = `
                    <input type="text" id="challenge-answer-input" placeholder="Enter your answer">
                `;
            }
            
            generateOrderWorkedExample(p);
        }
        
        function generateOrderWorkedExample(p) {
            const stepsHtml = `
                <div class="worked-example-step">
                    <div class="step-label">Step 1: Understand the question</div>
                    <div class="step-content">
                        ${p.question}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 2: Key reasoning</div>
                    <div class="step-content">
                        ${p.explanation}
                    </div>
                </div>
                <div class="worked-example-step">
                    <div class="step-label">Step 3: Answer</div>
                    <div class="step-content">
                        <strong>${p.answer}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('worked-example-steps').innerHTML = stepsHtml;
        }
        
        window.checkChallengeAnswer = function() {
            const input = document.getElementById('challenge-answer-input');
            const feedback = document.getElementById('problem-feedback');
            const userAnswer = input.value.trim();
            
            if (!userAnswer) {
                feedback.innerHTML = 'Please enter an answer.';
                feedback.className = 'problem-feedback';
                return;
            }
            
            const problem = challengeState.currentProblem;
            let isCorrect = false;
            
            if (problem.type === 'order' && problem.data.type === 'select') {
                isCorrect = userAnswer === problem.answer;
            } else if (problem.type === 'order') {
                isCorrect = userAnswer === problem.answer;
            } else {
                // Numerical comparison with tolerance
                const numAnswer = parseFloat(userAnswer);
                const tolerance = Math.abs(problem.answer) * 0.01 + 0.0001; // 1% + small absolute
                isCorrect = Math.abs(numAnswer - problem.answer) < tolerance;
            }
            
            if (isCorrect) {
                feedback.innerHTML = '‚úì Correct! Well done.';
                feedback.className = 'problem-feedback correct';
            } else {
                feedback.innerHTML = `‚úó Not quite. Try again, or see the worked example below.`;
                feedback.className = 'problem-feedback incorrect';
            }
        };
        
        window.toggleWorkedExample = function() {
            const toggle = document.querySelector('.worked-example-toggle');
            const content = document.getElementById('worked-example-content');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.add('open');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('open');
            }
        };
        
        // Initialize
        initialize();
    });
    </script>

    <!-- Week Navigation -->
    <div class="week-nav-bar">
        <a href="../richardson/" class="nav-prev">‚Üê Week 5: Richardson</a>
        <a href="../" class="nav-hub">üè† All Weeks</a>
        <a href="../ode/" class="nav-next">Week 7: ODE ‚Üí</a>
    </div>
    
</body>
</html>
